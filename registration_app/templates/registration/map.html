{% extends "registration/base.html" %}

{% block title %}Karte - Walking Bus Registrierung{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-map me-2"></i>
                    Interessenten-Karte
                </h3>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Übersicht:</strong> 
                            Hier sehen Sie alle registrierten Interessenten auf der Karte.
                            <span id="prospectCount" class="badge bg-primary ms-2">0</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('registration.index') }}" class="btn btn-success">
                                <i class="fas fa-user-plus me-2"></i>
                                Neue Registrierung
                            </a>
                        </div>
                    </div>
                </div>

                <div id="map" class="map-container"></div>

                <div class="mt-3">
                    <h5>Legende:</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <span class="badge bg-primary me-2">●</span> Registrierte Interessenten
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                Klicken Sie auf einen Marker für weitere Informationen
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prospect Details Modal -->
<div class="modal fade" id="prospectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>
                    Interessent Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="prospectDetails">
                <!-- Wird dynamisch gefüllt -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Karte initialisieren (zentriert auf Deutschland)
    const map = L.map('map').setView([51.1657, 10.4515], 6);
    
    // OpenStreetMap Tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    const prospectModal = new bootstrap.Modal(document.getElementById('prospectModal'));
    const prospectCount = document.getElementById('prospectCount');
    
    // Interessenten laden und auf Karte anzeigen
    async function loadProspects() {
        try {
            const response = await axios.get('/api/prospects');
            const prospects = response.data;
            
            prospectCount.textContent = prospects.length;
            
            if (prospects.length === 0) {
                const noDataAlert = document.createElement('div');
                noDataAlert.className = 'alert alert-warning mt-3';
                noDataAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Keine Daten:</strong> Es sind noch keine Interessenten registriert.
                `;
                document.querySelector('.card-body').appendChild(noDataAlert);
                return;
            }
            
            // Marker für jeden Interessenten
            const markers = [];
            prospects.forEach(prospect => {
                const marker = L.marker([prospect.latitude, prospect.longitude])
                    .bindPopup(`
                        <div class="text-center">
                            <strong>${prospect.name}</strong><br>
                            <small class="text-muted">${prospect.address}</small><br>
                            <button class="btn btn-sm btn-primary mt-2" onclick="showProspectDetails(${prospect.id})">
                                <i class="fas fa-info-circle me-1"></i>Details
                            </button>
                        </div>
                    `)
                    .addTo(map);
                
                markers.push(marker);
            });
            
            // Karte auf alle Marker ausrichten
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
                
                // Zoom-Level begrenzen
                if (map.getZoom() > 15) {
                    map.setZoom(15);
                }
            }
            
        } catch (error) {
            console.error('Fehler beim Laden der Interessenten:', error);
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger mt-3';
            errorAlert.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Fehler:</strong> Interessenten konnten nicht geladen werden.
            `;
            document.querySelector('.card-body').appendChild(errorAlert);
        }
    }
    
    // Interessent Details anzeigen
    window.showProspectDetails = async function(prospectId) {
        try {
            const response = await axios.get(`/api/prospects/${prospectId}`);
            const prospect = response.data;
            
            document.getElementById('prospectDetails').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user me-2"></i>Name:</h6>
                        <p>${prospect.name}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-phone me-2"></i>Telefon:</h6>
                        <p><a href="tel:${prospect.phone}">${prospect.phone}</a></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-envelope me-2"></i>E-Mail:</h6>
                        <p>${prospect.email ? `<a href="mailto:${prospect.email}">${prospect.email}</a>` : 'Keine E-Mail angegeben'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-calendar me-2"></i>Registriert:</h6>
                        <p>${new Date(prospect.created_at).toLocaleDateString('de-DE')}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-map-marker-alt me-2"></i>Adresse:</h6>
                        <p>${prospect.address}</p>
                    </div>
                </div>
                ${prospect.notes ? `
                    <div class="row">
                        <div class="col-12">
                            <h6><i class="fas fa-comment me-2"></i>Anmerkungen:</h6>
                            <p>${prospect.notes}</p>
                        </div>
                    </div>
                ` : ''}
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-info-circle me-2"></i>Status:</h6>
                        <span class="badge bg-${prospect.status === 'active' ? 'success' : 'secondary'}">${prospect.status}</span>
                    </div>
                </div>
            `;
            
            prospectModal.show();
            
        } catch (error) {
            console.error('Fehler beim Laden der Details:', error);
            alert('Details konnten nicht geladen werden.');
        }
    };
    
    // Interessenten laden
    loadProspects();
});
</script>
{% endblock %}
