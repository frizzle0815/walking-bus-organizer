{% extends "base.html" %}

{% block content %}
<div id="loading-overlay" class="loading-overlay">
    <div class="spinner-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Lade Daten...</span>
        </div>
        <div class="mt-3 text-primary">Lade Walking Bus...</div>
    </div>
</div>

<div class="container-fluid px-2 py-2 content-container">
    <div id="stations"></div>
</div>

<!-- Calendar Modal -->
<div id="calendarModal" class="modal">
    <div class="modal-content">
        <span class="close">Ã—</span>
        <div id="calendar"></div>
    </div>
</div>

<style>
        /* Prevent text selection for app like experience */
    *:not(input, textarea) {
        user-select: none; /* Prevent text selection */
        -webkit-user-select: none; /* For Safari */
        -moz-user-select: none; /* For Firefox */
        -ms-user-select: none; /* For IE10+/Edge */
    }

    /* General Styles */
    .content-container {
        max-width: 600px;
    }

    .station-card {
        background-color: #414141;
        border-radius: 8px;
        margin-bottom: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .station-card:first-child {
        margin-bottom: 12px; /* More space between summary and first station */
    }

    .station-card:first-child .station-header {
        border-radius: 8px; /* Round all corners */
    }


    .station-header {
        padding: 8px 12px;
        border-bottom: 1px solid #555;
        background-color: #414141;
        border-radius: 8px 8px 0 0;
        color: white;
    }

    .station-header h5 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        gap: 8px;  /* Consistent spacing */
    }

    /* Summary Card specific styles */
    .summary-header h5 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .summary-header h5 span:first-child {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        min-width: 0;
        margin-right: 8px;
    }

    /* Station Header specific styles - completely independent */
    .station-card:not(#summary-card) .station-header h5 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .station-card:not(#summary-card) .station-title {
        display: flex;
        align-items: center;
        flex: 1 1 auto; /* Allow growing and shrinking */
        min-width: 0;   /* Enable proper flex shrinking */
    }

    .station-card:not(#summary-card) .station-name {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Right side of station header */
    .station-card:not(#summary-card) .station-header .d-flex {
        flex: 0 0 auto; /* Prevent shrinking of the time/stats area */
        margin-left: 0px;
    }

    /* Base styles */
    .participants-list {
        perspective: 400px;
        background-color: var(--participants-bg);
        border-radius: 0 0 8px 8px;
        padding: 4px;
    }

    .participant-item {
        border: none !important;
        margin: 2px 0;
        border-radius: 4px !important;
        font-size: 0.9rem;
        transform-style: preserve-3d;
        perspective: 1000px;
    }

    .participant-name {
        font-weight: bold;
        display: flex;
        align-items: center;
        line-height: 1; /* Ensures text aligns with icon */
    }

    /* Status colors */
    .participant-status-active {
        background-color: #a9e6b7;
    }

    .participant-status-inactive {
        background-color: #f8bfc3;
    }

    .participant-status-disabled {
        background-color: #e9ecef;
    }

    /* Animation for transitioning from active to inactive */
    @keyframes fadeSlideActiveToInactive {
        0% {
            background-color: #a9e6b7; /* Active color */
            transform: translateX(0);
            opacity: 0.5;
        }
        100% {
            background-color: #f8bfc3; /* Inactive color */
            transform: translateX(10px);
            opacity: 1;
        }
    }

    /* Animation for transitioning from inactive to active */
    @keyframes fadeSlideInactiveToActive {
        0% {
            background-color: #f8bfc3; /* Inactive color */
            transform: translateX(0);
            opacity: 0.5;
        }
        100% {
            background-color: #a9e6b7; /* Active color */
            transform: translateX(10px);
            opacity: 1;
        }
    }

    .participant-item.active-to-inactive {
        animation: fadeSlideActiveToInactive 0.5s ease-in-out;
    }

    .participant-item.inactive-to-active {
        animation: fadeSlideInactiveToActive 0.5s ease-in-out;
    }

    /* Calendar Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .week {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .calendar-day {
        display: inline-flex;
        width: 40px;
        height: 40px;
        margin: 2px;
        justify-content: center;  /* Center horizontally */
        align-items: center;     /* Center vertically */
        gap: 2px;                /* Controls space between elements */
        padding: 4px 0;          /* Adds vertical padding */
        height: 100%; 
        border-radius: 50%;
        cursor: pointer;
    }

    .day-green { background-color: #a9e6b7; }
    .day-red { background-color: #f8bfc3 }
    .day-gray {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .calendar-btn {
        margin-left: 5px;
        padding: 0.2rem 0.5rem;
        font-size: 0.8rem;
        border-radius: 50%;
        border: 1px solid #ddd;
        background-color: white;  /* Changed from transparent */
        color: #666;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);  /* Adding subtle shadow */
    }

    .calendar-day-header {
        display: inline-block;
        width: 40px;
        height: 30px;
        margin: 2px;
        text-align: center;
        line-height: 30px;
        font-weight: bold;
        font-size: 0.9rem;
        color: #666;
    }

    .day-today {
        border: 2px solid #0d6efd;  /* Bootstrap primary blue */
    }


    /* Button Styles */
    .btn-outline-secondary {
        background-color: #e9ecef;
        border-color: #e9ecef;
        color: #6c757d;
    }

    .btn-outline-secondary:disabled {
        cursor: not-allowed;
    }

    .status-button {
        font-size: 0.8rem;
        padding: 0.2rem 0.8rem;
        background-color: white;  /* Adding white background */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);  /* Adding subtle shadow */
    }

    /* Override Bootstrap's background colors for outline buttons */
    .btn-outline-success, 
    .btn-outline-danger {
        background-color: white !important;
    }

    .btn-outline-success:hover,
    .btn-outline-danger:hover {
        color: inherit !important;  /* Maintain text/icon color */
        background-color: white !important;  /* Keep solid white background */
        border-color: currentColor !important;  /* Maintain border color */
        opacity: 0.8;
    }

    .btn-outline-success:hover i {
        color: #28a745 !important;  /* Bootstrap's success color */
    }

    .btn-outline-danger:hover i {
        color: #dc3545 !important;  /* Bootstrap's danger color */
    }

    .status-button i {
        color: inherit !important;
    }

    .status-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        pointer-events: none;
    }

    @keyframes warningPulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .fa-exclamation-triangle {
        animation: warningPulse 2s infinite;
    }


    .status-button-disabled {
        cursor: not-allowed;
    }

    /* Icon Styles */
    .icon-active {
        color: #28a745;
    }

    .icon-inactive {
        color: #dc3545;
    }

    .icon-disabled {
        color: #6c757d;  /* Bootstrap's secondary gray color */
    }

    /* Traffic Light Icons */
    .icon-container {
        position: relative;
        display: inline-block;
        width: 1em;    /* Width of one icon */
        height: 1em;   /* Height of one icon */
        margin-right: 0.5rem;
    }

    .traffic-light {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.2em; /* Slightly wider to accommodate icon */
        height: 1.2em; /* Match width for perfect square */
        margin-right: 0.5rem;
    }

    .traffic-light.next-icon {
        opacity: 0;  /* Initially hidden */
    }

    .status-changing .traffic-light.current-icon {
        animation: iconTransition 1s linear;
    }

    .status-changing .traffic-light.next-icon {
        animation: iconTransition 1s linear reverse;
    }

    /* Add this to your existing style section */
    @keyframes highlightChange {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); background-color: #fff3cd; }
        100% { transform: scale(1); }
    }

    .highlight-change {
        animation: highlightChange 1.5s ease-in-out;
    }

    .warning-icon {
        color: #dc3545; /* Bootstrap's danger color */
        background-color: #fff; /* White background for contrast */
        padding: 2px; /* Padding for better visibility */
        margin-right: 8px; /* Space between icon and button */
        border-radius: 50%; /* Optional: round the icon */
    }


    /* Compact view */
    .compact-view .participants-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
        padding: 4px;
    }

    .compact-view .participant-item {
        margin: 0;
        display: grid;
        grid-template-columns: 1fr auto; /* 1fr for name, auto for buttons */
        align-items: center;
        gap: 4px;
        width: 100%;
    }

    /* Adjust spacing for compact items */
    .compact-view .participant-name {
        font-size: calc(0.9rem * var(--base-scale));
        min-width: 0; /* Enables text truncation */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    
    .compact-view .button-container {
        display: flex;
        gap: 2px;
        flex-shrink: 0; /* Prevents buttons from shrinking */
    }

/* Ensure equal width columns in the grid */
    .compact-view .participants-list {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* minmax(0, 1fr) ensures equal columns */
        gap: 4px;
        padding: 4px;
    }

    .compact-view .status-button {
        padding: 0.1rem 0.6rem;
    }

    .compact-view .calendar-btn {
        padding: 0.1rem 0.3rem;
    }

    .compact-view .icon-container {
        margin-right: 0.1rem;  /* Reduced spacing for compact view */
    }

    /* Ensure icon size stays consistent */
    .compact-view .fa-walking,
    .compact-view .fa-person {
        font-size: calc(0.8rem * var(--base-scale)); /* Fixed size regardless of view */
    }

    /* Variable GrÃ¶ÃŸenkontrolle */
    :root {
        --base-scale: 1;
        --min-scale: 0.8;
        --max-scale: 1.4;
        --scale-step: 0.1;
    }

    .station-card {
        font-size: calc(1rem * var(--base-scale));
    }

    .station-title {
        display: flex;
        align-items: center;
        min-width: 0;  /* Allows flex item to shrink below content size */
        flex: 1;       /* Takes up remaining space */
    }

    .station-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;  /* Enables truncation */
    }

    .participant-item {
        padding: calc(0.5rem * var(--base-scale));
    }

    .status-button {
        font-size: calc(0.8rem * var(--base-scale));
        padding: calc(0.2rem * var(--base-scale)) calc(0.8rem * var(--base-scale));
    }

    .participant-name {
        font-size: calc(0.9rem * var(--base-scale));
    }


    .calendar-btn {
        font-size: calc(0.8rem * var(--base-scale));
    }

    .fa-calendar-alt, .fa-times, .fa-check {
        font-size: calc(0.8rem * var(--base-scale));
    }

    .summary-header {
        border-radius: 8px !important; /* Override the station-header border-radius */
        border-bottom: none; /* Remove the border that separates header from content */
    }

    /* Basic container layout */

    .week-container.participants-list {
        display: block !important;
    }

    .week-container .week {
        width: 100%;
        display: flex;
        justify-content: space-evenly;
        margin: 0;
        padding: 0;
    }

    .week-container .calendar-day {
        position: relative;
        font-size: 0.8em;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        cursor: pointer;
        border: 1px solid #dee2e6;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        color: #000; /* Ensure black text */
        width: 100%;
        height: 100%;
    }

    /* Square wrapper with elegant gradient border */
    .week-container .calendar-day-wrapper {
        position: relative;
        padding: 3px;
        border-radius: 8px;  /* Slightly rounder corners */
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease;
        width: 45px; /* Fixed width */
        height: 45px; /* Fixed height */
    }

    .week-container .day-label,
    .week-container .day-number {
        color: #000000;
        font-weight: bold;
        z-index: 1; /* Ensure text stays above backgrounds */
        line-height: 1;          /* Removes extra line spacing */
        margin: 0;  
    }

    /* Enhanced selected day styling */
    .week-container .calendar-day-wrapper.selected-day {
        background-color:#9eeaf9;
        z-index: 1;
        transform: scale(1.15);

    }

    .week-container .calendar-day-wrapper.selected-day .calendar-day {
        transform: scale(1.05);
    }

    /* Status indicators - improved visibility */
    .week-container .calendar-day .override-icon,
    .week-container .calendar-day .note-icon {
        position: absolute;
        top: -2px;
        font-size: 1.2em;
        z-index: 2;
        /* Create circular black background */
        background-color: black;
        border-radius: 50%;
        /* Ensure icon stays visible */
        display: flex;
        align-items: center;
        justify-content: center;
        /* Keep existing styles */
        filter: drop-shadow(0 0 1px rgba(0, 0, 0, 0.2));
        width: 0.5em;  /* Match icon width */
        height: 0.5em; /* Match icon height */
        line-height: 0.5; /* Ensure vertical centering */
    }

    .week-container .calendar-day .override-icon {
        right: -4px;
        color: #dc3545;
    }

    .week-container .calendar-day .note-icon {
        left: -4px;
        color: #ffc107;
    }

    #calendarModal .calendar-day {
        display: inline-flex;
        width: 40px;
        height: 40px;
        margin: 2px;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        cursor: pointer;
    }

    /* Status colors for calendar modal */
    #calendarModal .day-green { background-color: #a9e6b7; }
    #calendarModal .day-red { background-color: #f8bfc3; }
    #calendarModal .day-gray {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .z-index-top {
        z-index: 9999;  /* Alert message on failed loading */
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner-container {
        text-align: center;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    .weather-icon {
        width: 56px;
        height: 56px;
        position: absolute;
        transform: translateY(-50%);
        top: 50%;
        right: calc(100% + 2px); /* Positions icon to the left with 8px gap */
        z-index: 1;
    }

    .station-header h5 .d-flex {
        position: relative;
        margin-left: 50px; /* Creates space for the icon */
    }

    #weather-info {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        height: 24px;
        padding: 0 0.5rem;
    }


    #weather-pop::after {
        content: '%';
    }

    #weather-precip::after {
        content: 'mm';
    }

</style>

<script>
    let currentParticipantId = null;
    let lastUpdateTimestamp = 0;
    const UPDATE_THRESHOLD = 1000; // Minimum time (ms) between updates
    let globalEventSource = null;
    const animationQueue = new Map(); // Store queues for each participant
    let isStatusUpdateInProgress = false;
    let isPageVisible = !document.hidden;
    let isWalkingBusDay = false;
    let globalDailyStatus = null;
    const WEEKDAY_MAPPING = {
        0: 'monday',
        1: 'tuesday',
        2: 'wednesday',
        3: 'thursday',
        4: 'friday',
        5: 'saturday',
        6: 'sunday'
    };

const PARTICIPANT_STATES = {
    ACTIVE: 'active',
    INACTIVE: 'inactive',
    DISABLED: 'disabled'
};

const WALKING_BUS_STATES = {
    SCHEDULED: 'scheduled',
    HOLIDAY: 'holiday',
    OVERRIDE: 'override',
    TIME_PASSED: 'time_passed'
};

const REASON_TYPES = {
    ACTIVE: 'ACTIVE',
    HOLIDAY: 'HOLIDAY',
    WEEKEND: 'WEEKEND',
    TIME_PASSED: 'TIME_PASSED',
    MANUAL_OVERRIDE: 'MANUAL_OVERRIDE',
    INACTIVE_WEEKDAY: 'INACTIVE_WEEKDAY',
    NO_SCHEDULE: 'NO_SCHEDULE'
};


const isCurrentDay = (dateStr) => dateStr === new Date().toISOString().split('T')[0];

const checkTimePassed = (endTime) => {
    if (!endTime) return false;
    const [hours, minutes] = endTime.split(':').map(Number);
    const endDateTime = new Date();
    endDateTime.setHours(hours, minutes, 0);
    const currentTime = new Date();    
    return currentTime > endDateTime;
};



function createParticipantMap(stations) {
    const map = new Map();
    stations.forEach(station => {
        station.participants.forEach(participant => {
            console.log(`[MAP] Processing participant ${participant.id}:`, participant);
            map.set(participant.id, {
                id: participant.id,
                name: participant.name,
                stationId: station.id
            });
        });
    });
    return map;
}

function createReasonMap(stateReason, holidayData, isWalkingBusDay, scheduleData, reason) {
    const validatedWalkingBusDay = isWalkingBusDay ?? false;

    if (stateReason === REASON_TYPES.HOLIDAY && holidayData) {
        return `Heute findet kein Walking Bus statt.<br>${holidayData.name}`;
    }

    if (stateReason === REASON_TYPES.MANUAL_OVERRIDE) {
        return `Heute findet kein Walking Bus statt.<br>${reason}`;
    }

    console.log('[REASON] Creating reason map with:', {
        stateReason,
        isWalkingBusDay: validatedWalkingBusDay,
        timePassed: scheduleData ? checkTimePassed(scheduleData.end) : false
    });

    if (stateReason === REASON_TYPES.TIME_PASSED || 
        (validatedWalkingBusDay && scheduleData && checkTimePassed(scheduleData.end))) {
        return 'Der Walking Bus hat heute bereits stattgefunden.';
    }

    const reasonMap = {
        [REASON_TYPES.ACTIVE]: '',
        [REASON_TYPES.HOLIDAY]: 'Es sind Ferien.',
        [REASON_TYPES.WEEKEND]: 'Am Wochenende findet kein Walking Bus statt.',
        [REASON_TYPES.TIME_PASSED]: 'Der Walking Bus hat heute bereits stattgefunden.',
        [REASON_TYPES.MANUAL_OVERRIDE]: 'Manuell deaktiviert.',
        [REASON_TYPES.INACTIVE_WEEKDAY]: 'An diesem Tag findet kein Walking Bus statt.',
        [REASON_TYPES.NO_SCHEDULE]: 'Keine Planung angelegt.'
    };

    return reasonMap[stateReason] || 'Kein Walking Bus';
}


document.addEventListener('DOMContentLoaded', async () => {
    console.log('[INIT] Page loading started');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Add transition for smooth fade out
    loadingOverlay.style.transition = 'opacity 0.3s ease-out';
    
    try {
        // Initialize core functionality
        initializeSizeControls();
        console.log('[INIT] Size controls initialized');

        // Load main data
        await loadInitialData();
        console.log('[INIT] Initial load complete');

        // Initialize real-time updates
        initializeSSE();
        console.log('[INIT] SSE connection established');

        // Setup modal interactions
        setupModalHandling();
        console.log('[INIT] Modal handling setup complete');

        // Smoothly hide loading overlay
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 300); // Match transition duration

    } catch (error) {
        console.error('[INIT] Error during initialization:', error);
        // Show error in loading overlay
        loadingOverlay.innerHTML = `
            <div class="spinner-container text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <div>Fehler beim Laden der Daten</div>
                <button onclick="location.reload()" class="btn btn-outline-danger mt-3">
                    Neu laden
                </button>
            </div>
        `;
        SSE_updateConnectionStatus('disconnected');
    }
});


async function loadInitialData() {
    console.log('[INITIAL_LOAD] Starting initial data load');
    const stationsContainer = document.getElementById('stations');
    const tempContainer = document.createElement('div');
    tempContainer.style.display = 'none';
    document.body.appendChild(tempContainer);

    try {
        // Load all data in parallel
        const [initialResponse, weekResponse, weatherResponse] = await Promise.all([
            axios.get('/api/initial-load'),
            axios.get('/api/week-overview'),
            axios.get('/api/weather', {
                params: { 
                    date: new Date().toISOString().split('T')[0] 
                }
            })
        ]);
        
        const currentDate = new Date().toISOString().split('T')[0];
        const dailyStatusResponse = await axios.get('/api/daily-status', {
            params: { date: currentDate }
        });

        console.log('[LOAD] Daily status response:', dailyStatusResponse.data);
        console.log('[LOAD] isWalkingBusDay before enhancement:', dailyStatusResponse.data.isWalkingBusDay);

        // Use pre-calculated weather data directly
        const weatherData = weatherResponse.data?.status === 'success' && weatherResponse.data?.data ? {
            data: {
                icon: weatherResponse.data.data.icon,
                pop: weatherResponse.data.data.pop,
                precipitation: weatherResponse.data.data.precipitation
            }
        } : null;

        const enhancedDailyStatus = {
            ...dailyStatusResponse.data,
            weather: weatherData,
            reason: createReasonMap(
                dailyStatusResponse.data.stateReason,
                dailyStatusResponse.data.holidayData,
                dailyStatusResponse.data.isWalkingBusDay,
                dailyStatusResponse.data.schedule,
                dailyStatusResponse.data.reason
            ),
            reason_type: dailyStatusResponse.data.stateReason
        };

        console.log('[LOAD] Enhanced daily status:', enhancedDailyStatus);

        window.appState = {
            stations: initialResponse.data.stations,
            participants: createParticipantMap(initialResponse.data.stations),
            currentDate: dailyStatusResponse.data.currentDate,
            weekOverview: weekResponse.data
        };

        // Render everything into hidden container
        await renderFullView(
            window.appState.stations,
            enhancedDailyStatus,
            weekResponse.data,
            tempContainer,
        );

        // Single DOM update with complete content
        stationsContainer.replaceChildren(...tempContainer.children);

        // Set selected day
        const firstDayWrapper = stationsContainer.querySelector('.week .calendar-day-wrapper:first-child');
        if (firstDayWrapper) {
            firstDayWrapper.classList.add('selected-day');
        }

        return initialResponse.data;

    } catch (error) {
        console.error('[INITIAL_LOAD] Error:', error);
        throw error;
    } finally {
        tempContainer.remove();
    }
}



async function renderFullView(stations, dailyStatus, weekData, targetContainer = document.getElementById('stations')) {
    // Pre-calculate stats
    const totalParticipants = stations.reduce((sum, station) =>
        sum + station.participants.length, 0);
    const activeParticipants = stations.reduce((sum, station) =>
        sum + station.participants.filter(p =>
            dailyStatus.participantStates[p.id]).length, 0);

    // Create all elements
    const summaryCard = render_summaryCard(
        dailyStatus,
        `${activeParticipants} / ${totalParticipants}`
    );
    
    const weekOverview = render_WeekOverview(weekData, dailyStatus.currentDate);
    const weekContainer = summaryCard.querySelector('.week-container');
    
    // Add event delegation to week container
    weekContainer.addEventListener('click', (e) => {
        const wrapper = e.target.closest('.calendar-day-wrapper');
        if (wrapper && !isSelectionInProgress) {
            const dateStr = wrapper.querySelector('.calendar-day').dataset.date;
            selectDay(dateStr);
        }
    });

    const currentDay = isCurrentDay(dailyStatus.currentDate);
    const timePassed = checkTimePassed(dailyStatus.schedule?.end);
    const effectiveWalkingBusDay = dailyStatus.isWalkingBusDay && !(timePassed && currentDay);

    // Create alerts container with correct initial state
    const alertsContainer = render_alertsContainer(dailyStatus, effectiveWalkingBusDay);
    const stationCards = stations.map(station =>
        render_stationCard(station, dailyStatus)
    );

    // Build complete view
    weekContainer.appendChild(weekOverview);
    
    // Clear and update target container
    targetContainer.innerHTML = '';
    targetContainer.appendChild(summaryCard);
    targetContainer.appendChild(alertsContainer);
    stationCards.forEach(card => targetContainer.appendChild(card));

    // Update UI elements
    updateTimeIcons(dailyStatus);
    updateHeaderAndAlerts(dailyStatus);
    window.appState.stations.forEach(station => {
        updateStationStats(station.id, dailyStatus); 
    });
    updateTotalStats(dailyStatus);
}


// Berechnung des Status
function calculateParticipantStatusState(participantId, dailyStatus) {
    console.log('[STATUS][CALC] Processing participant:', participantId);
    console.log('[STATUS][CALC] Daily status:', dailyStatus);

    if (!dailyStatus || !dailyStatus.participantStates) {
        //console.log('[STATUS][CALC] Invalid dailyStatus object');
        return PARTICIPANT_STATES.DISABLED;
    }

    if (!dailyStatus.isWalkingBusDay) {
        //console.log('[STATUS][CALC] Not a walking bus day');
        return PARTICIPANT_STATES.DISABLED;
    }

    const participantState = dailyStatus.participantStates[participantId];
    const currentDay = isCurrentDay(dailyStatus.currentDate);
    const timePassed = checkTimePassed(dailyStatus.schedule?.end);
    const effectiveWalkingBusDay = dailyStatus.isWalkingBusDay && !(timePassed && currentDay);

    // Check if walking bus is effectively active
    if (!effectiveWalkingBusDay) {
        return PARTICIPANT_STATES.DISABLED;
    }

    const finalState = participantState ? PARTICIPANT_STATES.ACTIVE : PARTICIPANT_STATES.INACTIVE;
    console.log('[STATUS][CALC] Final state:', finalState);
    return finalState;
}



// UI Updates fÃ¼r einzelnen Participant
function updateParticipantStatusUI(participantElement, state) {
    //console.log('[STATUS][UI] Updating UI for participant:', participantElement.dataset.participantId);
    //console.log('[STATUS][UI] Applying state:', state);

    const icon = participantElement.querySelector('.traffic-light');
    const button = participantElement.querySelector('.status-button');
    
    participantElement.classList.remove(
        'participant-status-active',
        'participant-status-inactive',
        'participant-status-disabled'
    );
    
    switch(state) {
        case PARTICIPANT_STATES.ACTIVE:
            //console.log('[STATUS][UI] Setting ACTIVE state');
            participantElement.classList.add('participant-status-active');
            icon.className = 'fas fa-walking traffic-light icon-active';
            button.className = 'btn btn-sm rounded-pill status-button btn-outline-success';
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.disabled = false;
            break;
            
        case PARTICIPANT_STATES.INACTIVE:
            //console.log('[STATUS][UI] Setting INACTIVE state');
            participantElement.classList.add('participant-status-inactive');
            icon.className = 'fas fa-person traffic-light icon-inactive';
            button.className = 'btn btn-sm rounded-pill status-button btn-outline-danger';
            button.innerHTML = '<i class="fas fa-times"></i>';
            button.disabled = false;
            break;
            
        case PARTICIPANT_STATES.DISABLED:
            //console.log('[STATUS][UI] Setting DISABLED state');
            participantElement.classList.add('participant-status-disabled');
            icon.className = 'fas fa-person traffic-light icon-disabled';
            button.className = 'btn btn-sm rounded-pill status-button btn-outline-secondary';
            button.innerHTML = '<i class="fas fa-times"></i>';
            button.disabled = true;
            break;
    }
}

// Update aller Participant Status
function updateAllParticipantStates(dailyStatus) {
    window.appState.participants.forEach((participant, id) => {
        const element = document.querySelector(`[data-participant-id="${id}"]`);
        if (element) {
            const state = calculateParticipantStatusState(id, dailyStatus);
            updateParticipantStatusUI(element, state);
        }
    });
}



function setupModalHandling() {
    console.log('[MODAL] Setting up modal handlers');
    
    const modal = document.getElementById('calendarModal');
    const span = document.getElementsByClassName('close')[0];

    // Close modal when clicking X
    span.onclick = () => {
        console.log('[MODAL] Closing via X button');
        modal.style.display = 'none';
    };

    // Close modal when clicking outside
    window.onclick = (event) => {
        if (event.target === modal) {
            console.log('[MODAL] Closing via outside click');
            modal.style.display = 'none';
        }
    };

    console.log('[MODAL] Modal handlers initialized');
}


// Funktion zum AuswÃ¤hlen eines Tages
let isSelectionInProgress = false;

async function selectDay(dateStr) {
    if (isSelectionInProgress) return;
    
    console.log('[SELECT_DAY] Starting selection for date:', dateStr);
    isSelectionInProgress = true;

    const { allWrappers, loadingOverlay } = setupLoadingState(dateStr);
    const stationsContainer = document.getElementById('stations');
    const tempContainer = document.createElement('div');
    tempContainer.style.display = 'none';
    document.body.appendChild(tempContainer);
    
    try {
        const [dailyStatusResponse, weatherResponse] = await Promise.all([
            axios.get('/api/daily-status', { params: { date: dateStr } }),
            fetch(`/api/weather?date=${dateStr}`).then(r => r.json())
        ]);

        const dailyStatus = {
            ...dailyStatusResponse.data,
            currentDate: dateStr,
            weather: weatherResponse?.status === 'success' && weatherResponse?.data ? {
                data: {
                    icon: weatherResponse.data.icon,
                    pop: Number(weatherResponse.data.pop),
                    precipitation: Number(weatherResponse.data.precipitation)
                }
            } : null,
            reason: createReasonMap(
                dailyStatusResponse.data.stateReason,
                dailyStatusResponse.data.holidayData,
                dailyStatusResponse.data.isWalkingBusDay,
                dailyStatusResponse.data.schedule,
                dailyStatusResponse.data.reason
            ),
            reason_type: dailyStatusResponse.data.stateReason
        };

        await renderFullView(
            window.appState.stations,
            dailyStatus,
            window.appState.weekOverview,
            tempContainer
        );

        stationsContainer.replaceChildren(...tempContainer.children);

        // Update all station stats after view is rendered
        window.appState.stations.forEach(station => {
            updateStationStats(station.id);
        });
        
        // Update total stats
        updateTotalStats();

    } catch (error) {
        console.error('[SELECT_DAY] Error:', error);
        showErrorMessage('Fehler beim Laden der Daten');
    } finally {
        tempContainer.remove();
        loadingOverlay.remove();
        allWrappers.forEach(wrapper => {
            wrapper.style.pointerEvents = 'auto';
        });
        isSelectionInProgress = false;
    }
}



function setupLoadingState(dateStr) {
    // Disable day wrapper interactions
    const allWrappers = document.querySelectorAll('.calendar-day-wrapper');
    allWrappers.forEach(wrapper => {
        wrapper.style.pointerEvents = 'none';
        wrapper.classList.remove('selected-day');
    });

    // Create loading overlay
    const loadingOverlay = document.createElement('div');
    loadingOverlay.classList.add('loading-overlay');
    loadingOverlay.innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Lade Daten...</span>
        </div>
    `;
    document.body.appendChild(loadingOverlay);

    // Update selected day visual
    const selectedDay = document.querySelector(`[data-date="${dateStr}"]`);
    if (selectedDay) {
        selectedDay.closest('.calendar-day-wrapper').classList.add('selected-day');
    }

    return { allWrappers, loadingOverlay };
}


function updateHeaderAndAlerts(dailyStatus) {
    const summaryHeader = document.querySelector('.summary-header h5 span:first-child');
    if (summaryHeader) {
        summaryHeader.textContent = formatServerDate(new Date(dailyStatus.currentDate));
    }
    updateAlerts(dailyStatus.isWalkingBusDay, dailyStatus);
}

function cleanupLoadingState({ allWrappers, loadingOverlay }) {
    allWrappers.forEach(wrapper => {
        wrapper.style.pointerEvents = 'auto';
    });
    loadingOverlay.remove();
    isSelectionInProgress = false;
}


async function openCalendar(participantId) {
    console.log('[CALENDAR] Opening calendar for participant:', participantId);
    currentParticipantId = participantId;
    const modal = document.getElementById('calendarModal');

    // Get participant name from DOM
    const participantItem = document.querySelector(`[data-participant-id="${participantId}"]`);
    const participantName = participantItem.querySelector('.text-truncate').textContent.trim();

    // Show modal immediately with loading state
    modal.style.display = 'block';
    const modalContent = modal.querySelector('.modal-content');
    modalContent.innerHTML = `
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <span class="close" onclick="document.getElementById('calendarModal').style.display='none'">Ã—</span>
            <h4 class="mb-0 ms-3">${participantName}</h4>
        </div>
        <div id="calendar" class="position-relative">
            <div class="d-flex justify-content-center align-items-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Lade Kalender...</span>
                </div>
            </div>
        </div>
    `;

    try {
        // Fetch calendar data in background
        const response = await axios.get(`/api/calendar-data/${participantId}`);
        const calendarData = response.data;
        
        // Replace loading spinner with calendar content
        await renderCalendar(calendarData);
        
        console.log('[CALENDAR] Calendar loaded successfully');
    } catch (error) {
        console.error('[CALENDAR] Error loading calendar:', error);
        // Show error state in modal
        document.getElementById('calendar').innerHTML = `
            <div class="alert alert-danger m-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Fehler beim Laden der Kalenderdaten
            </div>
        `;
    }
}



function updateStationStats(stationId) {
    const stationElement = document.querySelector(`[data-station-id="${stationId}"]`);
    
    // Get all participants in this station
    const participants = stationElement.querySelectorAll('.participant-item');
    
    const totalParticipants = participants.length;
    const activeParticipants = Array.from(participants)
        .filter(p => p.classList.contains('participant-status-active')).length;

    // Update station stats
    const statsElement = document.getElementById(`stats-station-${stationId}`);
    if (statsElement) {
        statsElement.textContent = `${activeParticipants} / ${totalParticipants}`;
    } else {
        console.log('[STATS] Stats element not found for station:', stationId);
    }

    // Update total stats
    updateTotalStats();
}


function updateTotalStats() {
    const allParticipants = document.querySelectorAll('.participant-item');
    const totalParticipants = allParticipants.length;
    const activeParticipants = Array.from(allParticipants)
        .filter(p => p.classList.contains('participant-status-active')).length;

    const totalStats = document.getElementById('stats-total');
    if (totalStats) {
        totalStats.textContent = `${activeParticipants} / ${totalParticipants}`;
    }
}


async function TEST_toggleParticipation(participantId, button) {
    if (button.querySelector('.fa-spinner')) return;
    
    const selectedDate = document.querySelector('.week-container .selected-day')?.querySelector('.calendar-day')?.dataset.date;
    
    try {
        const response = await axios.patch(`/api/participation/${participantId}`, {
            date: selectedDate
        });

        if (response.data && response.status === 200) {
            // Get fresh daily status
            const dailyStatusResponse = await axios.get('/api/daily-status', {
                params: { date: selectedDate }
            });
            
            // Update UI with new status
            updateAllParticipantStates(dailyStatusResponse.data);
            
            // Trigger SSE update
            await axios.post('/api/trigger-update', { date: selectedDate });
            await render_WeekOverview(selectedDate);
        }
    } catch (error) {
        console.error('[TOGGLE] Error:', error);
        showErrorMessage('Ã„nderung konnte nicht gespeichert werden');
    }
}


async function toggleParticipation(participantId, button) {
    const participantItem = document.querySelector(`[data-participant-id="${participantId}"]`);
    const selectedDate = document.querySelector('.week-container .selected-day')?.querySelector('.calendar-day')?.dataset.date;
    const stationId = participantItem.closest('[data-station-id]').dataset.stationId;

    if (participantItem.dataset.updating === 'true') {
        return;
    }
    participantItem.dataset.updating = 'true';
    
    const wasActive = participantItem.classList.contains('participant-status-active');
    const newStatus = !wasActive;
    const originalButtonContent = wasActive ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
    const icon = participantItem.querySelector('.traffic-light');
    const originalIconClass = icon.className;
    
    try {
        // Immediately update visual state
        participantItem.classList.remove('participant-status-active', 'participant-status-inactive');
        participantItem.classList.add(newStatus ? 'participant-status-active' : 'participant-status-inactive');
        
        // Start animation
        await animateStatusChange(participantItem, newStatus);
        
        // Update button appearance
        button.className = `btn btn-sm rounded-pill status-button ${newStatus ? 'btn-outline-success' : 'btn-outline-danger'}`;
        button.innerHTML = '<i class="fas fa-spinner fa-spin fa-sm"></i>';
        
        const response = await axios.patch(`/api/participation/${participantId}`, {
            date: selectedDate
        }, {
            timeout: 4000
        });

        if (response.data && response.status === 200) {
            // Update button content after success
            button.innerHTML = newStatus ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
            
            const dailyStatusResponse = await axios.get('/api/daily-status', {
                params: { date: selectedDate }
            });
            
            updateStationStats(stationId);
            updateTotalStats();
            
            await axios.post('/api/trigger-update', {
               type: 'PARTICIPANT_STATUS',
                date: selectedDate
            });
        }
    } catch (error) {
        console.error('[TOGGLE] Error:', error);
        
        // Restore original button content
        button.innerHTML = originalButtonContent;
        button.className = `btn btn-sm rounded-pill status-button ${wasActive ? 'btn-outline-success' : 'btn-outline-danger'}`;
        
        // Revert visual state
        icon.className = originalIconClass;
        participantItem.classList.remove('participant-status-active', 'participant-status-inactive');
        participantItem.classList.add(wasActive ? 'participant-status-active' : 'participant-status-inactive');
        
        // Show error indicators
        const warningIcon = document.createElement('i');
        warningIcon.classList.add('fas', 'fa-exclamation-triangle', 'warning-icon');
        warningIcon.title = 'Ã„nderung fehlgeschlagen. Bitte erneut versuchen.';
        button.parentElement.insertBefore(warningIcon, button.parentElement.firstChild);

        showErrorMessage('Ã„nderung konnte nicht gespeichert werden');
        setTimeout(() => warningIcon.remove(), 5000);
    } finally {
        participantItem.dataset.updating = 'false';
    }
}




async function ALT_toggleParticipation(participantId, button) {
    if (button.querySelector('.fa-spinner')) return;
    
    console.log('[TOGGLE] Starting toggle for participant:', participantId);

    const participantItem = document.querySelector(`[data-participant-id="${participantId}"]`);
    const selectedDate = document.querySelector('.week-container .selected-day')?.querySelector('.calendar-day')?.dataset.date;
    
    // Store current state for potential rollback
    const currentState = {
        status: participantItem.classList.contains('participant-status-active'),
        buttonContent: button.innerHTML,
        buttonClasses: [...button.classList]
    };

    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    const originalButtonContent = wasActive ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';

    try {
        const response = await axios.patch(`/api/participation/${participantId}`, {
            date: selectedDate
        }, {
            timeout: 4000
        });

        if (response.data && response.status === 200) {
            // Get updated daily status
            const dailyStatusResponse = await axios.get('/api/daily-status', {
                params: { date: selectedDate }
            });
            
            // Update UI using our new status functions
            updateAllParticipantStates(dailyStatusResponse.data);
            
            // Trigger SSE update for other clients
            await axios.post('/api/trigger-update', { date: selectedDate });
            
            // Update week overview
            await render_WeekOverview(selectedDate);
        }
    } catch (error) {
        console.error('[TOGGLE] Error:', error);
        
        // Restore original button content
        button.innerHTML = originalButtonContent;
        button.className = `btn btn-sm rounded-pill status-button ${wasActive ? 'btn-outline-success' : 'btn-outline-danger'}`;
        
        // Revert visual state
        participantItem.classList.remove('participant-status-active', 'participant-status-inactive');
        participantItem.classList.add(wasActive ? 'participant-status-active' : 'participant-status-inactive');
        
        // Show error indicators
        const warningIcon = document.createElement('i');
        warningIcon.classList.add('fas', 'fa-exclamation-triangle', 'warning-icon');
        warningIcon.title = 'Ã„nderung fehlgeschlagen. Bitte erneut versuchen.';
        button.parentElement.insertBefore(warningIcon, button.parentElement.firstChild);

        showErrorMessage('Ã„nderung konnte nicht gespeichert werden');
        setTimeout(() => warningIcon.remove(), 5000);
    }
}


async function animateStatusChange(element, newStatus) {
    return new Promise(resolve => {
        const animationClass = newStatus ? 'inactive-to-active' : 'active-to-inactive';
        const icon = element.querySelector('.traffic-light');
        
        // Update icon immediately with animation
        icon.className = `fas traffic-light ${
            newStatus ? 'fa-walking icon-active' : 'fa-person icon-inactive'
        }`;

        element.addEventListener('animationend', () => {
            element.classList.remove(animationClass);
            resolve();
        }, {once: true});
        
        element.classList.add(animationClass);
    });
}


async function ALT_renderStations(stations, isWalkingBusDay, dailyStatus) {
    console.log('[RENDER] Starting with daily status:', dailyStatus);
    const stationsContainer = document.getElementById('stations');
    stationsContainer.innerHTML = '';

    // 1. Initial Rendering
    const summaryCard = render_summaryCard(dailyStatus);
    stationsContainer.appendChild(summaryCard);

    const alertsContainer = render_alertsContainer(dailyStatus);
    stationsContainer.appendChild(alertsContainer);

    stations.forEach(station => {
        const stationCard = render_stationCard(station, dailyStatus);
        stationsContainer.appendChild(stationCard);
    });

    // 2. Post-Render Updates
    // Update all participant states based on current daily status
    updateAllParticipantStates(dailyStatus);
    
    // Update time indicators for each station
    updateTimeIcons(dailyStatus);
    
    // Update header information and alert messages
    updateHeaderAndAlerts(dailyStatus);
    
    // 3. Initial Week Overview
    await render_WeekOverview(dailyStatus.currentDate);
    
    // 4. Update Statistics
    stations.forEach(station => {
        updateStationStats(station.id);
    });
    updateTotalStats();

    console.log('[RENDER] Complete station render and updates finished');
}


function render_summaryCard(dailyStatus, statsTotal) {
    const card = document.createElement('div');
    card.classList.add('station-card');
    card.id = 'summary-card';

    const header = document.createElement('div');
    header.classList.add('station-header', 'summary-header');
    
    // Update validation to match the WeatherCalculation model structure
    const hasValidWeather = dailyStatus.weather?.data?.icon && 
                           dailyStatus.weather.data.pop !== undefined && 
                           dailyStatus.weather.data.precipitation !== undefined;

    header.innerHTML = `
        <h5 class="d-flex justify-content-between align-items-center mb-0">
            <span>${formatServerDate(new Date(dailyStatus.currentDate))}</span>
            <div class="d-flex align-items-center gap-2">
                ${hasValidWeather ? `
                    <img src="/static/icons/weather/${dailyStatus.weather.data.icon}.svg"
                         alt="Weather icon"
                         class="weather-icon">
                    <span class="badge bg-light text-dark" id="weather-info">
                        <span>${Math.round(dailyStatus.weather.data.pop * 100)}%</span>
                        <span>${Number(dailyStatus.weather.data.precipitation).toFixed(2)}mm</span>
                    </span>
                ` : `
                    <span class="badge bg-secondary text-light" id="weather-info">
                        Keine Wetter-Daten
                    </span>
                `}
                <span class="badge bg-light text-dark" id="stats-total">${statsTotal}</span>
            </div>
        </h5>
    `;

    const weekContainer = document.createElement('div');
    weekContainer.classList.add('week-container', 'list-group', 'list-group-flush', 'participants-list');

    card.appendChild(header);
    card.appendChild(weekContainer);
    
    return card;
}



function render_alertsContainer(dailyStatus, shouldBeHidden = true) {
    const hasNote = dailyStatus.note && dailyStatus.note.trim() !== '';
    const container = document.createElement('div');
    container.id = 'alerts-container';
    container.innerHTML = `
        <div id="connection-alert" class="alert alert-danger d-none" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Die Verbindung zum Server wurde unterbrochen.
        </div>
        <div id="walkingbus-alert" class="alert alert-info ${shouldBeHidden ? 'd-none' : ''}" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <span id="walkingbus-reason">${dailyStatus.reason}</span>
            </div>
        </div>
        <div id="note-alert" class="alert alert-warning ${!hasNote ? 'd-none' : ''}" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-sticky-note me-2"></i>
                <span id="walkingbus-note">${hasNote ? dailyStatus.note : ''}</span>
            </div>
        </div>
    `;
    return container;
}


function render_stationCard(station, dailyStatus) {
    const isTimePassedForToday = isCurrentDay(dailyStatus.currentDate) &&
                                dailyStatus.schedule?.end &&
                                checkTimePassed(dailyStatus.schedule.end);
                                
    const effectiveWalkingBusDay = dailyStatus.isWalkingBusDay && !isTimePassedForToday;
    
    const card = document.createElement('div');
    card.classList.add('station-card');
    card.dataset.stationId = station.id;

    // Station Header
    const header = render_stationHeader(station, dailyStatus);
    card.appendChild(header);

    // Participants List
    const participantsList = document.createElement('ul');
    participantsList.classList.add('list-group', 'list-group-flush', 'participants-list');
    participantsList.dataset.stationId = station.id;

    station.participants.forEach(participant => {
        const participantElement = render_participantItem(participant, dailyStatus, isTimePassedForToday);
        participantsList.appendChild(participantElement);
    });

    card.appendChild(participantsList);
    return card;
}



function render_stationHeader(station, dailyStatus) {
    const header = document.createElement('div');
    header.classList.add('station-header');
    
    // Calculate stats before rendering
    const participants = station.participants;
    const totalParticipants = participants.length;
    const activeParticipants = participants.filter(p => dailyStatus.participantStates[p.id]).length;
    
    header.innerHTML = `
        <h5 class="mb-0">
            <div class="station-title">
                <i class="fas fa-bus-simple me-2"></i>
                <span class="station-name">${station.name}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                ${station.arrival_time ? 
                    `<span class="badge bg-light text-dark time-badge" data-station-id="${station.id}">
                        <i class="fas fa-clock"></i>
                        <span class="ms-1">${station.arrival_time}</span>
                    </span>`
                    : ''}
                <span class="badge bg-light text-dark" id="stats-station-${station.id}">
                    ${activeParticipants} / ${totalParticipants}
                </span>
            </div>
        </h5>
    `;
    return header;
}


function render_participantItem(participant, dailyStatus) {
    const item = document.createElement('li');
    item.classList.add(
        'list-group-item',
        'py-1',
        'd-flex',
        'justify-content-between',
        'align-items-center',
        'participant-item'
    );
    item.dataset.participantId = participant.id;

    // Name with icon
    const nameSpan = document.createElement('span');
    nameSpan.classList.add('text-truncate', 'me-2', 'participant-name');
    
    const icon = document.createElement('i');
    icon.classList.add('fas', 'traffic-light');
    nameSpan.appendChild(icon);
    nameSpan.appendChild(document.createTextNode(participant.name));

    // Buttons container
    const buttonContainer = document.createElement('div');
    buttonContainer.classList.add('d-flex', 'align-items-center');

    // Status button
    const statusButton = document.createElement('button');
    statusButton.classList.add('btn', 'btn-sm', 'rounded-pill', 'status-button');
    statusButton.onclick = (e) => {
        e.preventDefault();
        toggleParticipation(participant.id, statusButton);
    };

    // Calendar button
    const calendarButton = document.createElement('button');
    calendarButton.classList.add('calendar-btn');
    calendarButton.innerHTML = '<i class="fas fa-calendar-alt"></i>';
    calendarButton.onclick = (e) => {
        e.stopPropagation();
        openCalendar(participant.id);
    };

    buttonContainer.appendChild(statusButton);
    buttonContainer.appendChild(calendarButton);

    item.appendChild(nameSpan);
    item.appendChild(buttonContainer);

    // Apply initial status
    const state = calculateParticipantStatusState(participant.id, dailyStatus);
    updateParticipantStatusUI(item, state);

    return item;
}


function render_WeekOverview(weekData, selectedDate) {
    // Create main week element
    const weekElement = document.createElement('div');
    weekElement.className = 'week d-flex justify-content-between';
    
    // Ensure valid selectedDate
    const currentSelectedDate = selectedDate || new Date().toISOString().split('T')[0];

    // Render each day
    weekData.forEach(dayData => {
        const dayElement = render_WeekDay(dayData, currentSelectedDate);
        weekElement.appendChild(dayElement);
    });

    // Add click handling
    weekElement.addEventListener('click', render_handleDayClick);
    
    // Return the DOM node instead of handling insertion
    return weekElement;
}

function render_WeekContainer() {
    const weekElement = document.createElement('div');
    weekElement.className = 'week d-flex justify-content-between';
    return weekElement;
}

function render_WeekDay(dayData, selectedDate) {
    const wrapper = document.createElement('div');
    wrapper.className = `calendar-day-wrapper ${dayData.date === selectedDate ? 'selected-day' : ''}`;

    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    dayElement.dataset.date = dayData.date;
    
    // Apply status classes
    render_applyDayStatus(dayElement, dayData);
    
    // Add indicators if needed
    render_addDayIndicators(dayElement, dayData);
    
    // Add day label
    const labelDiv = document.createElement('div');
    labelDiv.className = 'day-label';
    labelDiv.textContent = render_getDayLabel(dayData.date);
    dayElement.appendChild(labelDiv);

    wrapper.appendChild(dayElement);
    return wrapper;
}

function render_applyDayStatus(dayElement, dayData) {
    const baseClasses = ['calendar-day'];
    
    // Map state to visual class
    const stateClassMap = {
        [WALKING_BUS_STATES.SCHEDULED]: 'day-green',
        [WALKING_BUS_STATES.HOLIDAY]: 'day-gray',
        [WALKING_BUS_STATES.OVERRIDE]: 'day-red',
        [WALKING_BUS_STATES.TIME_PASSED]: 'day-gray'
    };
    
    // Determine current state
    let currentState;
    if (dayData.is_today && dayData.reason_type === 'TIME_PASSED') {
        currentState = WALKING_BUS_STATES.TIME_PASSED;
    } else if (dayData.reason_type === 'HOLIDAY') {
        currentState = WALKING_BUS_STATES.HOLIDAY;
    } else if (dayData.reason_type === 'MANUAL_OVERRIDE') {
        currentState = WALKING_BUS_STATES.OVERRIDE;
    } else if (dayData.is_active) {
        currentState = WALKING_BUS_STATES.SCHEDULED;
    } else {
        currentState = WALKING_BUS_STATES.HOLIDAY; // Default to holiday style for inactive days
    }
    
    // Apply state class
    baseClasses.push(stateClassMap[currentState]);
    
    // Add today marker if applicable
    if (dayData.is_today) {
        baseClasses.push('day-today');
    }
    
    dayElement.className = baseClasses.join(' ');
}

function render_addDayIndicators(dayElement, dayData) {
    if (dayData.has_override || dayData.reason_type === 'HOLIDAY') {
        const overrideIcon = document.createElement('i');
        overrideIcon.className = 'fa-solid fa-triangle-exclamation override-icon';
        dayElement.appendChild(overrideIcon);
    }
    
    if (dayData.has_note) {
        const noteIcon = document.createElement('i');
        noteIcon.className = 'fa-solid fa-circle-info note-icon';
        dayElement.appendChild(noteIcon);
    }
}

function render_getDayLabel(dateStr) {
    const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
    const date = new Date(dateStr);
    return days[date.getDay()];
}

function render_handleDayClick(event) {
    if (isSelectionInProgress) return;
    
    const wrapper = event.target.closest('.calendar-day-wrapper');
    if (!wrapper) return;
    
    const dateStr = wrapper.querySelector('.calendar-day').dataset.date;
    selectDay(dateStr);
}



    async function ALT_renderStations(stations, isWalkingBusDay, dailyStatus) {
    console.log('[RENDER] Starting with daily status:', dailyStatus);
    const stationsContainer = document.getElementById('stations');
    stationsContainer.innerHTML = '';

    // Create and append station cards
    stations.forEach(station => {
        const stationCard = document.createElement('div');
        stationCard.classList.add('station-card');
        stationCard.dataset.stationId = station.id;

        // Create participants list
        const participantsList = document.createElement('ul');
        participantsList.classList.add('list-group', 'list-group-flush', 'participants-list');

        station.participants.forEach(participant => {
            // Use participantStates for status
            const status = dailyStatus.participantStates[participant.id];
            console.log(`[RENDER] Participant ${participant.id} status:`, status);
            
            const participantElement = createParticipantElement(
                participant, 
                status, 
                dailyStatus
            );
            participantsList.appendChild(participantElement);
        });

        stationCard.appendChild(participantsList);
        stationsContainer.appendChild(stationCard);
    });
}

// 2. Update createParticipantElement function
function ALT_createParticipantElement(participant, status, dailyStatus) {
    const element = document.createElement('li');
    element.dataset.participantId = participant.id;
    
    const state = calculateParticipantStatusState(participant.id, dailyStatus);
    updateParticipantStatusUI(element, state);
    
    return element;
}


function formatServerDate(date) {
    const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
    const dayName = days[date.getDay()];
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    
    return `${day}.${month}.`;
}


function createStationHeader(station, isWalkingBusDay) {
            return `
            <div class="station-header">
                <h5 class="d-flex justify-content-between align-items-center mb-0">
                    <span class="station-title">
                        <i class="fas fa-bus-simple me-2"></i>
                        ${station.name}
                    </span>
                    <div class="d-flex align-items-center gap-2">
                        ${station.arrival_time ? 
                            `<span class="badge bg-light text-dark time-badge" data-station-id="${station.id}">
                                <i class="fas fa-clock"></i>
                                <span class="ms-1">${station.arrival_time}</span>
                            </span>`
                            : ''}
                        <span class="badge bg-light text-dark" id="stats-station-${station.id}">
                            ${getStationStats(station)}
                        </span>
                    </div>
                </h5>
            </div>`;
    }

function getStationStats(station) {
    const totalParticipants = station.participants.length;
    const confirmedParticipants = isWalkingBusDay ? 
        station.participants.filter(p => p.today_status).length : 0;
    return `${confirmedParticipants} / ${totalParticipants}`;
}

async function createParticipantItem(participant, isWalkingBusDay) {
    const item = document.createElement('li');
    item.classList.add(
        'list-group-item',
        'py-1',
        'd-flex',
        'justify-content-between',
        'align-items-center',
        'participant-item'
    );
    
    if (isWalkingBusDay) {
        item.classList.add(participant.status ? 'participant-status-active' : 'participant-status-inactive');
    } else {
        item.classList.add('participant-status-disabled');
    }
    
    item.dataset.participantId = participant.id;
    return item;
}


function createNameSpan(participant, isWalkingBusDay) {
    const nameSpan = document.createElement('span');
    nameSpan.classList.add('text-truncate', 'me-2', 'participant-name');

    const iconContainer = document.createElement('span');
    iconContainer.classList.add('icon-container');

    const currentIcon = document.createElement('i');
    currentIcon.classList.add('fas', 'traffic-light', 'current-icon');

    const nextIcon = document.createElement('i');
    nextIcon.classList.add('fas', 'traffic-light', 'next-icon');

    if (!isWalkingBusDay) {
        currentIcon.classList.add('fa-person', 'icon-disabled');
        nextIcon.classList.add('fa-person', 'icon-disabled');
    } else {
        currentIcon.classList.add(
            participant.status ? 'fa-walking' : 'fa-person',
            participant.status ? 'icon-active' : 'icon-inactive'
        );
        nextIcon.classList.add(
            participant.status ? 'fa-person' : 'fa-walking',
            participant.status ? 'icon-inactive' : 'icon-active'
        );
    }

    iconContainer.appendChild(currentIcon);
    iconContainer.appendChild(nextIcon);
    nameSpan.appendChild(iconContainer);
    nameSpan.appendChild(document.createTextNode(participant.name));
    return nameSpan;
}

function createStatusButton(participant, isWalkingBusDay) {
    const button = document.createElement('button');
    button.classList.add(
        'btn', 
        'btn-sm', 
        'rounded-pill', 
        'status-button',
        'touch-target'
    );

    button.onclick = (e) => {
        e.preventDefault();
        toggleParticipation(participant.id, button);
    };

    if (!isWalkingBusDay) {
        button.classList.add('btn-outline-secondary', 'status-button-disabled');
        button.innerHTML = '<i class="fas fa-times"></i>';
        button.disabled = true;
    } else {
        // Use the status field from our API response
        button.classList.add(participant.status ? 'btn-outline-success' : 'btn-outline-danger');
        button.innerHTML = participant.status ? 
            '<i class="fas fa-check"></i>' : 
            '<i class="fas fa-times"></i>';
    }

    return button;
}


function updateTimeIcons(dailyStatus) {
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    
    // Force comparison with actual today's date, regardless of selection
    const isToday = isCurrentDay(dailyStatus.currentDate);

    document.querySelectorAll('.time-badge').forEach(badge => {
        const timeText = badge.querySelector('span').textContent;
        const [hours, minutes] = timeText.split(':');
        const arrivalTime = parseInt(hours) * 60 + parseInt(minutes);
        const icon = badge.querySelector('i');

        // Only show walking animation if it's actually today
        if (isToday && dailyStatus.schedule?.end) {
            const [endHours, endMinutes] = dailyStatus.schedule.end.split(':');
            const scheduleEnd = parseInt(endHours) * 60 + parseInt(endMinutes);

            if (currentTime >= arrivalTime && currentTime < scheduleEnd) {
                icon.className = 'fas fa-person-walking fa-beat-fade';
            } else {
                icon.className = 'fas fa-clock';
            }
        } else {
            icon.className = 'fas fa-clock';
        }
    });
}



async function renderCalendar(calendarData) {
    console.log('[CALENDAR] Starting calendar render');
    
    // Parallel API calls for better performance
    const [selectedDateStatus, todayStatus] = await Promise.all([
        axios.post('/api/initialize-daily-status', {
            date: document.querySelector('.selected-day')?.dataset.date || new Date().toISOString().split('T')[0]
        }),
        axios.post('/api/initialize-daily-status', {
            date: new Date().toISOString().split('T')[0]
        })
    ]);

    if (!calendarData?.length) {
        console.error('[CALENDAR] No calendar data available');
        return;
    }

    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';

    // Pre-calculate frequently used values
    const today = new Date().toISOString().split('T')[0];
    const currentTime = new Date();
    currentTime.setHours(0, 0, 0, 0);

    // Build calendar structure
    calendar_renderHeader(calendar);
    
    const calendarBounds = calendar_calculateBounds(calendarData[0].date);
    
    calendar_renderContent(calendar, calendarBounds, {
        calendarData,
        todayStatus: todayStatus.data,
        currentTime,
        today,
        currentParticipantId
    });
}

function calendar_renderHeader(calendar) {
    const weekdayHeader = document.createElement('div');
    weekdayHeader.className = 'week';
    
    ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        weekdayHeader.appendChild(dayHeader);
    });
    
    calendar.appendChild(weekdayHeader);
}

function calendar_calculateBounds(firstDate) {
    const startOfWeek = new Date(firstDate);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
    return startOfWeek;
}

function calendar_renderContent(calendar, startOfWeek, config) {
    const { calendarData, todayStatus, currentTime, today, currentParticipantId } = config;

    for (let weekIndex = 0; weekIndex < 4; weekIndex++) {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'week';
        
        calendar_renderWeek(weekDiv, weekIndex, startOfWeek, config);
        calendar.appendChild(weekDiv);
    }
}

function calendar_renderWeek(weekDiv, weekIndex, startOfWeek, config) {
    const { calendarData, todayStatus, currentTime, today, currentParticipantId } = config;

    for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
        const currentDate = new Date(startOfWeek);
        currentDate.setDate(startOfWeek.getDate() + (weekIndex * 7) + dayIndex);
        const dateStr = currentDate.toISOString().split('T')[0];

        const dayDiv = calendar_createDayElement(
            dateStr,
            currentDate,
            calendarData,
            todayStatus,
            currentParticipantId
        );

        weekDiv.appendChild(dayDiv);
    }
}

function calendar_createDayElement(dateStr, currentDate, calendarData, todayStatus, currentParticipantId) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';
    dayDiv.textContent = currentDate.getDate();

    const dayData = calendarData.find(d => d.date === dateStr) || {
        date: dateStr,
        status: false,
        is_schedule_day: currentDate.getDay() !== 0 && currentDate.getDay() !== 6,
        is_past: currentDate < new Date(new Date().setHours(0,0,0,0)),
        is_today: dateStr === todayStatus.currentDate
    };

    calendar_applyDayStyles(dayDiv, dayData, dateStr, todayStatus, currentParticipantId);
    return dayDiv;
}

function calendar_applyDayStyles(dayDiv, dayData, dateStr, todayStatus, currentParticipantId) {
    const isToday = dateStr === todayStatus.currentDate;
    const shouldDisableDay = !dayData.is_schedule_day || 
                           dayData.is_past || 
                           (isToday && todayStatus.reason_type === "TIME_PASSED");

    if (shouldDisableDay) {
        dayDiv.classList.add('day-gray');
    } else {
        dayDiv.classList.add(dayData.status ? 'day-green' : 'day-red');
        dayDiv.onclick = () => toggleParticipationCalendar(currentParticipantId, dateStr, dayDiv);
    }

    if (dayData.is_today) {
        dayDiv.classList.add('day-today');
    }
}


async function toggleParticipationCalendar(participantId, dateString, dayDiv, selectedDate) {
    console.log('[CALENDAR_TOGGLE] Starting toggle for date:', dateString);
    
    if (dayDiv.querySelector('.fa-spinner')) return;

    const wasGreen = dayDiv.classList.contains('day-green');
    const originalContent = dayDiv.textContent;
    const currentlyDisplayedDate = document.querySelector('.week-container .selected-day')?.querySelector('.calendar-day')?.dataset.date;

    calendar_updateDayVisualState(dayDiv, !wasGreen, true);

    try {
        // Get daily status for the currently displayed date
        const [statusResponse, calendarResponse] = await Promise.all([
            axios.post('/api/initialize-daily-status', {
                date: currentlyDisplayedDate
            }),
            axios.post('/api/calendar-status', {
                participant_id: participantId,
                date: dateString,
                status: !wasGreen
            }, {
                timeout: 4000
            })
        ]);

        if (calendarResponse.data && calendarResponse.status === 200) {
            dayDiv.textContent = originalContent;

            // Update participant state in our central map
            const participantData = window.appState.participants.get(participantId);
            if (participantData) {
                participantData.state = !wasGreen ? 
                    PARTICIPANT_STATES.ACTIVE : 
                    PARTICIPANT_STATES.INACTIVE;
            }

            // Trigger update for all clients
            await axios.post('/api/trigger-update', {
               type: 'PARTICIPANT_STATUS',
                date: dateString
            });
            
            // Update main view if needed
            if (dateString === currentlyDisplayedDate) {
                const dailyStatus = {
                    ...statusResponse.data,
                    participantStates: {
                        ...statusResponse.data.participantStates,
                        [participantId]: !wasGreen
                    }
                };

                // Update all participant states based on new status
                // updateAllParticipantStates(dailyStatus);
                
                // Update statistics
                const stationId = window.appState.participants.get(participantId).stationId;
                updateStationStats(stationId);
                updateTotalStats();
            }
            
            // Update week overview with current date
            // await render_WeekOverview(currentlyDisplayedDate);
        }

    } catch (error) {
        console.error('[CALENDAR_TOGGLE] Error:', error);
        calendar_handleToggleError(dayDiv, wasGreen, originalContent);
    }
}



function calendar_updateDayVisualState(dayDiv, isActive, isLoading = false) {
    dayDiv.classList.remove('day-green', 'day-red', 'gray');
    dayDiv.classList.add(isActive ? 'day-green' : 'day-red');
    
    if (isLoading) {
        dayDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
}

function calendar_handleToggleError(dayDiv, wasGreen, originalContent) {
    calendar_updateDayVisualState(dayDiv, wasGreen);
    dayDiv.innerHTML = '<i class="fas fa-exclamation-triangle warning-icon"></i>';

    const errorAlert = document.createElement('div');
    errorAlert.classList.add(
        'alert', 'alert-danger', 'position-fixed',
        'bottom-0', 'start-50', 'translate-middle-x',
        'm-3', 'z-index-top'
    );
    errorAlert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        Ã„nderung konnte nicht gespeichert werden
    `;
    document.body.appendChild(errorAlert);

    setTimeout(() => {
        dayDiv.textContent = originalContent;
        errorAlert.remove();
    }, 5000);
}


async function ALT_renderWeekOverview(selectedDate = null) {
        const response = await axios.get('/api/week-overview');
        const weekData = response.data;
        
        const weekOverview = document.createElement('div');
        weekOverview.className = 'week d-flex justify-content-between';
            
        // Ensure we have a valid selectedDate
        if (!selectedDate) {
            selectedDate = document.querySelector('.selected-day .calendar-day')?.dataset.date 
                || new Date().toISOString().split('T')[0];
        }
        
        weekOverview.innerHTML = weekData.map(day => `
            <div class="calendar-day-wrapper ${day.date === selectedDate ? 'selected-day' : ''}">
                <div class="calendar-day ${getWeekDayClass(day)}"
                     data-date="${day.date}">
                    ${(day.has_override || day.reason_type === 'HOLIDAY') ? 
                        '<i class="fa-solid fa-triangle-exclamation override-icon"></i>' : ''}
                    ${day.has_note ? '<i class="fa-solid fa-circle-info note-icon"></i>' : ''}
                    <div class="day-label">${getDayLabel(day.date)}</div>
                </div>
            </div>
        `).join('');

        
        // Add click handler to the wrapper instead of the day
        weekOverview.addEventListener('click', (e) => {
            const wrapperElement = e.target.closest('.calendar-day-wrapper');
            if (wrapperElement && !isSelectionInProgress) {
                const dateStr = wrapperElement.querySelector('.calendar-day').dataset.date;
                selectDay(dateStr);
            }
        });
        
        const weekContainer = document.querySelector('.week-container');
        if (weekContainer) {
            weekContainer.innerHTML = '';
            weekContainer.appendChild(weekOverview);
        }
    }

function getWeekDayClass(day) {
    const classes = [];
    
    // First determine background color
    if (day.is_today && day.reason_type === 'TIME_PASSED') {
        classes.push('day-gray');
    } else if (!day.is_active && day.reason_type === 'MANUAL_OVERRIDE') {
        classes.push('day-red');
    } else if (!day.is_schedule_day || !day.is_active) {
        classes.push('day-gray');
    } else {
        classes.push('day-green');
    }
    
    // Add today marker if applicable
    if (day.is_today) {
        classes.push('day-today');
    }
    
    return classes.join(' ');
}


function getDayLabel(dateStr) {
    const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
    const date = new Date(dateStr);
    return days[date.getDay()];
}


function createAlertsContainer(isWalkingBusDay, dailyStatus) {
        const alertsContainer = document.createElement('div');
        alertsContainer.id = 'alerts-container';
        alertsContainer.innerHTML = `
            <div id="connection-alert" class="alert alert-danger d-none" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Die Verbindung zum Server wurde unterbrochen. Die angezeigten Daten sind mÃ¶glicherweise nicht aktuell.
            </div>
            <div id="walkingbus-alert" class="alert alert-info d-none" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="walkingbus-reason"></span>
                </div>
            </div>
            <div id="note-alert" class="alert alert-warning d-none" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-sticky-note me-2"></i>
                    <span id="walkingbus-note"></span>
                </div>
            </div>
        `;

        return alertsContainer;
    }

// Helper function for alerts update
function updateAlerts(isWalkingBusDay, dailyStatus) {
    const walkingbusAlert = document.getElementById('walkingbus-alert');
    const walkingbusReason = document.getElementById('walkingbus-reason');
    const noteAlert = document.getElementById('note-alert');
    const walkingbusNote = document.getElementById('walkingbus-note');

    const currentDay = isCurrentDay(dailyStatus.currentDate);
    const timePassed = checkTimePassed(dailyStatus.schedule?.end);
    const effectiveWalkingBusDay = isWalkingBusDay && !(timePassed && currentDay);

    if (walkingbusAlert && walkingbusReason) {
        walkingbusAlert.classList.toggle('d-none', effectiveWalkingBusDay);
        
        if (!effectiveWalkingBusDay) {
            walkingbusReason.innerHTML = dailyStatus.reason;
        }
    }

    if (noteAlert && walkingbusNote) {
        const hasNote = dailyStatus.note && dailyStatus.note.trim() !== '';
        noteAlert.classList.toggle('d-none', !hasNote);
        if (hasNote) {
            walkingbusNote.textContent = dailyStatus.note;
        }
    }
}



function initializeSizeControls() {
        const slider = document.getElementById('fontSizeSlider');
        const stationsContainer = document.getElementById('stations');
        const COMPACT_THRESHOLD = 1.05; // Threshold for switching to compact view
        
        // Add debug logging
        console.log('Found slider:', slider);
        console.log('Found stations container:', stationsContainer);
        
        // Load saved scale
        const savedScale = localStorage.getItem('cardScale') || 1;
        document.documentElement.style.setProperty('--base-scale', savedScale);
        slider.value = savedScale;
        
        // Initial layout check
        checkLayoutMode(savedScale);
        
        // Add both 'input' and 'change' events for better response
        ['input', 'change'].forEach(eventType => {
            slider.addEventListener(eventType, (e) => {
                console.log('Slider value changed:', e.target.value); // Debug log
                const newScale = parseFloat(e.target.value);
                document.documentElement.style.setProperty('--base-scale', newScale);
                localStorage.setItem('cardScale', newScale);
                
                // Check if we need to switch layout
                checkLayoutMode(newScale);
            });
        });
        
        function checkLayoutMode(scale) {
            console.log('Checking layout mode. Scale:', scale); // Debug log
            if (scale <= COMPACT_THRESHOLD) {
                stationsContainer.classList.add('compact-view');
            } else {
                stationsContainer.classList.remove('compact-view');
            }
        }
    }


function initializeViewToggle() {
    const viewToggle = document.getElementById('viewToggle');
    const stationsContainer = document.getElementById('stations');
    
    // Load saved preference
    const isCompactView = localStorage.getItem('compactView') === 'true';
    if (isCompactView) {
        stationsContainer.classList.add('compact-view');
        viewToggle.innerHTML = '<i class="fas fa-expand"></i>';
    }
    
    viewToggle.addEventListener('click', () => {
        stationsContainer.classList.toggle('compact-view');
        const isNowCompact = stationsContainer.classList.contains('compact-view');
        
        // Update button icon
        viewToggle.innerHTML = isNowCompact ? 
            '<i class="fas fa-expand"></i>' : 
            '<i class="fas fa-compress"></i>';
            
        // Save preference
        localStorage.setItem('compactView', isNowCompact);
    });
}

let lastWeatherTimestamp = null;

function initializeSSE() {
    console.log('[SSE] Initializing server connection');
    globalEventSource = new EventSource('/stream');
    
    globalEventSource.onopen = function() {
        console.log('[SSE] Connection established');
        SSE_updateConnectionStatus('connected');
    };
    
    globalEventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('[SSE] Received update:', data);

        switch(data.type) {
            case 'status_change':
                SSE_handleStatusUpdate(data);
                break;
            case 'time_update':
                SSE_updateTimeDisplay(data.time);
                break;
            case 'weather_update':
                // Compare server timestamps instead of client time
                if (data.timestamp !== lastWeatherTimestamp) {
                    lastWeatherTimestamp = data.timestamp;
                    console.log('[SSE] Processing weather update:', data.timestamp);
                    const selectedDate = document.querySelector('.week-container .selected-day .calendar-day')?.dataset.date;
                    if (selectedDate) {
                        updateWeatherDisplay(selectedDate);
                    }
                } else {
                    console.log('[SSE] Skipping duplicate weather update:', data.timestamp);
                }
                break;
        }
    };
    
    globalEventSource.onerror = SSE_handleError;
}


function SSE_handleStatusUpdate(data) {
    const selectedDate = document.querySelector('.week-container .selected-day .calendar-day')?.dataset.date;
    
    // Only proceed if we're viewing the date that was updated
    if (selectedDate === data.date) {
        const participantStates = {};
        data.stations.forEach(station => {
            station.participants.forEach(participant => {
                participantStates[participant.id] = participant.status;
            });
        });

        const dailyStatus = {
            currentDate: data.date,
            participantStates: participantStates,
            schedule: data.schedule,
            isWalkingBusDay: data.isWalkingBusDay
        };

        updateAllParticipantStates(dailyStatus);
        document.querySelectorAll('[data-station-id]').forEach(station => {
            updateStationStats(station.dataset.stationId);
        });
        updateTotalStats();
    }
}


function SSE_updateTimeDisplay(time) {
    const timeElement = document.getElementById('current-time');
    if (timeElement && time !== timeElement.textContent) {
        timeElement.textContent = time;
    }
}


function SSE_handleError() {
    console.log('[SSE] Connection error');
    SSE_updateConnectionStatus('disconnected');
    
    const connectionAlert = document.getElementById('connection-alert');
    if (connectionAlert) {
        connectionAlert.classList.remove('d-none');
    }
}

function SSE_updateConnectionStatus(status) {
    const indicator = document.querySelector('.connection-indicator');
    if (!indicator) return;

    // Remove all possible states
    indicator.classList.remove('connected', 'disconnected', 'reconnecting');
    
    // Update icon and class based on status
    switch(status) {
        case 'reconnecting':
            indicator.classList.add('reconnecting');
            indicator.className = 'fas fa-spinner connection-indicator reconnecting';
            break;
        case 'connected':
            indicator.classList.add('connected');
            indicator.className = 'fas fa-circle connection-indicator connected';
            break;
        case 'disconnected':
            indicator.classList.add('disconnected');
            indicator.className = 'fas fa-circle connection-indicator disconnected';
            break;
    }
}


function showErrorMessage(message) {
    const errorAlert = document.createElement('div');
    errorAlert.classList.add(
        'alert', 
        'alert-danger', 
        'position-fixed', 
        'bottom-0', 
        'start-50', 
        'translate-middle-x', 
        'm-3', 
        'z-index-top'
    );
    errorAlert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
    `;
    document.body.appendChild(errorAlert);
    
    setTimeout(() => errorAlert.remove(), 5000);
}


// Unified visibility and page show handling
document.addEventListener('visibilitychange', () => {
    isPageVisible = !document.hidden;

    if (document.hidden) {
        console.log('[SSE] Page hidden, closing connection');
        if (globalEventSource) {
            globalEventSource.close();
        }
    } else {
        console.log('[SSE] Page visible, performing full reload');
        
        // Show reconnecting state immediately
        SSE_updateConnectionStatus('reconnecting');

        // Clear any existing alert
        const connectionAlert = document.getElementById('connection-alert');
        connectionAlert.classList.add('d-none');

        const selectedDate = document.querySelector('.week-container .selected-day .calendar-day')?.dataset.date;
        console.log('[VISIBILITY] Reloading data for date:', selectedDate);
        
        // First get the daily status for the selected date
        axios.get('/api/daily-status', { params: { date: selectedDate } })
            .then(dailyStatusResponse => {
                // Enhance daily status with necessary data
                const enhancedDailyStatus = {
                    ...dailyStatusResponse.data,
                    currentDate: selectedDate,
                    reason: createReasonMap(
                        dailyStatusResponse.data.stateReason,
                        dailyStatusResponse.data.holidayData,
                        dailyStatusResponse.data.isWalkingBusDay,
                        dailyStatusResponse.data.schedule,
                        dailyStatusResponse.data.reason
                    ),
                    reason_type: dailyStatusResponse.data.stateReason
                };

                // Now perform the full initial load with the correct status
                return loadInitialData().then(() => {
                    // Update stats with the enhanced daily status
                    window.appState.stations.forEach(station => {
                        updateStationStats(station.id, enhancedDailyStatus);
                    });
                    updateTotalStats(enhancedDailyStatus);
                    
                    console.log('[RELOAD] Initial load complete');
                    initializeSSE();
                    
                    // Set connection status to connected after successful reload
                    SSE_updateConnectionStatus('connected');
                });
            })
            .catch(error => {
                console.error('[RELOAD] Error during reload:', error);
                showErrorMessage('Fehler beim Neuladen der Daten');
                // Set connection status to disconnected on error
                SSE_updateConnectionStatus('disconnected');
            });
    }
});



// Keep pageshow handler for browser cache scenarios
window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
        // Show reconnecting state immediately when page is loaded from cache
        SSE_updateConnectionStatus('reconnecting');

        loadInitialData().then(() => {
            console.log('[PAGESHOW] Initial load complete');
            initializeSSE();
            // Update to connected state after successful load
            SSE_updateConnectionStatus('connected');
        }).catch(error => {
            console.error('[PAGESHOW] Error during reload:', error);
            showErrorMessage('Fehler beim Neuladen der Daten');
            // Update to disconnected state on error
            SSE_updateConnectionStatus('disconnected');
        });
    }
});


async function updateWeatherDisplay(date) {
    try {
        const formattedDate = date.includes('T') ? date.split('T')[0] : date;
        console.log('[WEATHER] Updating display for date:', formattedDate);
        
        const response = await fetch(`/api/weather?date=${formattedDate}`);
        const data = await response.json();
        
        const weatherInfo = document.getElementById('weather-info');
        const weatherIcon = document.querySelector('.weather-icon');

        // Check if we have valid weather data in the response
        const hasValidWeather = data?.status === 'success' && 
                              data?.data?.icon && 
                              data?.data?.pop !== undefined && 
                              data?.data?.precipitation !== undefined;

        if (hasValidWeather) {
            // Show weather icon and data
            weatherIcon.style.display = 'block';
            weatherIcon.src = `/static/icons/weather/${data.data.icon}.svg`;
            
            weatherInfo.className = 'badge bg-light text-dark';
            weatherInfo.innerHTML = `
                <span>${Math.round(data.data.pop * 100)}%</span>
                <span>${Number(data.data.precipitation).toFixed(2)}mm</span>
            `;
        } else {
            // Show "keine Wetter-Daten" when no valid data
            weatherIcon.style.display = 'none';
            weatherInfo.className = 'badge bg-secondary text-light';
            weatherInfo.innerHTML = `
                <i class="fas fa-cloud-slash me-1"></i>
                Keine Wetter-Daten
            `;
        }
    } catch (error) {
        console.error('[WEATHER] Error:', error);
    }
}


////////////////////////////////////////////////////////////////////////////////



    function ALT_updateWeekOverviewNumbers(weekData, selectedDate) {
        weekData.forEach(dayData => {
            const dayElement = document.querySelector(`.calendar-day[data-date="${dayData.date}"]`);
            if (dayElement) {
                // Update total confirmed number
                const dayNumber = dayElement.querySelector('.day-number');
                if (dayNumber) {
                    dayNumber.textContent = dayData.total_confirmed > 0 ? 
                        dayData.total_confirmed : '-';
                }
                
                // Update day status classes if needed
                updateDayStatusClasses(dayElement, dayData);
            }
        });
    }

    function ALT_updateDayStatusClasses(dayElement, dayData) {
        dayElement.classList.remove('day-green', 'day-red', 'day-gray');
        
        if (dayData.reason_type === 'TIME_PASSED') {
            dayElement.classList.add('day-gray');
        } else if (!dayData.is_active && dayData.reason_type === 'MANUAL_OVERRIDE') {
            dayElement.classList.add('day-red');
        } else if (!dayData.is_active) {
            dayElement.classList.add('day-gray');
        } else {
            dayElement.classList.add('day-green');
        }
    }


    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let isReconnecting = false;

    // Modify initializeSSE to handle mobile focus better
    async function ALT_initializeSSE() {
        console.log('Starting SSE connection...');
        
        if (globalEventSource) {
            globalEventSource.close();
        }
        
        let connectionAlertTimeout;
        const alertDelay = 10000;
        
        try {
            // First verify authentication using fetchWithAuth
            const authCheck = await fetchWithAuth('/stream');
            if (!authCheck.ok) {
                throw new Error('Authentication check failed');
            }
            
            // Create SSE connection after successful auth check
            globalEventSource = new EventSource('/stream');
            
            // Handle retry events from server
            globalEventSource.addEventListener('retry', function(e) {
                console.log('Server waiting for authentication...', e.data);
                updateConnectionStatus('connecting');
            });
            
            // Handle unauthorized events
            globalEventSource.addEventListener('unauthorized', function(e) {
                console.log('Authentication failed after retries');
                window.location.href = '/login';
            });
            
            globalEventSource.onmessage = function(event) {
                (async () => {
                    console.log('Received SSE update:', event.data);
                    const data = JSON.parse(event.data);

                    // Get today's date in YYYY-MM-DD format
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Find today's status from week_overview
                    const todayStatus = data.week_overview.find(day => day.date === today);
                    
                    // Set global status with data from week_overview
                    globalDailyStatus = {
                        reason_type: todayStatus?.reason_type,
                        reason: todayStatus?.reason,
                        isWalkingBusDay: todayStatus?.is_active
                    };

                    // Update time display
                    if (data.time) {
                        document.getElementById('current-time').textContent = data.time;
                    }

                    // Update time icons
                    if (data.dailyStatus) {
                        updateTimeIcons(data.dailyStatus);
                    }

                    // Get currently selected date
                    const selectedDate = document.querySelector('.selected-day .calendar-day')?.dataset.date;
                    
                    // 1. Update week overview immediately
                    if (data.week_overview) {
                        updateWeekOverviewNumbers(data.week_overview, selectedDate);
                    }
                    
                    // 2. Update visible content immediately if it matches current view
                    if (selectedDate === data.date) {
                        const db = await dbPromise;
                        const previousStates = await getPreviousStates(db);
                        await loadStations(previousStates, selectedDate);
                    }

                    // 3. Cache all data in background for all dates
                    try {
                        const db = await dbPromise;
                        await updateCache(db, data.stations, data.dailyStatus, data.date);
                        
                        // Optional: Fetch and cache data for next few days
                        const nextDays = [1, 2, 3, 4, 5];
                        for (const dayOffset of nextDays) {
                            const futureDate = new Date(data.date);
                            futureDate.setDate(futureDate.getDate() + dayOffset);
                            const futureDateStr = futureDate.toISOString().split('T')[0];
                            
                            const response = await axios.get('/api/stations', {
                                params: { date: futureDateStr, admin: 0 }
                            });
                            
                            await updateCache(db, response.data.stations, response.data.dailyStatus, futureDateStr);
                        }
                    } catch (error) {
                        console.error('Background caching error:', error);
                        // Non-critical error, don't interrupt user experience
                    }

                    // Update connection status
                    updateConnectionStatus('connected');
                    reconnectAttempts = 0;
                    isReconnecting = false;
                    if (connectionAlertTimeout) {
                        clearTimeout(connectionAlertTimeout);
                        connectionAlertTimeout = null;
                    }
                    
                })();
            };

            globalEventSource.addEventListener('error', (event) => {
                console.error('SSE connection error:', event);
                updateConnectionStatus('disconnected');
                
                if (!isReconnecting && reconnectAttempts < maxReconnectAttempts) {
                    isReconnecting = true;
                    reconnectAttempts++;
                    
                    setTimeout(async () => {
                        console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                        isReconnecting = false;
                        globalEventSource.close();
                        
                        // Verify auth before reconnecting
                        const authCheck = await fetchWithAuth('/stream');
                        if (!authCheck.ok) {
                            window.location.href = '/login';
                            return;
                        }
                        initializeSSE();
                    }, 5000 * reconnectAttempts);
                } else if (reconnectAttempts >= maxReconnectAttempts) {
                    const connectionAlert = document.getElementById('connection-alert');
                    connectionAlert.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Die Verbindung zum Server wurde unterbrochen.
                    `;
                    connectionAlert.classList.remove('d-none');
                    globalEventSource.close();
                }
            });

            // Mobile-specific event listeners
            document.addEventListener('focus', handlePageFocus);
            document.addEventListener('resume', handlePageFocus);
            
            function handlePageFocus() {
                if (!isReconnecting) {
                    loadStations();
                }
                if (connectionAlertTimeout) {
                    clearTimeout(connectionAlertTimeout);
                    connectionAlertTimeout = null;
                }
            }
        } catch (error) {
            console.error('SSE initialization failed:', error);
            updateConnectionStatus('disconnected');
            if (error.message === 'Authentication check failed') {
                window.location.href = '/login';
            }
        }

        return globalEventSource;
    }



    function ALT_updateConnectionStatus(status) {
        const connectionAlert = document.getElementById('connection-alert');
        const connectionIndicator = document.querySelector('.connection-indicator');
        
        // Only update alert if element exists and page is visible
        if (connectionAlert && !document.hidden) {
            connectionAlert.classList.toggle('d-none', status === 'connected');
        }
        
        // Only update indicator if element exists
        if (connectionIndicator) {
            connectionIndicator.classList.remove('connected', 'disconnected');
            connectionIndicator.classList.add(status === 'connected' ? 'connected' : 'disconnected');
        }
    }

    // Helper function to get previous states
    async function getPreviousStates(db) {
        return new Promise((resolve) => {
            const transaction = db.transaction(['participantStates'], 'readonly');
            const store = transaction.objectStore('participantStates');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const states = {};
                request.result.forEach(item => {
                    states[item.id] = item;
                });
                resolve(states);
            };
            
            request.onerror = () => resolve({});
        });
    }
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}
