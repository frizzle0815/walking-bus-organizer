{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-2 py-2" style="max-width: 600px;">
    <div id="stations"></div>
</div>

<!-- Calendar Modal -->
<div id="calendarModal" class="modal">
    <div class="modal-content">
        <span class="close">×</span>
        <div id="calendar"></div>
    </div>
</div>

<style>
    .station-card {
        background-color: #414141;
        border-radius: 8px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .station-header {
        padding: 8px 12px;
        border-bottom: 1px solid #555;
        background-color: #414141;
        border-radius: 8px 8px 0 0;
        color: white;
    }

    .participants-list {
        background-color: #fff;
        border-radius: 0 0 8px 8px;
        padding: 4px;
    }

    .participant-item {
        border: none !important;
        margin: 2px 0;
        border-radius: 4px !important;
    }

    /* Calendar Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .week {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .calendar-day {
        display: inline-block;
        width: 40px;
        height: 40px;
        margin: 2px;
        text-align: center;
        line-height: 40px;
        cursor: pointer;
        border-radius: 50%;
    }

    .day-green { background-color: #d4edda; }
    .day-red { background-color: #f8d7da; }
    .day-gray { 
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .calendar-btn {
        margin-left: 5px;
        padding: 0.2rem 0.5rem;
        font-size: 0.8rem;
        border-radius: 50%;
        border: 1px solid #ddd;
        background: transparent;
        color: #666;
    }

    .calendar-day-header {
        display: inline-block;
        width: 40px;
        height: 30px;
        margin: 2px;
        text-align: center;
        line-height: 30px;
        font-weight: bold;
        font-size: 0.9rem;
        color: #666;
    }
    .btn-outline-secondary {
        background-color: #e9ecef;
        border-color: #e9ecef;
        color: #6c757d;
    }

    .btn-outline-secondary:disabled {
        cursor: not-allowed;
    }
</style>
  <script>
      let currentParticipantId = null;
      const statusOverrides = {};
            // Update the constant
            const WEEKDAY_MAPPING = {
                0: 'monday',
                1: 'tuesday',
                2: 'wednesday',
                3: 'thursday',
                4: 'friday',
                5: 'saturday',
                6: 'sunday'
            };

            async function initializeDailyStatus() {
                try {
                  await axios.post('/api/initialize-daily-status');
              } catch (error) {
                  console.error('Error initializing daily status:', error);
              }
          }
            async function loadStations() {
                const response = await axios.post('/api/initialize-daily-status');
                const { currentDate, isWalkingBusDay } = response.data;

                const stationsResponse = await axios.get('/api/stations');
                const stations = stationsResponse.data;
                const stationsContainer = document.getElementById('stations');
                stationsContainer.innerHTML = '';

                stations.forEach(station => {
                    const stationDiv = document.createElement('div');
                    stationDiv.classList.add('station-card');
                    stationDiv.innerHTML = `
                        <div class="station-header">
                            <h5 class="d-flex justify-content-between align-items-center mb-0">
                                <span>
                                    <i class="fas fa-bus-simple me-2"></i>
                                    ${station.name}
                                </span>
                                <span class="badge bg-light text-dark" id="stats-station-${station.id}">
                                    ${getStationStats(station)}
                                </span>
                            </h5>
                        </div>`;

                    const list = document.createElement('ul');
                    list.classList.add('list-group', 'list-group-flush', 'participants-list');
                    list.dataset.stationId = station.id;

                    station.participants.forEach(participant => {
                        const item = document.createElement('li');
                        item.classList.add('list-group-item', 'py-1', 'd-flex', 'justify-content-between', 'align-items-center', 'participant-item');

                        // Set color based on the status and whether it's a walking bus day
                        if (!isWalkingBusDay) {
                            item.style.backgroundColor = '#e9ecef'; // Gray for non-walking bus days
                        } else {
                            item.style.backgroundColor = participant.status_today ? '#d4edda' : '#f8d7da';
                        }

                        item.dataset.participantId = participant.id;

                        const nameSpan = document.createElement('span');
                        nameSpan.classList.add('text-truncate', 'me-2');
                        nameSpan.style.fontSize = '0.9rem';
                        const trafficLightIcon = document.createElement('i');
                        trafficLightIcon.classList.add('fas', 'me-2');
                        if (!isWalkingBusDay || !participant.status_today) {
                            trafficLightIcon.classList.add('fa-person');
                            trafficLightIcon.style.color = '#6c757d'; // Gray color for non-walking bus days or absences
                        } else {
                            trafficLightIcon.classList.add('fa-walking');
                            trafficLightIcon.style.color = '#28a745'; // Green color for presence
                        }
                        nameSpan.appendChild(trafficLightIcon);
                        nameSpan.appendChild(document.createTextNode(participant.name));
                        const buttonContainer = document.createElement('div');
                        buttonContainer.classList.add('d-flex', 'align-items-center');

                        const statusButton = document.createElement('button');
                        statusButton.classList.add('btn', 'btn-sm', 'rounded-pill');
                        statusButton.style.fontSize = '0.8rem';
                        statusButton.style.padding = '0.2rem 0.8rem';
                        if (!isWalkingBusDay) {
                            statusButton.classList.add('btn-outline-secondary'); // Gray button for non-walking bus days
                            statusButton.style.cursor = 'not-allowed'; // Forbidden cursor
                            statusButton.innerHTML = '<i class="fas fa-times"></i>'; // X for non-walking bus days
                        } else {
                            statusButton.classList.add(participant.status_today ? 'btn-outline-danger' : 'btn-outline-success');
                            statusButton.innerHTML = participant.status_today ? '<i class="fas fa-times"></i>' : '<i class="fas fa-check"></i>';
                            statusButton.onclick = () => toggleParticipation(participant.id, statusButton);
                        }

                        const calendarButton = document.createElement('button');
                        calendarButton.classList.add('calendar-btn');
                        calendarButton.innerHTML = '<i class="fas fa-calendar-alt"></i>';
                        calendarButton.onclick = (e) => {
                            e.stopPropagation();
                            openCalendar(participant.id);
                        };

                        buttonContainer.appendChild(statusButton);
                        buttonContainer.appendChild(calendarButton);
                        item.appendChild(nameSpan);
                        item.appendChild(buttonContainer);
                        list.appendChild(item);
                    });

                    stationDiv.appendChild(list);
                    stationsContainer.appendChild(stationDiv);
                });
            }
          function getStationStats(station) {
              const totalParticipants = station.participants.length;
              const confirmedParticipants = station.participants.filter(p => p.status_today).length;
              return `${confirmedParticipants} / ${totalParticipants}`;
          }

          function updateStationStats(stationId) {
              // Fetch current data from server
              fetch(`/api/stations/${stationId}/stats`)
                  .then(response => response.json())
                  .then(data => {
                      const statsElement = document.getElementById(`stats-station-${stationId}`);
                      if (statsElement) {
                          statsElement.textContent = `${data.active} / ${data.total}`;
                      }
                  });
          }
            async function getStatusForDay(participantId, date) {
                console.log('Getting status for:', {
                    date: date.toISOString(),
                    localDate: date.toLocaleString(),
                    dayOfWeek: date.getDay(),
                    weekday: WEEKDAY_MAPPING[date.getDay()]
                });
                try {
                    const response = await axios.get(`/api/calendar-status/${participantId}`);
                    const dateStr = date.toISOString().split('T')[0];
                    const entry = response.data.find(e => e.date === dateStr);
              
                    if (entry) {
                        return entry.status;
                    }
              
                    // Get the raw day number from JavaScript's getDay()
                    const dayNumber = date.getDay();
              
                    // Map the day number to our weekday name
                    const weekday = WEEKDAY_MAPPING[dayNumber];
              
                    // Only proceed if it's a weekday
                    if (weekday) {
                        const defaultStatusResponse = await axios.get(`/api/participant/${participantId}/weekday-status/${weekday}`);
                        return defaultStatusResponse.data.status;
                    }
              
                    return false; // Weekend days
                } catch (error) {
                    console.error('Error fetching calendar status:', error);
                    return false;
                }
            }

      async function toggleParticipation(participantId, button) {
          try {
              console.log('Sending PATCH request for participant:', participantId);
              const response = await axios.patch(`/api/participation/${participantId}`);
              const { status_today } = response.data;
              
              // Update UI
              updateParticipantUI(button, status_today);
              
              // Update calendar if open
              if (document.getElementById('calendarModal').style.display === 'block') {
                  await renderCalendar();
              }
              
          } catch (error) {
              console.error('Error toggling participation:', error);
          }
      }
      function updateParticipantUI(button, status) {
          const listItem = button.closest('.participant-item');
          listItem.style.backgroundColor = status ? '#d4edda' : '#f8d7da';
          button.classList.toggle('btn-outline-danger', status);
          button.classList.toggle('btn-outline-success', !status);
          button.innerHTML = status ? '<i class="fas fa-times"></i>' : '<i class="fas fa-check"></i>';
          
          // Update traffic light icon - find icon by first child of nameSpan
          const trafficLightIcon = listItem.querySelector('.text-truncate > i');
          if (trafficLightIcon) {
              // Remove both possible classes
              trafficLightIcon.classList.remove('fa-walking', 'fa-person');
              // Add the correct class based on status
              trafficLightIcon.classList.add(status ? 'fa-walking' : 'fa-person');
              trafficLightIcon.style.color = status ? '#28a745' : '#dc3545';
          }
          
          // Update station statistics
          const stationList = button.closest('.participants-list');
          const stationId = stationList.dataset.stationId;
          updateStationStats(stationId);
      }
    async function openCalendar(participantId) {
        currentParticipantId = participantId;
        const modal = document.getElementById('calendarModal');
    
        // Get participant name from the button's parent structure
        const calendarButton = event.target;
        const participantItem = calendarButton.closest('.participant-item');
        const participantName = participantItem.querySelector('.text-truncate').textContent.trim();
    
        // Update modal header with participant name and restore close button functionality
        const modalContent = modal.querySelector('.modal-content');
        modalContent.innerHTML = `
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <span class="close" onclick="document.getElementById('calendarModal').style.display='none'">×</span>
                <h4 class="mb-0 ms-3">${participantName}</h4>
            </div>
            <div id="calendar"></div>
        `;
    
        modal.style.display = 'block';
        await renderCalendar();
    }

async function initializeDailyStatus() {
    try {
        const response = await axios.post('/api/initialize-daily-status');
        return response.data.currentDate;  // Use this date for further operations
    } catch (error) {
        console.error('Error initializing daily status:', error);
    }
}

async function toggleDayStatus(participantId, date, dayDiv) {
    const serverDate = await initializeDailyStatus();  // Get server's current date
    const clickedDate = date.toISOString().split('T')[0];  // Extract 'YYYY-MM-DD'

    console.log('Server Date:', serverDate);
    console.log('Clicked Date:', clickedDate);

    if (serverDate === clickedDate) {
        // Handle today's status toggle
        const participantItem = document.querySelector(`.participant-item[data-participant-id="${participantId}"]`);
        if (participantItem) {
            const statusButton = participantItem.querySelector('button');
            if (statusButton) {
                console.log('Toggling participation for today');
                await toggleParticipation(participantId, statusButton);
            } else {
                console.error('Status button not found');
            }
        } else {
            console.error('Participant item not found');
        }
        return;
    }

    // Handle future dates
    const currentStatus = dayDiv.classList.contains('day-green');
    const newStatus = !currentStatus;

    await axios.post('/api/calendar-status', {
        participant_id: participantId,
        date: clickedDate,
        status: newStatus
    });

    dayDiv.classList.toggle('day-green');
    dayDiv.classList.toggle('day-red');
}

function getNextTwoWeeks(startDate) {
          const weeks = [];
          const firstDay = new Date(startDate);
          // Set time to noon to avoid timezone issues
          firstDay.setHours(12, 0, 0, 0);
          firstDay.setDate(firstDay.getDate() - firstDay.getDay() + 1);
        
          for (let w = 0; w < 2; w++) {
              const week = [];
              for (let i = 0; i < 7; i++) {
                  const day = new Date(firstDay);
                  day.setDate(day.getDate() + (w * 7) + i);
                  week.push(day);
              }
              weeks.push(week);
          }
          return weeks;
      }

// Single declaration at the top level
async function isWalkingBusDay(date) {
    const schedule = await fetch('/api/walking-bus-schedule').then(r => r.json());
    const dayMap = {
        0: 'monday',
        1: 'tuesday',
        2: 'wednesday',
        3: 'thursday',
        4: 'friday',
        5: 'saturday',
        6: 'sunday'
    };
    return schedule[dayMap[date.getDay()]];
}

// Update renderCalendar to handle the async isWalkingBusDay
async function renderCalendar() {
    try {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        
        // Get server's current date for consistent comparison
        const serverResponse = await axios.post('/api/initialize-daily-status');
        const serverDate = new Date(serverResponse.data.currentDate);
        serverDate.setHours(0, 0, 0, 0);
        
        const calendarData = await fetch(`/api/calendar-data/${currentParticipantId}`).then(r => r.json());
        
        // Generate weeks data
        const weeks = getNextTwoWeeks(serverDate);
        
        // Weekday mapping starting with Monday as 0
        const WEEKDAY_MAPPING = {
            0: 'monday',
            1: 'tuesday',
            2: 'wednesday',
            3: 'thursday',
            4: 'friday',
            5: 'saturday',
            6: 'sunday'
        };
        
        // Render weekday headers
        const weekdayHeader = document.createElement('div');
        weekdayHeader.className = 'week';
        ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'].forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            weekdayHeader.appendChild(dayHeader);
        });
        calendar.appendChild(weekdayHeader);

        // Render calendar days
        for (const week of weeks) {
            const weekDiv = document.createElement('div');
            weekDiv.className = 'week';
            
            for (const date of week) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = date.getDate();
                
                const compareDate = new Date(date);
                compareDate.setHours(0, 0, 0, 0);
                
                const dayIndex = (date.getDay() + 6) % 7;
                const dayName = WEEKDAY_MAPPING[dayIndex];
                
                if (compareDate < serverDate) {
                    dayDiv.classList.add('day-gray');
                } else if (!calendarData.schedule[dayName]) {
                    dayDiv.classList.add('day-gray');
                } else {
                    const status = await getStatusForDay(currentParticipantId, date);
                    dayDiv.classList.add(status ? 'day-green' : 'day-red');
                }
                
                weekDiv.appendChild(dayDiv);
            }
            calendar.appendChild(weekDiv);
        }
    } catch (error) {
        console.error('Calendar rendering error:', error);
    }
}

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        loadStations();
    });
        function getNextTwoWeeks(startDate) {
        const weeks = [];
        const firstDay = new Date(startDate);
        firstDay.setDate(firstDay.getDate() - firstDay.getDay() + 1);
        
        for (let w = 0; w < 2; w++) {
            const week = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(firstDay);
                day.setDate(day.getDate() + (w * 7) + i);
                week.push(day);
            }
            weeks.push(week);
        }
        return weeks;
    }

    async function initializeDailyStatus() {
        try {
            const response = await axios.post('/api/initialize-daily-status');
            return response.data.currentDate;  // Use this date for further operations
        } catch (error) {
            console.error('Error initializing daily status:', error);
        }
    }

    async function toggleDayStatus(participantId, date, dayDiv) {
        const serverDate = await initializeDailyStatus();  // Get server's current date
        const clickedDate = date.toISOString().split('T')[0];  // Extract 'YYYY-MM-DD'

        console.log('Server Date:', serverDate);
        console.log('Clicked Date:', clickedDate);

        if (serverDate === clickedDate) {
            // Handle today's status toggle
            const participantItem = document.querySelector(`.participant-item[data-participant-id="${participantId}"]`);
            if (participantItem) {
                const statusButton = participantItem.querySelector('button');
                if (statusButton) {
                    console.log('Toggling participation for today');
                    await toggleParticipation(participantId, statusButton);
                } else {
                    console.error('Status button not found');
                }
            } else {
                console.error('Participant item not found');
            }
            return;
        }

        // Handle future dates
        const currentStatus = dayDiv.classList.contains('day-green');
        const newStatus = !currentStatus;

        await axios.post('/api/calendar-status', {
            participant_id: participantId,
            date: clickedDate,
            status: newStatus
        });

        dayDiv.classList.toggle('day-green');
        dayDiv.classList.toggle('day-red');
    }
    async function getStatusForDay(participantId, date) {
        try {
            const response = await axios.get(`/api/calendar-status/${participantId}`);
            const dateStr = date.toISOString().split('T')[0];
            const entry = response.data.find(e => e.date === dateStr);
        
            if (entry) {
                return entry.status;
            }
        
            // Fall back to default weekday status
            return getDefaultStatus(participantId, date);
        } catch (error) {
            console.error('Error fetching calendar status:', error);
            return getDefaultStatus(participantId, date);
        }
    }
    function getDefaultStatus(participantId, date) {
        // This should be implemented to get the default status from your backend
        return true; // Placeholder
    }

    document.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('statusOverrides');
        if (saved) {
            Object.assign(statusOverrides, JSON.parse(saved));
        }
        
        const modal = document.getElementById('calendarModal');
        const span = document.getElementsByClassName('close')[0];
        
        span.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    });

    loadStations();
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}
