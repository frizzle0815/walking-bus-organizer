{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-2 py-2 content-container">
    <div id="stations"></div>
</div>

<!-- Calendar Modal -->
<div id="calendarModal" class="modal">
    <div class="modal-content">
        <span class="close">×</span>
        <div id="calendar"></div>
    </div>
</div>

<style>
        /* Prevent text selection for app like experience */
    *:not(input, textarea) {
        user-select: none; /* Prevent text selection */
        -webkit-user-select: none; /* For Safari */
        -moz-user-select: none; /* For Firefox */
        -ms-user-select: none; /* For IE10+/Edge */
    }

    /* General Styles */
    .content-container {
        max-width: 600px;
    }

    .station-card {
        background-color: #414141;
        border-radius: 8px;
        margin-bottom: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .station-card:first-child {
        margin-bottom: 24px; /* More space between summary and first station */
    }

    .station-card:first-child .station-header {
        border-radius: 8px; /* Round all corners */
    }

    .station-header {
        padding: 8px 12px;
        border-bottom: 1px solid #555;
        background-color: #414141;
        border-radius: 8px 8px 0 0;
        color: white;
    }

    /* Base styles */
    .participants-list {
        perspective: 400px;
        background-color: var(--participants-bg);
        border-radius: 0 0 8px 8px;
        padding: 4px;
    }

    .participant-item {
        border: none !important;
        margin: 2px 0;
        border-radius: 4px !important;
        font-size: 0.9rem;
        transform-style: preserve-3d;
        perspective: 1000px;
    }

    .participant-name {
        font-weight: bold;
        display: flex;
        align-items: center;
        line-height: 1; /* Ensures text aligns with icon */
    }

    /* Status colors */
    .participant-status-active {
        background-color: #a9e6b7;
    }

    .participant-status-inactive {
        background-color: #f8bfc3;
    }

    .participant-status-disabled {
        background-color: #e9ecef;
    }

    /* Animation for transitioning from active to inactive */
    @keyframes fadeSlideActiveToInactive {
        0% {
            background-color: #a9e6b7; /* Active color */
            transform: translateX(0);
            opacity: 0.5;
        }
        100% {
            background-color: #f8bfc3; /* Inactive color */
            transform: translateX(10px);
            opacity: 1;
        }
    }

    /* Animation for transitioning from inactive to active */
    @keyframes fadeSlideInactiveToActive {
        0% {
            background-color: #f8bfc3; /* Inactive color */
            transform: translateX(0);
            opacity: 0.5;
        }
        100% {
            background-color: #a9e6b7; /* Active color */
            transform: translateX(10px);
            opacity: 1;
        }
    }

    .participant-item.active-to-inactive {
        animation: fadeSlideActiveToInactive 0.5s ease-in-out;
    }

    .participant-item.inactive-to-active {
        animation: fadeSlideInactiveToActive 0.5s ease-in-out;
    }

    /* Calendar Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .week {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .calendar-day {
        display: inline-flex;
        width: 40px;
        height: 40px;
        margin: 2px;
        justify-content: center;  /* Center horizontally */
        align-items: center;     /* Center vertically */
        border-radius: 50%;
        cursor: pointer;
    }

    .day-green { background-color: #a9e6b7; }
    .day-red { background-color: #f8bfc3 }
    .day-gray {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .calendar-btn {
        margin-left: 5px;
        padding: 0.2rem 0.5rem;
        font-size: 0.8rem;
        border-radius: 50%;
        border: 1px solid #ddd;
        background-color: white;  /* Changed from transparent */
        color: #666;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);  /* Adding subtle shadow */
    }

    .calendar-day-header {
        display: inline-block;
        width: 40px;
        height: 30px;
        margin: 2px;
        text-align: center;
        line-height: 30px;
        font-weight: bold;
        font-size: 0.9rem;
        color: #666;
    }

    .day-today {
        border: 2px solid #0d6efd;  /* Bootstrap primary blue */
    }


    /* Button Styles */
    .btn-outline-secondary {
        background-color: #e9ecef;
        border-color: #e9ecef;
        color: #6c757d;
    }

    .btn-outline-secondary:disabled {
        cursor: not-allowed;
    }

    .status-button {
        font-size: 0.8rem;
        padding: 0.2rem 0.8rem;
        background-color: white;  /* Adding white background */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);  /* Adding subtle shadow */
    }

    /* Override Bootstrap's background colors for outline buttons */
    .btn-outline-success, 
    .btn-outline-danger {
        background-color: white !important;
    }

    .btn-outline-success:hover,
    .btn-outline-danger:hover {
        background-color: white !important;
        opacity: 0.8;
    }

    .status-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        pointer-events: none;
    }

    @keyframes warningPulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .fa-exclamation-triangle {
        animation: warningPulse 2s infinite;
    }


    .status-button-disabled {
        cursor: not-allowed;
    }

    /* Icon Styles */
    .icon-active {
        color: #28a745;
    }

    .icon-inactive {
        color: #dc3545;
    }

    .icon-disabled {
        color: #6c757d;  /* Bootstrap's secondary gray color */
    }

    /* Traffic Light Icons */
    .icon-container {
        position: relative;
        display: inline-block;
        width: 1em;    /* Width of one icon */
        height: 1em;   /* Height of one icon */
        margin-right: 0.5rem;
    }

    .traffic-light {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.2em; /* Slightly wider to accommodate icon */
        height: 1.2em; /* Match width for perfect square */
        margin-right: 0.5rem;
    }

    .traffic-light.next-icon {
        opacity: 0;  /* Initially hidden */
    }

    .status-changing .traffic-light.current-icon {
        animation: iconTransition 1s linear;
    }

    .status-changing .traffic-light.next-icon {
        animation: iconTransition 1s linear reverse;
    }

    /* Add this to your existing style section */
    @keyframes highlightChange {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); background-color: #fff3cd; }
        100% { transform: scale(1); }
    }

    .highlight-change {
        animation: highlightChange 1.5s ease-in-out;
    }

    .warning-icon {
        color: #dc3545; /* Bootstrap's danger color */
        background-color: #fff; /* White background for contrast */
        padding: 2px; /* Padding for better visibility */
        margin-right: 8px; /* Space between icon and button */
        border-radius: 50%; /* Optional: round the icon */
    }


    /* Compact view */
    .compact-view .participants-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
        padding: 4px;
    }

    .compact-view .participant-item {
        margin: 0;
        display: grid;
        grid-template-columns: 1fr auto; /* 1fr for name, auto for buttons */
        align-items: center;
        gap: 4px;
        width: 100%;
    }

    /* Adjust spacing for compact items */
    .compact-view .participant-name {
        font-size: calc(0.9rem * var(--base-scale));
        min-width: 0; /* Enables text truncation */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    
    .compact-view .button-container {
        display: flex;
        gap: 2px;
        flex-shrink: 0; /* Prevents buttons from shrinking */
    }

/* Ensure equal width columns in the grid */
    .compact-view .participants-list {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)); /* minmax(0, 1fr) ensures equal columns */
        gap: 4px;
        padding: 4px;
    }

    .compact-view .status-button {
        padding: 0.1rem 0.6rem;
    }

    .compact-view .calendar-btn {
        padding: 0.1rem 0.3rem;
    }

    .compact-view .icon-container {
        margin-right: 0.1rem;  /* Reduced spacing for compact view */
    }

    /* Ensure icon size stays consistent */
    .compact-view .fa-walking,
    .compact-view .fa-person {
        font-size: calc(0.8rem * var(--base-scale)); /* Fixed size regardless of view */
    }

    /* Variable Größenkontrolle */
    :root {
        --base-scale: 1;
        --min-scale: 0.8;
        --max-scale: 1.4;
        --scale-step: 0.1;
    }

    .station-card {
        font-size: calc(1rem * var(--base-scale));
    }

    .participant-item {
        padding: calc(0.5rem * var(--base-scale));
    }

    .status-button {
        font-size: calc(0.8rem * var(--base-scale));
        padding: calc(0.2rem * var(--base-scale)) calc(0.8rem * var(--base-scale));
    }

    .participant-name {
        font-size: calc(0.9rem * var(--base-scale));
    }


    .calendar-btn {
        font-size: calc(0.8rem * var(--base-scale));
    }

    .fa-calendar-alt, .fa-times, .fa-check {
        font-size: calc(0.8rem * var(--base-scale));
    }

    .summary-header {
        border-radius: 8px !important; /* Override the station-header border-radius */
        border-bottom: none; /* Remove the border that separates header from content */
    }

    .week-container.participants-list {
        display: block !important; /* Override grid layout from compact view */
        padding: 10px;
    }

    .week-container .week {
        width: 100%;
        justify-content: space-between;
        margin: 0;
    }

    .week-container .calendar-day {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
    }

    .week-container .day-green { 
        background-color: #a9e6b7; 
        cursor: pointer;
    }

    .week-container .day-red { 
        background-color: #f8bfc3;
        cursor: pointer;
    }

    .week-container .day-gray { 
        background-color: #e9ecef;
    }

    .week-container .day-today {
        border: 2px solid #0d6efd;  /* Keep the highlight border */
        transform: none;  /* Remove any transform that might affect size */
        font-size: inherit;  /* Ensure consistent font size */
    }

    .week-container .selected-day {
        border: 2px solid #0d6efd !important;
        transform: scale(1.1);
        transition: transform 0.2s;
    }

    .week-container .day-label {
        font-size: 0.8em;
        font-weight: bold;
        color: #000000;
        order: -1;
    }

    .week-container .day-number {
        font-weight: bold;
        color: #000000;
        margin-top: -2px;
        font-size: 1em;
    }

</style>

<script>
    let currentParticipantId = null;
    let lastUpdateTimestamp = 0;
    const UPDATE_THRESHOLD = 1000; // Minimum time (ms) between updates
    let globalEventSource = null;
    const animationQueue = new Map(); // Store queues for each participant
    let isStatusUpdateInProgress = false;
    let isPageVisible = !document.hidden;
    let isWalkingBusDay = false;
    const WEEKDAY_MAPPING = {
        0: 'monday',
        1: 'tuesday',
        2: 'wednesday',
        3: 'thursday',
        4: 'friday',
        5: 'saturday',
        6: 'sunday'
    };


    document.addEventListener('DOMContentLoaded', async () => {
        // Create and insert alert container
        const alertsContainer = document.createElement('div');
        alertsContainer.id = 'alerts-container';
        alertsContainer.innerHTML = `
            <div id="connection-alert" class="alert alert-danger d-none" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Die Verbindung zum Server wurde unterbrochen. Die angezeigten Daten sind möglicherweise nicht aktuell.
            </div>
            <div id="walkingbus-alert" class="alert alert-info d-none" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="walkingbus-reason"></span>
                </div>
            </div>
            <div id="note-alert" class="alert alert-warning d-none" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-sticky-note me-2"></i>
                    <span id="walkingbus-note"></span>
                </div>
            </div>
        `;

        const stationsDiv = document.getElementById('stations');
        stationsDiv.parentNode.insertBefore(alertsContainer, stationsDiv);

        // Initialize IndexedDB first
        await initDB();
        
        // Initialize data and connections
        initializeSSE();
        console.log('SSE initialization completed');

        // Initialize view toggle
        console.log('Initializing size controls...');
        initializeSizeControls();

        // Setup modal handling
        const modal = document.getElementById('calendarModal');
        const span = document.getElementsByClassName('close')[0];

        span.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // Add offline/online handlers
        window.addEventListener('online', () => {
            loadStations();
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus('disconnected');
        });
    });



    // First, create a promise for database initialization
    let dbPromise;

    function initDB() {
        dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open('WalkingBusDB', 3);
            
            request.onerror = () => reject(request.error);
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                resolve(db);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                // Add existing stores
                if (!db.objectStoreNames.contains('stationsData')) {
                    db.createObjectStore('stationsData', { keyPath: 'timestamp' });
                }
                if (!db.objectStoreNames.contains('participantStates')) {
                    db.createObjectStore('participantStates', { keyPath: 'id' });
                }
                // Add new store for calendar data
                if (!db.objectStoreNames.contains('calendarData')) {
                    db.createObjectStore('calendarData', { keyPath: ['participantId', 'date'] });
                }
            };
        });
        return dbPromise;
    }


    async function loadStations(previousStates = null, selectedDate = null) {
        const now = Date.now();
        if (now - lastUpdateTimestamp < UPDATE_THRESHOLD) {
            return;
        }
        lastUpdateTimestamp = now;

        try {
            const db = await dbPromise;

            // Schedule validation with error handling
            const scheduleResponse = await axios.get('/api/walking-bus-schedule');
            const schedule = scheduleResponse?.data;
            
            if (schedule) {
                const missingTimes = Object.entries(schedule)
                    .filter(([_, dayData]) => dayData?.active && (!dayData?.start || !dayData?.end))
                    .map(([day, _]) => day);
                    
                if (missingTimes.length > 0) {
                    const alertsContainer = document.getElementById('alerts-container');
                    if (alertsContainer) {
                        alertsContainer.innerHTML = `
                            <div class="alert alert-warning" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Bitte konfigurieren Sie die Zeiten für folgende Tage: 
                                ${missingTimes.map(day => day.charAt(0).toUpperCase() + day.slice(1)).join(', ')}
                            </div>
                        `;
                    }
                    updateConnectionStatus('connected');
                    return;
                }
            }

            // Load and validate live data with selected date
            const dailyStatusResponse = await axios.post('/api/initialize-daily-status', {
                date: selectedDate || new Date().toISOString().split('T')[0]
            });
            const dailyStatus = dailyStatusResponse?.data;

            if (!dailyStatus) {
                throw new Error('No daily status data received');
            }

            const validatedDailyStatus = {
                currentDate: dailyStatus.currentDate || new Date().toISOString(),
                isWalkingBusDay: Boolean(dailyStatus.isWalkingBusDay),
                reason: dailyStatus.reason || '',
                note: dailyStatus.note || ''
            };

            isWalkingBusDay = validatedDailyStatus.isWalkingBusDay;
            
            // Get stations data for selected date
            const stationsResponse = await axios.get('/api/stations', {
                params: { date: selectedDate || new Date().toISOString().split('T')[0] }
            });
            const stations = Array.isArray(stationsResponse?.data) ? stationsResponse.data : [];
            
            if (stations.length === 0) {
                throw new Error('No valid stations data received');
            }

            await renderStations(stations, isWalkingBusDay, dailyStatus, selectedDate);
            
            // Cache validated data
            const transaction = db.transaction(['participantStates'], 'readwrite');
            const store = transaction.objectStore('participantStates');
            
            stations.forEach(station => {
                if (Array.isArray(station?.participants)) {
                    station.participants.forEach(participant => {
                        if (participant?.id) {
                            store.put({
                                id: participant.id,
                                today_status: Boolean(participant.today_status),
                                date: selectedDate || new Date().toISOString().split('T')[0]
                            });
                        }
                    });
                }
            });

            const stationsTransaction = db.transaction(['stationsData'], 'readwrite');
            const stationsStore = stationsTransaction.objectStore('stationsData');
            await stationsStore.put({
                timestamp: 'latest',
                stations: stations,
                isWalkingBusDay: isWalkingBusDay,
                dailyStatus: dailyStatus,
                selectedDate: selectedDate
            });

            updateConnectionStatus('connected');

        } catch (error) {
            console.error('Error loading stations:', error);
            updateConnectionStatus('disconnected');

            // Enhanced cached data handling
            try {
                const db = await dbPromise;
                const tx = db.transaction(['stationsData'], 'readonly');
                const store = tx.objectStore('stationsData');
                const cachedData = await store.get('latest');

                if (cachedData?.stations && Array.isArray(cachedData.stations)) {
                    await renderStations(
                        cachedData.stations,
                        Boolean(cachedData.isWalkingBusDay),
                        {
                            ...cachedData.dailyStatus,
                            currentDate: cachedData.dailyStatus?.currentDate || new Date().toISOString()
                        }
                    );
                    
                    // Restore selected date in week overview
                    if (cachedData.selectedDate) {
                        await renderWeekOverview(cachedData.selectedDate);
                    }
                }
            } catch (dbError) {
                console.error('Error accessing cached data:', dbError);
            }
        }
    }


    async function renderWeekOverview(selectedDate = null) {
        const response = await axios.get('/api/week-overview');
        const weekData = response.data;
        console.log('Week Data:', weekData);
        
        // weekData.forEach(day => {
        //     console.log('Day data passed to getWeekDayClass:', day);  // Add this line
        // });

        const weekOverview = document.createElement('div');
        weekOverview.className = 'week d-flex justify-content-between';
        weekOverview.innerHTML = weekData.map(day => `
            <div class="calendar-day ${getWeekDayClass(day)} 
                        ${day.date === selectedDate ? 'selected-day' : ''}"
                 data-date="${day.date}"
                 onclick="selectDay('${day.date}')">
                <div class="day-number">${day.total_confirmed}</div>
                <div class="day-label">${getDayLabel(day.date)}</div>
            </div>
        `).join('');
        
        const weekContainer = document.querySelector('.week-container');
        if (weekContainer) {
            weekContainer.innerHTML = '';
            weekContainer.appendChild(weekOverview);
        }
    }

    function getWeekDayClass(day) {
        if (day.is_today) {
            return 'day-today';
        }

        if (!day.is_active) {
            return 'day-gray';
        }

        // For active days, always return green (we don't care about confirmations here)
        return 'day-green';
    }

    function getDayLabel(dateStr) {
        const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        const date = new Date(dateStr);
        return days[date.getDay()];
    }

    // Funktion zum Auswählen eines Tages
    async function selectDay(dateStr) {
        const allDays = document.querySelectorAll('.calendar-day');
        allDays.forEach(day => day.classList.remove('selected-day'));
        
        const selectedDay = document.querySelector(`[data-date="${dateStr}"]`);
        selectedDay.classList.add('selected-day');
        
        // Lade Stationen für das ausgewählte Datum
        await loadStations(null, dateStr);
    }


    async function renderStations(stations, isWalkingBusDay, dailyStatus, selectedDate = null) {
       console.log('Before filtering:', stations);
       stations = stations.filter(station => station.id !== "unassigned");
       console.log('After filtering:', stations);
        const walkingbusAlert = document.getElementById('walkingbus-alert');
        const walkingbusReason = document.getElementById('walkingbus-reason');
        const noteAlert = document.getElementById('note-alert');
        const walkingbusNote = document.getElementById('walkingbus-note');

            // If no selectedDate is provided, get it from the UI or use today's date
        const effectiveDate = selectedDate || 
                             document.querySelector('.selected-day')?.dataset.date || 
                             new Date().toISOString().split('T')[0];

        // Get status with reason from server
        const serverDate = new Date(dailyStatus.currentDate);

        // Show/hide alert and set reason
        walkingbusAlert.classList.toggle('d-none', isWalkingBusDay);
        if (!isWalkingBusDay && dailyStatus.reason) {
            walkingbusReason.textContent = dailyStatus.reason;
        }

        // Show/hide note alert and set note
        noteAlert.classList.toggle('d-none', !dailyStatus.note);
        if (dailyStatus.note) {
            walkingbusNote.textContent = dailyStatus.note;
        }

        stations = stations.filter(station => station.id !== "unassigned");
        const stationsContainer = document.getElementById('stations');
        stationsContainer.innerHTML = '';

        // Create and add summary card first
        const summaryCard = document.createElement('div');
        summaryCard.classList.add('station-card');
        summaryCard.id = 'summary-card';
        
        // Calculate total stats
        const totalParticipants = stations.reduce((sum, station) => 
            sum + station.participants.length, 0);
        const confirmedParticipants = isWalkingBusDay ? 
            stations.reduce((sum, station) => 
                sum + station.participants.filter(p => p.today_status).length, 0) : 0;

        // Create summary card content
        summaryCard.innerHTML = `
            <div class="station-header summary-header">
                <h5 class="d-flex justify-content-between align-items-center mb-0">
                    <span>
                        ${formatServerDate(serverDate)}
                    </span>
                    <span class="badge bg-light text-dark" id="stats-total">
                        ${confirmedParticipants} / ${totalParticipants}
                    </span>
                </h5>
            </div>
            <div class="week-container list-group list-group-flush participants-list">
                <!-- Week overview will be inserted here -->
            </div>
        `;
        
        stationsContainer.appendChild(summaryCard);
        await renderWeekOverview(effectiveDate);

        for (const station of stations) {
            console.log('Station participants:', station.participants);
            const stationDiv = document.createElement('div');
            stationDiv.classList.add('station-card');
            stationDiv.innerHTML = createStationHeader(station, isWalkingBusDay);

            const list = document.createElement('ul');
            list.classList.add('list-group', 'list-group-flush', 'participants-list');
            list.dataset.stationId = station.id;

            for (const participant of station.participants) {
                console.log('Participant data:', participant);
                const item = await createParticipantItem(participant, isWalkingBusDay);
                const nameSpan = createNameSpan(participant, isWalkingBusDay);
                const buttonContainer = document.createElement('div');
                buttonContainer.classList.add('d-flex', 'align-items-center');

                const statusButton = createStatusButton(participant, isWalkingBusDay);
                const calendarButton = document.createElement('button');
                calendarButton.classList.add('calendar-btn');
                calendarButton.innerHTML = '<i class="fas fa-calendar-alt"></i>';
                calendarButton.onclick = (e) => {
                    e.stopPropagation();
                    openCalendar(participant.id);
                };

                buttonContainer.append(statusButton, calendarButton);
                item.append(nameSpan, buttonContainer);
                list.appendChild(item);
            }

            stationDiv.appendChild(list);
            stationsContainer.appendChild(stationDiv);
        }
    }

    function formatServerDate(date) {
        const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        const dayName = days[date.getDay()];
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${dayName}, ${day}.${month}.${year}`;
    }

    function createStationHeader(station, isWalkingBusDay) {
        return `
            <div class="station-header">
                <h5 class="d-flex justify-content-between align-items-center mb-0">
                    <span>
                        <i class="fas fa-bus-simple me-2"></i>
                        ${station.name}
                    </span>
                    <span class="badge bg-light text-dark" id="stats-station-${station.id}">
                        ${getStationStats(station)}
                    </span>
                </h5>
            </div>`;
    }

    async function createParticipantItem(participant, isWalkingBusDay) {
        const item = document.createElement('li');
        item.classList.add(
            'list-group-item',
            'py-1',
            'd-flex',
            'justify-content-between',
            'align-items-center',
            'participant-item'
        );
        
        if (isWalkingBusDay) {
            item.classList.add(participant.status ? 'participant-status-active' : 'participant-status-inactive');
        } else {
            item.classList.add('participant-status-disabled');
        }
        
        item.dataset.participantId = participant.id;
        return item;
    }

    function initializeSizeControls() {
        const slider = document.getElementById('fontSizeSlider');
        const stationsContainer = document.getElementById('stations');
        const COMPACT_THRESHOLD = 1.05; // Threshold for switching to compact view
        
        // Add debug logging
        console.log('Found slider:', slider);
        console.log('Found stations container:', stationsContainer);
        
        // Load saved scale
        const savedScale = localStorage.getItem('cardScale') || 1;
        document.documentElement.style.setProperty('--base-scale', savedScale);
        slider.value = savedScale;
        
        // Initial layout check
        checkLayoutMode(savedScale);
        
        // Add both 'input' and 'change' events for better response
        ['input', 'change'].forEach(eventType => {
            slider.addEventListener(eventType, (e) => {
                console.log('Slider value changed:', e.target.value); // Debug log
                const newScale = parseFloat(e.target.value);
                document.documentElement.style.setProperty('--base-scale', newScale);
                localStorage.setItem('cardScale', newScale);
                
                // Check if we need to switch layout
                checkLayoutMode(newScale);
            });
        });
        
        function checkLayoutMode(scale) {
            console.log('Checking layout mode. Scale:', scale); // Debug log
            if (scale <= COMPACT_THRESHOLD) {
                stationsContainer.classList.add('compact-view');
            } else {
                stationsContainer.classList.remove('compact-view');
            }
        }
    }


    function initializeViewToggle() {
        const viewToggle = document.getElementById('viewToggle');
        const stationsContainer = document.getElementById('stations');
        
        // Load saved preference
        const isCompactView = localStorage.getItem('compactView') === 'true';
        if (isCompactView) {
            stationsContainer.classList.add('compact-view');
            viewToggle.innerHTML = '<i class="fas fa-expand"></i>';
        }
        
        viewToggle.addEventListener('click', () => {
            stationsContainer.classList.toggle('compact-view');
            const isNowCompact = stationsContainer.classList.contains('compact-view');
            
            // Update button icon
            viewToggle.innerHTML = isNowCompact ? 
                '<i class="fas fa-expand"></i>' : 
                '<i class="fas fa-compress"></i>';
                
            // Save preference
            localStorage.setItem('compactView', isNowCompact);
        });
    }


    function createNameSpan(participant, isWalkingBusDay) {
        const nameSpan = document.createElement('span');
        nameSpan.classList.add('text-truncate', 'me-2', 'participant-name');

        const iconContainer = document.createElement('span');
        iconContainer.classList.add('icon-container');

        const currentIcon = document.createElement('i');
        currentIcon.classList.add('fas', 'traffic-light', 'current-icon');

        const nextIcon = document.createElement('i');
        nextIcon.classList.add('fas', 'traffic-light', 'next-icon');

        if (!isWalkingBusDay) {
            currentIcon.classList.add('fa-person', 'icon-disabled');
            nextIcon.classList.add('fa-person', 'icon-disabled');
        } else {
            currentIcon.classList.add(
                participant.status ? 'fa-walking' : 'fa-person',
                participant.status ? 'icon-active' : 'icon-inactive'
            );
            nextIcon.classList.add(
                participant.status ? 'fa-person' : 'fa-walking',
                participant.status ? 'icon-inactive' : 'icon-active'
            );
        }

        iconContainer.appendChild(currentIcon);
        iconContainer.appendChild(nextIcon);
        nameSpan.appendChild(iconContainer);
        nameSpan.appendChild(document.createTextNode(participant.name));
        return nameSpan;
    }

    function createStatusButton(participant, isWalkingBusDay) {
        const button = document.createElement('button');
        button.classList.add(
            'btn', 
            'btn-sm', 
            'rounded-pill', 
            'status-button',
            'touch-target'
        );

        if (!isWalkingBusDay) {
            button.classList.add('btn-outline-secondary', 'status-button-disabled');
            button.innerHTML = '<i class="fas fa-times"></i>';
            button.disabled = true;
        } else {
            // Use the status field from our API response
            button.classList.add(participant.status ? 'btn-outline-success' : 'btn-outline-danger');
            button.innerHTML = participant.status ? 
                '<i class="fas fa-check"></i>' : 
                '<i class="fas fa-times"></i>';
            button.onclick = (e) => {
                e.preventDefault();
                toggleParticipation(participant.id, button);
            };
        }

        return button;
    }


    function getStationStats(station) {
        const totalParticipants = station.participants.length;
        const confirmedParticipants = isWalkingBusDay ? 
            station.participants.filter(p => p.today_status).length : 0;
        return `${confirmedParticipants} / ${totalParticipants}`;
    }

    function updateStationStats(stationId) {
        fetchWithAuth(`/api/stations/${stationId}/stats`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Update individual station stats
                const statsElement = document.getElementById(`stats-station-${stationId}`);
                if (statsElement) {
                    statsElement.textContent = `${data.active} / ${data.total}`;
                }
                
                // Update total stats
                return fetchWithAuth('/api/stations/stats/total');
            })
            .then(response => response.json())
            .then(totalData => {
                const totalStats = document.getElementById('stats-total');
                if (totalStats) {
                    totalStats.textContent = `${totalData.active} / ${totalData.total}`;
                }
            })
            .catch(error => {
                console.error('Stats update failed:', error);
                // Optionally update UI to show error state
            });
    }

    async function toggleParticipation(participantId, button) {
        if (isStatusUpdateInProgress) return;

        // Get currently selected date from week overview
        const selectedDate = document.querySelector('.selected-day')?.dataset.date || new Date().toISOString().split('T')[0];
        
        isStatusUpdateInProgress = true;
        const allStatusButtons = document.querySelectorAll('.status-button');
        allStatusButtons.forEach(btn => btn.disabled = true);
        
        const originalButtonContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
             const response = await axios.patch(`/api/participation/${participantId}`, {
                date: selectedDate
            });
            
            // Keep selected date when reloading stations
            await loadStations(null, selectedDate);
            
            const participantItem = document.querySelector(`[data-participant-id="${participantId}"]`);
            if (participantItem) {
                await animateStatusChange(participantItem, response.data.status_today);
            }
        } catch (error) {
            console.error('Error updating status:', error);
            button.disabled = false;
            button.innerHTML = originalButtonContent;
            
            // Add warning indicator
            const warningIcon = document.createElement('i');
            warningIcon.classList.add('fas', 'fa-exclamation-triangle', 'warning-icon');
            warningIcon.title = 'Änderung fehlgeschlagen. Bitte erneut versuchen.';
            
            const buttonContainer = button.parentElement;
            buttonContainer.insertBefore(warningIcon, buttonContainer.firstChild);
            
            // Remove warning after 5 seconds
            setTimeout(() => {
                warningIcon.remove();
            }, 5000);
        } finally {
            isStatusUpdateInProgress = false;
            allStatusButtons.forEach(btn => btn.disabled = false);
        }
    }

    async function openCalendar(participantId) {
        currentParticipantId = participantId;
        const modal = document.getElementById('calendarModal');

        // Get participant name directly using the participant ID
       const participantItem = document.querySelector(`[data-participant-id="${participantId}"]`);
       const participantName = participantItem.querySelector('.text-truncate').textContent.trim();

        const modalContent = modal.querySelector('.modal-content');
        modalContent.innerHTML = `
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <span class="close" onclick="document.getElementById('calendarModal').style.display='none'">×</span>
                <h4 class="mb-0 ms-3">${participantName}</h4>
            </div>
            <div id="calendar"></div>
        `;

        try {
            // Try online first
            const response = await fetchWithAuth(`/api/calendar-data/${participantId}`);
            if (response.ok) {
                const calendarData = await response.json();
                // Store in IndexedDB for offline use
                const db = await dbPromise;
                const tx = db.transaction('calendarData', 'readwrite');
                const store = tx.objectStore('calendarData');
                
                for (const day of calendarData) {
                    await store.put({
                        participantId,
                        date: day.date,
                        status: day.status,
                        is_schedule_day: day.is_schedule_day,
                        is_past: day.is_past,
                        is_today: day.is_today
                    });
                }
                await renderCalendar(calendarData);
            } else {
                throw new Error('Network response was not ok');
            }
           } catch (error) {
               // Offline path - enhance data transformation
               const db = await dbPromise;
               const tx = db.transaction('calendarData', 'readonly');
               const store = tx.objectStore('calendarData');
               const range = IDBKeyRange.bound([participantId, ""], [participantId, "\uffff"]);
               
               const offlineData = await new Promise((resolve, reject) => {
                   const request = store.getAll(range);
                   request.onsuccess = () => resolve(request.result);
                   request.onerror = () => reject(request.error);
               });

               // Get current participant's status for today
               const participantItem = document.querySelector(`.participant-item[data-participant-id="${participantId}"]`);
               const currentStatus = participantItem?.classList.contains('participant-status-active') || false;
               const today = new Date().toISOString().split('T')[0];

               // Transform offline data with special handling for today
               const transformedData = offlineData.map(item => {
                   const isToday = item.date === today;
                   return {
                       date: item.date,
                       // Use current status for today, stored status for other days
                       status: isToday ? currentStatus : item.status,
                       // Ensure weekdays (including today) are always schedule days
                       is_schedule_day: new Date(item.date).getDay() !== 0 && new Date(item.date).getDay() !== 6,
                       is_past: new Date(item.date) < new Date(),
                       is_today: isToday
                   };
               });

               await renderCalendar(transformedData);
           }

        modal.style.display = 'block';
    }



    async function initializeDailyStatus() {
        try {
            const response = await axios.post('/api/initialize-daily-status');
            return response.data.currentDate;
        } catch (error) {
            console.error('Error initializing daily status:', error);
        }
    }

    async function renderCalendar(calendarData) {
         // Get current selected date or use today's date
        const selectedDate = document.querySelector('.selected-day')?.dataset.date || new Date().toISOString().split('T')[0];
        // Get daily status from server
        const dailyStatusResponse = await axios.post('/api/initialize-daily-status', {
            date: selectedDate
        });
        const dailyStatus = dailyStatusResponse.data;
        
        if (!calendarData || !calendarData.length) {
            console.error('No calendar data available');
            return;
        }
        
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';

        // Create weekday header row
        const weekdayHeader = document.createElement('div');
        weekdayHeader.className = 'week';
        const weekdays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
        
        weekdays.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            weekdayHeader.appendChild(dayHeader);
        });
        calendar.appendChild(weekdayHeader);

        // Get current participant's status
        const participantItem = document.querySelector(`.participant-item[data-participant-id="${currentParticipantId}"]`);
        const currentStatus = participantItem?.classList.contains('participant-status-active') || false;

        // Set up calendar grid starting point
        const firstDate = new Date(calendarData[0].date);
        const startOfWeek = new Date(firstDate);
        startOfWeek.setDate(firstDate.getDate() - firstDate.getDay() + 1);

        // Generate calendar weeks
        for (let weekIndex = 0; weekIndex < 4; weekIndex++) {
            const weekDiv = document.createElement('div');
            weekDiv.className = 'week';

            // Generate days within each week
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                const currentDate = new Date(startOfWeek);
                currentDate.setDate(startOfWeek.getDate() + (weekIndex * 7) + dayIndex);
                const dateStr = currentDate.toISOString().split('T')[0];

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = currentDate.getDate();

                // Combine server data with local date checks
                const dayData = calendarData.find(d => d.date === dateStr) || {
                    date: dateStr,
                    status: false,
                    is_schedule_day: currentDate.getDay() !== 0 && currentDate.getDay() !== 6,
                    is_past: currentDate < new Date(new Date().setHours(0,0,0,0)),
                    is_today: dateStr === dailyStatus.currentDate
                };

                // Determine day state using combined logic
                const shouldDisableDay = 
                    !dayData.is_schedule_day || 
                    dayData.is_past || 
                    (dayData.is_today && !dailyStatus.isWalkingBusDay);

                if (shouldDisableDay) {
                    dayDiv.classList.add('day-gray');
                } else {
                    dayDiv.classList.add(dayData.status ? 'day-green' : 'day-red');
                    dayDiv.onclick = () => CalendarToggleDayStatus(currentParticipantId, dateStr, dayDiv);
                }

                // Mark today's date
                if (dayData.is_today) {
                    dayDiv.classList.add('day-today');
                }

                weekDiv.appendChild(dayDiv);
            }
            calendar.appendChild(weekDiv);
        }
    }




    async function CalendarToggleDayStatus(participantId, dateString, dayDiv) {
        if (isStatusUpdateInProgress) return;
        
        isStatusUpdateInProgress = true;
        const allStatusButtons = document.querySelectorAll('.status-button, .calendar-day');
        allStatusButtons.forEach(btn => btn.disabled = true);
        
        const originalContent = dayDiv.textContent;
        dayDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            await axios.post('/api/calendar-status', {
                participant_id: participantId,
                date: dateString,
                status: !dayDiv.classList.contains('day-green')
            });
            
            await loadStations();
            
            // Instead of reopening the calendar, just update its content
            const calendarData = await axios.get(`/api/calendar-data/${participantId}`);
            await renderCalendar(calendarData.data);
            
            // Animate if it's today's change
            const today = new Date().toISOString().split('T')[0];
            if (dateString === today) {
                const participantItem = document.querySelector(`[data-participant-id="${participantId}"]`);
                if (participantItem) {
                    await animateStatusChange(participantItem, !dayDiv.classList.contains('day-green'));
                }
            }
        } catch (error) {
            console.error('Error updating calendar status:', error);
            dayDiv.textContent = originalContent;
            
            // Add warning indicator
            const warningIcon = document.createElement('i');
            warningIcon.classList.add('fas', 'fa-exclamation-triangle', 'warning-icon');
            warningIcon.title = 'Änderung fehlgeschlagen. Bitte erneut versuchen.';
            
            dayDiv.appendChild(warningIcon);
            
            // Remove warning after 5 seconds
            setTimeout(() => {
                warningIcon.remove();
                dayDiv.textContent = originalContent;
            }, 5000);
        } finally {
            isStatusUpdateInProgress = false;
            allStatusButtons.forEach(btn => btn.disabled = false);
        }
    }


    async function animateStatusChange(element, newStatus) {
        return new Promise(resolve => {
            const animationClass = newStatus ? 'inactive-to-active' : 'active-to-inactive';
            element.addEventListener('animationend', () => {
                element.classList.remove(animationClass);
                resolve();
            }, {once: true});
            element.classList.add(animationClass);
        });
    }



    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let isReconnecting = false;

    // Modify initializeSSE to handle mobile focus better
    function initializeSSE() {
        console.log('Starting SSE connection...');
        
        if (globalEventSource) {
            globalEventSource.close();
        }
        
        let connectionAlertTimeout;
        const alertDelay = 10000;
        
        try {
            globalEventSource = new EventSource('/stream');
            
            globalEventSource.onmessage = function(event) {
                (async () => {
                    console.log('Received SSE update:', event.data);
                    const data = JSON.parse(event.data);
                    if (data.time) {
                        document.getElementById('current-time').textContent = data.time;
                    }

                    // Get currently selected date before update
                    const selectedDate = document.querySelector('.selected-day')?.dataset.date;

                    // Get previous states before updating
                    const db = await dbPromise;
                    const previousStates = await getPreviousStates(db);

                    // Pass selected date to loadStations
                    await loadStations(previousStates, selectedDate);
                    updateConnectionStatus('connected');
                    reconnectAttempts = 0;
                    isReconnecting = false;
                    if (connectionAlertTimeout) {
                        clearTimeout(connectionAlertTimeout);
                        connectionAlertTimeout = null;
                    }
                })();
            };

            globalEventSource.addEventListener('error', (event) => {
                console.error('SSE connection error:', event);
                updateConnectionStatus('disconnected');
                
                if (!isReconnecting && reconnectAttempts < maxReconnectAttempts) {
                    isReconnecting = true;
                    reconnectAttempts++;
                    
                    setTimeout(() => {
                        console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                        isReconnecting = false;
                        globalEventSource.close();
                        initializeSSE();
                    }, 5000 * reconnectAttempts);
                } else if (reconnectAttempts >= maxReconnectAttempts) {
                    const connectionAlert = document.getElementById('connection-alert');
                    connectionAlert.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Die Verbindung zum Server wurde unterbrochen.
                    `;
                    connectionAlert.classList.remove('d-none');
                    globalEventSource.close();
                }
            });

            // Mobile-specific event listeners
            document.addEventListener('focus', handlePageFocus);
            document.addEventListener('resume', handlePageFocus);
            
            function handlePageFocus() {
                if (!isReconnecting) {
                    loadStations();
                }
                if (connectionAlertTimeout) {
                    clearTimeout(connectionAlertTimeout);
                    connectionAlertTimeout = null;
                }
            }
        } catch (error) {
            console.error('SSE initialization failed:', error);
            updateConnectionStatus('disconnected');
        }

        return globalEventSource;
    }



    // Add visibility change handling for mobile users
    document.addEventListener('visibilitychange', () => {
        isPageVisible = !document.hidden;
        
        if (!document.hidden) {
            // Clear any existing alert immediately
            const connectionAlert = document.getElementById('connection-alert');
            connectionAlert.classList.add('d-none');
            
            // Force data refresh
            loadStations();
            
            // Reset SSE connection
            if (eventSource) {
                eventSource.close();
            }
            initializeSSE();
            
        }
    });


    function updateConnectionStatus(status) {
        const connectionAlert = document.getElementById('connection-alert');
        const connectionIndicator = document.querySelector('.connection-indicator');
        
        // Only update alert if element exists and page is visible
        if (connectionAlert && !document.hidden) {
            connectionAlert.classList.toggle('d-none', status === 'connected');
        }
        
        // Only update indicator if element exists
        if (connectionIndicator) {
            connectionIndicator.classList.remove('connected', 'disconnected');
            connectionIndicator.classList.add(status === 'connected' ? 'connected' : 'disconnected');
        }
    }

    // Helper function to get previous states
    async function getPreviousStates(db) {
        return new Promise((resolve) => {
            const transaction = db.transaction(['participantStates'], 'readonly');
            const store = transaction.objectStore('participantStates');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const states = {};
                request.result.forEach(item => {
                    states[item.id] = item;
                });
                resolve(states);
            };
            
            request.onerror = () => resolve({});
        });
    }
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
{% endblock %}
