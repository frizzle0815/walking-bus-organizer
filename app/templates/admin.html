{% extends "base.html" %}

{% block content %}
<h1 class="text-center">Administration</h1>

<div class="mt-5">
    <!-- Tabelle für Stationen und Teilnehmer -->
    <table id="adminTable" class="table table-striped">
        <thead>
            <tr>
                <th>Station/Teilnehmer</th>
                <th>Aktionen</th>
                <th>Montag</th>
                <th>Dienstag</th>
                <th>Mittwoch</th>
                <th>Donnerstag</th>
                <th>Freitag</th>
            </tr>
        </thead>
        <tbody id="sortableTableBody">
            <!-- Dynamische Inhalte -->
        </tbody>
    </table>

    <!-- Buttons für Aktionen -->
    <button id="addStationBtn" class="btn btn-primary">+ Station</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.getElementById('sortableTableBody');

        // Backend-Daten abrufen und initialisieren
        fetch('/api/stations')
            .then(response => response.json())
            .then(data => {
                data.forEach(station => addStation(station.name, station.id, station.participants));
            });

        // SortableJS initialisieren für Drag-and-Drop
        new Sortable(tableBody, {
            animation: 150,
            handle: '.drag-handle',
            onEnd: () => updateOrder(),
        });

        // Station hinzufügen
        document.getElementById('addStationBtn').addEventListener('click', () => {
            addStation();
        });

        function addStation(name = '', stationId = null, participants = []) {
            const stationRow = document.createElement('tr');
            stationRow.classList.add('station-row');
            stationRow.innerHTML = `
                <td>
                    <span class="drag-handle">☰</span>
                    <input type="text" class="form-control station-name" value="${name}" placeholder="Station eingeben">
                </td>
                <td>
                    <button class="btn btn-success add-participant">+ Teilnehmer</button>
                    <button class="btn btn-danger remove-station">- Station</button>
                </td>
                <td colspan="5"></td>
            `;
            tableBody.appendChild(stationRow);

            participants.forEach(participant => {
                addParticipant(stationRow, participant.name, participant.id, participant.days);
            });

            stationRow.querySelector('.add-participant').addEventListener('click', () => {
                addParticipant(stationRow);
            });

            stationRow.querySelector('.remove-station').addEventListener('click', () => {
                if (confirm('Möchten Sie diese Station wirklich löschen?')) {
                    if (stationId) {
                        fetch(`/admin/stations/${stationId}/delete`, { method: 'POST' });
                    }
                    tableBody.removeChild(stationRow);
                }
            });
        }

        function addParticipant(stationRow, name = '', participantId = null, days = {}) {
            const participantRow = document.createElement('tr');
            participantRow.classList.add('participant-row');
            participantRow.innerHTML = `
                <td style="padding-left: 2rem;">
                    <input type="text" class="form-control participant-name" value="${name}" placeholder="Teilnehmer eingeben">
                </td>
                <td>
                    <button class="btn btn-danger remove-participant">- Teilnehmer</button>
                </td>
                ${['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
                    .map(day => `<td><input type="checkbox" class="${day}" ${days[day] ? 'checked' : ''}></td>`)
                    .join('')}
            `;
            stationRow.after(participantRow);

            participantRow.querySelector('.remove-participant').addEventListener('click', () => {
                if (confirm('Möchten Sie diesen Teilnehmer wirklich löschen?')) {
                    if (participantId) {
                        fetch(`/admin/participants/${participantId}/delete`, { method: 'POST' });
                    }
                    participantRow.remove();
                }
            });
        }

        function updateOrder() {
            const stations = [];
            document.querySelectorAll('.station-row').forEach(stationRow => {
                const station = {
                    name: stationRow.querySelector('.station-name').value,
                    participants: [],
                };
                let currentRow = stationRow.nextElementSibling;
                while (currentRow && currentRow.classList.contains('participant-row')) {
                    station.participants.push({
                        name: currentRow.querySelector('.participant-name').value,
                        days: {
                            monday: currentRow.querySelector('.monday').checked,
                            tuesday: currentRow.querySelector('.tuesday').checked,
                            wednesday: currentRow.querySelector('.wednesday').checked,
                            thursday: currentRow.querySelector('.thursday').checked,
                            friday: currentRow.querySelector('.friday').checked,
                        },
                    });
                    currentRow = currentRow.nextElementSibling;
                }
                stations.push(station);
            });

            fetch('/admin/stations/update_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(stations),
            });
        }
    });
</script>
{% endblock %}
