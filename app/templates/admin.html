{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="container-fluid px-2">
    <h1 class="h3 text-center my-3">Walking Bus Administration</h1>

    <!-- Walking Bus Schedule -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Walking Bus Schedule</h5>
        </div>
            <div class="card-body">
             <div class="schedule-container">
                 <div class="days-row d-flex justify-content-between mb-3">
                     <!-- Monday -->
                     <div class="day-column text-center">
                         <div class="form-check">
                             <input type="checkbox" class="form-check-input schedule-day" id="schedule-monday" data-day="monday">
                             <label class="form-check-label" for="schedule-monday">Mo</label>
                         </div>
                         <div class="time-inputs mt-2" id="monday-times">
                             <input type="time" class="form-control time-input start-time mb-1" 
                                    data-day="monday" 
                                    id="monday-start"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                             <input type="time" class="form-control time-input end-time" 
                                    data-day="monday" 
                                    id="monday-end"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                         </div>
                     </div>
         
                     <!-- Tuesday -->
                     <div class="day-column text-center">
                         <div class="form-check">
                             <input type="checkbox" class="form-check-input schedule-day" id="schedule-tuesday" data-day="tuesday">
                             <label class="form-check-label" for="schedule-tuesday">Di</label>
                         </div>
                         <div class="time-inputs mt-2" id="tuesday-times">
                             <input type="time" class="form-control time-input start-time mb-1" 
                                    data-day="tuesday" 
                                    id="tuesday-start"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                             <input type="time" class="form-control time-input end-time" 
                                    data-day="tuesday" 
                                    id="tuesday-end"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                         </div>
                     </div>
         
                     <!-- Wednesday -->
                     <div class="day-column text-center">
                         <div class="form-check">
                             <input type="checkbox" class="form-check-input schedule-day" id="schedule-wednesday" data-day="wednesday">
                             <label class="form-check-label" for="schedule-wednesday">Mi</label>
                         </div>
                         <div class="time-inputs mt-2" id="wednesday-times">
                             <input type="time" class="form-control time-input start-time mb-1" 
                                    data-day="wednesday" 
                                    id="wednesday-start"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                             <input type="time" class="form-control time-input end-time" 
                                    data-day="wednesday" 
                                    id="wednesday-end"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                         </div>
                     </div>
         
                     <!-- Thursday -->
                     <div class="day-column text-center">
                         <div class="form-check">
                             <input type="checkbox" class="form-check-input schedule-day" id="schedule-thursday" data-day="thursday">
                             <label class="form-check-label" for="schedule-thursday">Do</label>
                         </div>
                         <div class="time-inputs mt-2" id="thursday-times">
                             <input type="time" class="form-control time-input start-time mb-1" 
                                    data-day="thursday" 
                                    id="thursday-start"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                             <input type="time" class="form-control time-input end-time" 
                                    data-day="thursday" 
                                    id="thursday-end"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                         </div>
                     </div>
         
                     <!-- Friday -->
                     <div class="day-column text-center">
                         <div class="form-check">
                             <input type="checkbox" class="form-check-input schedule-day" id="schedule-friday" data-day="friday">
                             <label class="form-check-label" for="schedule-friday">Fr</label>
                         </div>
                         <div class="time-inputs mt-2" id="friday-times">
                             <input type="time" class="form-control time-input start-time mb-1" 
                                    data-day="friday" 
                                    id="friday-start"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                             <input type="time" class="form-control time-input end-time" 
                                    data-day="friday" 
                                    id="friday-end"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                         </div>
                     </div>
         
                     <!-- Saturday -->
                     <div class="day-column text-center">
                         <div class="form-check">
                             <input type="checkbox" class="form-check-input schedule-day" id="schedule-saturday" data-day="saturday">
                             <label class="form-check-label" for="schedule-saturday">Sa</label>
                         </div>
                         <div class="time-inputs mt-2" id="saturday-times">
                             <input type="time" class="form-control time-input start-time mb-1" 
                                    data-day="saturday" 
                                    id="saturday-start"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                             <input type="time" class="form-control time-input end-time" 
                                    data-day="saturday" 
                                    id="saturday-end"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                         </div>
                     </div>
         
                     <!-- Sunday -->
                     <div class="day-column text-center">
                         <div class="form-check">
                             <input type="checkbox" class="form-check-input schedule-day" id="schedule-sunday" data-day="sunday">
                             <label class="form-check-label" for="schedule-sunday">So</label>
                         </div>
                         <div class="time-inputs mt-2" id="sunday-times">
                             <input type="time" class="form-control time-input start-time mb-1" 
                                    data-day="sunday" 
                                    id="sunday-start"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                             <input type="time" class="form-control time-input end-time" 
                                    data-day="sunday" 
                                    id="sunday-end"
                                    pattern="[0-9]{2}:[0-9]{2}"
                                    required>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
    </div>
    
    <!-- Add Station Button -->
    <div class="d-grid mb-3">
        <button id="addStationBtn" class="btn btn-primary btn-lg">
            <i class="fas fa-plus"></i> Neue Station
        </button>
    </div>

    <!-- Stations Container -->
    <div id="stationsContainer">
        <!-- Station Template -->
        <div class="station-template d-none station-card">
            <div class="card mb-3">
                <div class="card-header d-flex align-items-center bg-light py-2">
                    <div class="drag-handle me-2">⋮⋮</div>
                    <input type="text" class="form-control station-name" placeholder="Stationsname">
                    <button class="btn btn-danger btn-sm ms-2 delete-station">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="card-body p-2 participants-container">
                    <!-- Participants will be inserted here -->
                </div>
                <div class="card-footer p-2">
                    <button class="btn btn-secondary btn-sm w-100 add-participant">
                        <i class="fas fa-plus"></i> Teilnehmer
                    </button>
                </div>
            </div>
        </div>
          <!-- Participant Template -->
          <div class="participant-template d-none">
           <div class="participant-card mb-2 border rounded p-2">
               <div class="d-flex align-items-center mb-2">
                   <div class="drag-handle me-2">⋮⋮</div>
                   <div class="flex-grow-1 d-flex align-items-center">
                       <input type="text" class="form-control participant-name" placeholder="Name">
                       <button class="btn btn-danger btn-sm ms-2 delete-participant">
                           <i class="fas fa-trash"></i>
                       </button>
                   </div>
               </div>
               <div class="days-container d-flex justify-content-between mt-2">
                   <div class="form-check">
                       <input type="checkbox" class="form-check-input monday" id="mon-{id}">
                       <label class="form-check-label" for="mon-{id}">Mo</label>
                   </div>
                   <div class="form-check">
                       <input type="checkbox" class="form-check-input tuesday" id="tue-{id}">
                       <label class="form-check-label" for="tue-{id}">Di</label>
                   </div>
                   <div class="form-check">
                       <input type="checkbox" class="form-check-input wednesday" id="wed-{id}">
                       <label class="form-check-label" for="wed-{id}">Mi</label>
                   </div>
                   <div class="form-check">
                       <input type="checkbox" class="form-check-input thursday" id="thu-{id}">
                       <label class="form-check-label" for="thu-{id}">Do</label>
                   </div>
                   <div class="form-check">
                       <input type="checkbox" class="form-check-input friday" id="fri-{id}">
                       <label class="form-check-label" for="fri-{id}">Fr</label>
                   </div>
                   <div class="form-check">
                       <input type="checkbox" class="form-check-input saturday" id="sat-{id}">
                       <label class="form-check-label" for="sat-{id}">Sa</label>
                   </div>
                   <div class="form-check">
                       <input type="checkbox" class="form-check-input sunday" id="sun-{id}">
                       <label class="form-check-label" for="sun-{id}">So</label>
                   </div>
               </div>
           </div>
       </div>
           
    </div>
</div>
<style>
.day-column {
    flex: 1;
    min-width: 80px;
    padding: 0 4px;
}

.time-input {
    width: 100%;
    font-size: 0.9rem;
    min-width: 85px;
    padding-right: 30px !important;
    text-align: center;
    -webkit-appearance: none;
    padding-left: 10px !important;
}

/* Override Bootstrap's default time input styling */
input[type="time"] {
    /* Remove default styling */
    -webkit-appearance: textfield;
    -moz-appearance: textfield;
    appearance: textfield;
    
    /* Force left alignment */
    text-align: left;
    
    /* Remove internal padding */
    padding: 2px 4px !important;
    
    /* Control width */
    width: 100%;
    min-width: 42px;
    
}

input[type="time"]::-webkit-calendar-picker-indicator {
    display: none;
}

input[type="time"]::-webkit-inner-spin-button {
    display: none;
}

/* Additional iOS specific adjustments for mobile */
@supports (-webkit-touch-callout: none) {
    @media (max-width: 576px) {
        .time-input {
            min-width: 44px; /* Slightly wider for iOS */
            -webkit-appearance: none; /* Remove iOS default styling */
        }
    }
}

/* Add empty-time class and not(:disabled) check for the red border */
.time-input.empty-time:required:not(:disabled) {
    border-color: #dc3545;
}

/* Keep the valid state handler */
.time-input:required:valid {
    border-color: var(--bs-border-color);
}

/* Keep the asterisk styling */
.time-input.empty-time:required:not(:disabled)::after {
    content: "*";
    color: #dc3545;
    margin-left: 1px;
}

/* Specific mobile adjustments */
@media (max-width: 576px) {
     input[type="time"] {
        font-size: 0.75rem;
        /* Tighter padding for mobile */
        padding: 2px 2px !important;
    }

    .day-column {
        min-width: 40px;
        padding: 0 2px;
    }
    
    .time-input {
        font-size: 0.75rem; /* Slightly smaller font */
        min-width: 42px; /* Adjusted width */
        width: 100%;
        padding: 2px !important; /* Minimal padding */
        text-align: center;
    }

    .time-input:not(.empty-time) {
        padding-right: 2px !important;
    }

    /* Show clock icon only when input has empty-time class and is enabled */
    .time-input.empty-time:not(:disabled) {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666666'%3E%3Cpath d='M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 5px center;
        background-size: 16px;
    }

}

/* Prevent text selection for app like experience */
*:not(input, textarea) {
    user-select: none; /* Prevent text selection */
    -webkit-user-select: none; /* For Safari */
    -moz-user-select: none; /* For Firefox */
    -ms-user-select: none; /* For IE10+/Edge */
}

 /* General Styles */
 .drag-handle {
     cursor: move;
     font-size: 2.3rem;
     color: #666;
     user-select: none;
     touch-action: none;
 }

 .station-card {
     background-color: #fff;
     box-shadow: 0 2px 4px rgba(0,0,0,0.1);
 }

 .station-card.dragging {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    background-color: #f0f0f0;
}

 .form-check-label {
     font-size: 0.8rem;
     margin-left: 4px;
 }

 .form-check-input {
     width: 1rem;
     height: 1rem;
 }

 .form-check {
     margin-bottom: 0;
 }

 .form-check-input:disabled {
     background-color: #e9ecef;
     border-color: #ced4da;
 }

 .form-check-input:disabled + .form-check-label {
     color: #6c757d;
 }

 .btn {
     padding: 0.25rem 0.5rem;
     min-height: 32px;
 }

 .form-control {
     padding: 0.25rem 0.5rem;
     min-height: 32px;
 }

 /* Card Styles */
 .card-header {
     background-color: #414141 !important; /* Dark gray */
     color: #fff; /* White text */
     padding: 0.5rem !important;
 }

 .card-header .station-name {
     background-color: #6f6f70;
     color: #fff;
     border: 1px solid #6c757d;
 }

 .card-header .station-name::placeholder {
     color: #adb5bd;
 }

 .card-body.participants-container {
     background-color: #414141;
     padding: 0.5rem !important;
 }

 .participant-card {
     background-color: #969696;  /* Darker shade of light gray */
     padding: 0.5rem !important;
     margin-bottom: 0.5rem !important;
 }


.participant-card .d-flex {
     align-items: center;
}

.days-container {
     display: flex;
     justify-content: space-between;
     margin-top: 0.5rem; /* Ensure there's space between the input line and checkboxes */
}

.form-check {
     display: flex;
     align-items: center;
     margin-bottom: 0;
}

.form-check-label {
     margin-left: 4px; /* Ensure the label is close to the checkbox */
     font-size: 0.8rem;
}

.card-footer {
     background-color: #414141 !important;
     padding: 0.5rem !important;

}

/* Button Styles */
.add-participant {
     background-color: #0d6efd !important;
     border-color: #0d6efd !important;
     color: white !important;

}</style>
<!-- Include necessary scripts -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
 document.addEventListener('DOMContentLoaded', async () => {
     let globalSchedule = null;
     const stationsContainer = document.getElementById('stationsContainer');
     const stationTemplate = document.querySelector('.station-template');
     const participantTemplate = document.querySelector('.participant-template');

     // Add a passive touchstart event listener to improve scrolling performance
     document.addEventListener('touchstart', function() {}, { passive: true });

     // Load initial stations
     await initializeSchedule();
     await loadStations();

     // Station container event delegation for clicks
     stationsContainer.addEventListener('click', async (e) => {
         // Handle station deletion
         if (e.target.closest('.delete-station')) {
             const stationElement = e.target.closest('.station-card');
             const stationId = stationElement.dataset.stationId;
             const stationName = stationElement.querySelector('.station-name').value;
             if (confirm(`Station "${stationName}" wirklich löschen?`)) {
                 await deleteStation(stationId, stationElement);
             }
         }
         
         // Handle add participant
         if (e.target.closest('.add-participant')) {
             const stationElement = e.target.closest('.station-card');
             const stationId = stationElement.dataset.stationId;
             await createNewParticipant(stationId, stationElement);
         }
         
         // Handle participant deletion
         if (e.target.closest('.delete-participant')) {
             const participantElement = e.target.closest('.participant-card');
             // Get participantId and validate it exists
             const participantId = participantElement?.dataset?.participantId;
             
             if (!participantId) {
                 console.error('No participant ID found:', participantElement);
                 return;
             }
             
             const participantName = participantElement.querySelector('.participant-name').value;
             if (confirm(`Teilnehmer "${participantName}" wirklich löschen?`)) {
                 await deleteParticipant(participantId, participantElement);
             }
         }
     });

     // Station container event delegation for input changes
     stationsContainer.addEventListener('change', async (e) => {
         // Handle station name changes
         if (e.target.classList.contains('station-name')) {
             const stationElement = e.target.closest('.station-card');
             const stationId = stationElement.dataset.stationId;
             await updateStation(stationId, { name: e.target.value });
         }
         
         // Handle participant name changes
         if (e.target.classList.contains('participant-name')) {
             const participantElement = e.target.closest('.participant-card');
             const participantId = participantElement.dataset.participantId;
             const stationId = participantElement.closest('.station-card').dataset.stationId;
             await updateParticipant(participantId, {
                 name: e.target.value,
                 station_id: stationId
             });
         }
         
         // Handle participant day checkboxes
         if (e.target.classList.contains('form-check-input')) {
             const participantElement = e.target.closest('.participant-card');
             if (participantElement) {
                 const participantId = participantElement.dataset.participantId;
                 const day = Array.from(e.target.classList).find(cls => 
                     ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].includes(cls)
                 );
                 if (day) {
                     await updateParticipant(participantId, { [day]: e.target.checked });
                     
                     // Update future entries
                     await fetchWithAuth('/api/update-future-entries', {
                         method: 'PUT',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             participant_id: participantId,
                             day: day,
                             status: e.target.checked
                         })
                     });
                 }
             }
         }
     });

     // Add new station button handler
     document.getElementById('addStationBtn').addEventListener('click', createNewStation);

     // Load schedule
     const response = await fetchWithAuth('/api/walking-bus-schedule');
     const schedule = await response.json();

     // Set initial checkbox and time input states
     Object.entries(schedule).forEach(([day, dayData]) => {
         // Set checkbox state
         const checkbox = document.getElementById(`schedule-${day}`);
         checkbox.checked = dayData.active;
         
         // Set time input values and states
         const startInput = document.getElementById(`${day}-start`);
         const endInput = document.getElementById(`${day}-end`);
         
         if (startInput && endInput) {
             // Only set values if the day is active
             if (dayData.active) {
                 startInput.value = dayData.start || '';
                 endInput.value = dayData.end || '';
             } else {
                 startInput.value = '';
                 endInput.value = '';
             }
             startInput.disabled = !dayData.active;
             endInput.disabled = !dayData.active;
         }
     });

     // Add event listeners to schedule checkboxes
     document.querySelectorAll('.schedule-day').forEach(checkbox => {
         checkbox.addEventListener('change', async () => {
             const day = checkbox.dataset.day;
             const startInput = document.getElementById(`${day}-start`);
             const endInput = document.getElementById(`${day}-end`);
             
             if (checkbox.checked) {
                 // Restore saved values and enable inputs
                 startInput.value = startInput.dataset.savedValue;
                 endInput.value = endInput.dataset.savedValue;
                 startInput.disabled = false;
                 endInput.disabled = false;
                 
                 // Remove empty-time class since we're restoring valid values
                 startInput.classList.remove('empty-time');
                 endInput.classList.remove('empty-time');
             } else {
                 // Clear visible values but keep saved values, disable inputs
                 startInput.value = '';
                 endInput.value = '';
                 startInput.disabled = true;
                 endInput.disabled = true;
                 
                 // Remove empty-time class since disabled fields don't need validation
                 startInput.classList.remove('empty-time');
                 endInput.classList.remove('empty-time');
             }

             // Update all participant checkboxes for this day
             document.querySelectorAll(`.participant-card .${day}`).forEach(participantCheckbox => {
                 participantCheckbox.disabled = !checkbox.checked;
                 // Update the label color
                 const label = participantCheckbox.nextElementSibling;
                 if (label) {
                     if (checkbox.checked) {
                         label.classList.remove('text-muted');
                     } else {
                         label.classList.add('text-muted');
                     }
                 }
             });

             // Rest of the update logic remains the same
             const newSchedule = {};
             document.querySelectorAll('.schedule-day').forEach(cb => {
                 const d = cb.dataset.day;
                 const start = document.getElementById(`${d}-start`);
                 const end = document.getElementById(`${d}-end`);
                 newSchedule[d] = {
                     active: cb.checked,
                     start: start.dataset.savedValue || start.value,
                     end: end.dataset.savedValue || end.value
                 };
             });

             try {
                 await fetchWithAuth('/api/walking-bus-schedule', {
                     method: 'PUT',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(newSchedule)
                 });
                 globalSchedule = newSchedule;
             } catch (error) {
                 console.error('Failed to update schedule:', error);
                 alert('Failed to update schedule. Please try again.');
             }
         });
     });

     // Add event listeners to time inputs
     document.querySelectorAll('.time-input').forEach(timeInput => {
         // Check on blur (when input loses focus) instead of onChange
         timeInput.addEventListener('blur', async () => {
             const day = timeInput.dataset.day;
             const startTime = document.getElementById(`${day}-start`).value;
             const endTime = document.getElementById(`${day}-end`).value;
             
             // Only validate if both times are completely entered
             if (startTime && endTime && startTime >= endTime) {
                 alert('Die Startzeit muss vor der Endzeit liegen.');
                 timeInput.value = timeInput.dataset.savedValue || '';
                 return;
             }

             // Update schedule only after complete valid entry
             const newSchedule = {};
             document.querySelectorAll('.schedule-day').forEach(cb => {
                 const day = cb.dataset.day;
                 newSchedule[day] = {
                     active: cb.checked,
                     start: document.getElementById(`${day}-start`).value,
                     end: document.getElementById(`${day}-end`).value
                 };
             });

             try {
                 await fetchWithAuth('/api/walking-bus-schedule', {
                     method: 'PUT',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(newSchedule)
                 });
             } catch (error) {
                 console.error('Failed to update schedule times:', error);
                 alert('Failed to update schedule times. Please try again.');
             }
         });
     });


     async function createStationCard(station) {
         const newStation = stationTemplate.cloneNode(true);
         newStation.classList.remove('d-none', 'station-template');
         newStation.dataset.stationId = station.id;
         
         // Special handling for unassigned section
         if (station.id === "unassigned") {
             // Remove delete button and drag handle for unassigned section
             const header = newStation.querySelector('.card-header');
             header.querySelector('.delete-station').remove();
             header.querySelector('.drag-handle').remove();
             
             // Make name field readonly
             const nameField = header.querySelector('.station-name');
             nameField.value = station.name;
             nameField.readOnly = true;
             
             // Add special styling
             newStation.classList.add('unassigned-section');
         } else {
             newStation.querySelector('.station-name').value = station.name;
         }

         const participantsContainer = newStation.querySelector('.participants-container');
         
         if (station.participants) {
             const fragment = document.createDocumentFragment();
             for (const participant of station.participants) {
                 const participantCard = await createParticipantCard(participant);
                 fragment.appendChild(participantCard);
             }
             participantsContainer.appendChild(fragment);
         }

         return newStation;
     }

     async function loadStations() {
         try {
             // Add admin=1 parameter to get full participant data including schedule
             const response = await fetchWithAuth('/api/stations?admin=1&include=participants');
             const stations = await response.json();
             
             const fragment = document.createDocumentFragment();
             for (const station of stations) {
                 const card = await createStationCard(station);
                 fragment.appendChild(card);
             }
             stationsContainer.appendChild(fragment);
             initializeSortable();
         } catch (error) {
             console.error('Failed to load stations:', error);
         }
     }


     async function createParticipantCard(participant) {
         const schedule = globalSchedule;
         const newParticipant = participantTemplate.cloneNode(true);
         newParticipant.classList.remove('d-none', 'participant-template');
         
         const participantCard = newParticipant.querySelector('.participant-card');
         participantCard.dataset.participantId = participant.id;
         
         newParticipant.querySelector('.participant-name').value = participant.name;

         const daysContainer = newParticipant.querySelector('.days-container');
         daysContainer.innerHTML = '';

         const days = [
             { key: 'monday', label: 'Mo' },
             { key: 'tuesday', label: 'Di' },
             { key: 'wednesday', label: 'Mi' },
             { key: 'thursday', label: 'Do' },
             { key: 'friday', label: 'Fr' },
             { key: 'saturday', label: 'Sa' },
             { key: 'sunday', label: 'So' }
         ];

         days.forEach(({ key, label }) => {
             const dayCheck = document.createElement('div');
             dayCheck.className = 'form-check';
             // Check schedule enabled state
             const isEnabled = schedule[key] && schedule[key].active;
             // Check participant's actual schedule for this day
             const isScheduled = participant[key];

             dayCheck.innerHTML = `
                 <input type="checkbox" class="form-check-input ${key}" 
                        id="${key}-${participant.id}" 
                        ${isEnabled ? '' : 'disabled'}
                        ${isScheduled ? 'checked' : ''}>
                 <label class="form-check-label ${isEnabled ? '' : 'text-muted'}" 
                        for="${key}-${participant.id}">${label}</label>
             `;
             daysContainer.appendChild(dayCheck);
         });

         return newParticipant;
     }



       // fetchWithAuth schedule once at startup
       async function initializeSchedule() {
           try {
               const response = await fetchWithAuth('/api/walking-bus-schedule');
               const schedule = await response.json();
               globalSchedule = schedule;
               
               Object.entries(schedule).forEach(([day, dayData]) => {
                   const checkbox = document.getElementById(`schedule-${day}`);
                   const startInput = document.getElementById(`${day}-start`);
                   const endInput = document.getElementById(`${day}-end`);
                   
                   checkbox.checked = dayData.active;
                   
                   // Store the actual values as data attributes
                   startInput.dataset.savedValue = dayData.start;
                   endInput.dataset.savedValue = dayData.end;
                   
                   if (dayData.active) {
                       startInput.value = dayData.start;
                       endInput.value = dayData.end;
                   } else {
                       // Clear visible value but keep the saved value
                       startInput.value = '';
                       endInput.value = '';
                       startInput.disabled = true;
                       endInput.disabled = true;
                   }
               });
           } catch (error) {
               console.error('Failed to load schedule:', error);
           }
       }

        function initializeSortable() {
            // Initialize sortable for stations
            new Sortable(stationsContainer, {
                animation: 150,
                handle: '.drag-handle',
                draggable: '.station-card',
                delayOnTouchOnly: true,
                delay: 100,
                touchStartThreshold: 3,
                onEnd: updateStationOrder
            });

            // Initialize sortable for participants within each station
            document.querySelectorAll('.participants-container').forEach(container => {
                new Sortable(container, {
                    animation: 150,
                    handle: '.drag-handle',
                    group: 'participants',
                    delayOnTouchOnly: true,
                    delay: 250,
                    touchStartThreshold: 5,
                    onEnd: updateParticipantOrder
                });
            });
        }

        // API Functions
        function createNewStation() {
            const newStation = {
                name: 'Neue Station',
                position: 0 
            };

            fetchWithAuth('/api/stations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newStation)
            })
            .then(response => response.json())
            .then(station => {
                createStationCard(station).then(card => {
                    // Insert at the beginning of the container
                    stationsContainer.insertBefore(card, stationsContainer.firstChild);
                    
                    // Update positions of all stations
                    updateStationOrder();
                    
                    // Reinitialize sortable
                    initializeSortable();
                });
            });
        }


        function updateStation(stationId, data) {
            fetchWithAuth(`/api/stations/${stationId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        function deleteStation(stationId, element) {
            fetchWithAuth(`/api/stations/${stationId}`, {
                method: 'DELETE'
            }).then(async () => {
                element.remove();
                
                // Reload stations to show unassigned section if needed
                await loadStations();
            });
        }

        function createNewParticipant(stationId, stationElement) {
            // First get the current schedule
            fetchWithAuth('/api/walking-bus-schedule')
                .then(r => r.json())
                .then(schedule => {
                    const newParticipant = {
                        name: 'Neuer Teilnehmer',
                        station_id: stationId,
                        position: stationElement.querySelectorAll('.participant-card').length,
                        monday: schedule.monday,
                        tuesday: schedule.tuesday,
                        wednesday: schedule.wednesday,
                        thursday: schedule.thursday,
                        friday: schedule.friday,
                        saturday: schedule.saturday,
                        sunday: schedule.sunday
                    };

                    fetchWithAuth('/api/participants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newParticipant)
                    })
                    .then(response => response.json())
                    .then(async participant => {
                        const participantCard = await createParticipantCard(participant);
                        stationElement.querySelector('.participants-container').appendChild(participantCard);
                    });
                });
        }

        function updateParticipant(participantId, data) {
            // First try to get stationId from data
            let stationId = data.station_id;

            // If not in data, try to get from DOM
            if (!stationId) {
                const participantElement = document.querySelector(`[data-participant-id="${participantId}"]`);
                if (participantElement) {
                    const stationCard = participantElement.closest('.station-card');
                    if (stationCard) {
                        stationId = stationCard.dataset.stationId;
                    }
                }
            }

            // If we still don't have a stationId, get it from the server
            if (!stationId) {
                console.log('Updating participant without station context:', { participantId, data });
                fetchWithAuth(`/api/stations/${stationId}/participants/${participantId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => console.error('Update failed:', error));
            } else {
                console.log('Updating participant:', { participantId, stationId, data });
                fetchWithAuth(`/api/stations/${stationId}/participants/${participantId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => console.error('Update failed:', error));
            }
        }

        function deleteParticipant(participantId, element) {
            // Early validation of participantId
            if (!participantId) {
                console.error('Invalid participant ID');
                return;
            }

            console.log('Deleting participant:', participantId);

            fetchWithAuth(`/api/participants/${participantId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // Remove the participant card from UI
                element.remove();
                console.log('Participant successfully deleted');
            })
            .catch(error => {
                console.error('Delete failed:', error);
                alert('Could not delete participant. Please try again.');
            });
        }


        function updateStationOrder() {
            const stations = Array.from(document.querySelectorAll('.station-card')).map((card, index) => {
                console.log('Station card:', card);
                console.log('Station ID:', card.dataset.stationId);
                console.log('Position:', index);
                return {
                    id: parseInt(card.dataset.stationId),
                    position: index
                };
            });

            console.log('Sending station order update:', stations);

            fetchWithAuth('/api/stations/order', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(stations)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Unknown error occurred');
                    });
                }
                return response.json();
            })
            .then(data => console.log('Update successful:', data))
            .catch(error => console.error('Update failed:', error));
        }

        function updateParticipantOrder(evt) {
            const newStationId = evt.to.closest('.station-card').dataset.stationId;
            const participantsContainer = evt.to;
            
            // Get the specific moved participant
            const movedParticipantCard = evt.item.querySelector('.participant-card');
            const movedParticipantId = movedParticipantCard.dataset.participantId;
            
            // Get the new position from the Sortable event
            const newPosition = evt.newIndex;  // This is the key change
            
            fetchWithAuth(`/api/stations/${newStationId}/participants/${movedParticipantId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    station_id: newStationId,
                    position: newPosition  // Using the correct position from event
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to update participant station: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                // Update positions for remaining participants
                const updatePromises = Array.from(participantsContainer.children)
                    .map((participantElement, index) => {
                        const participantCard = participantElement.querySelector('.participant-card');
                        const participantId = participantCard.dataset.participantId;
                        
                        if (participantId !== movedParticipantId) {
                            return fetchWithAuth(`/api/stations/${newStationId}/participants/${participantId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    position: index
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`Failed to update participant position: ${response.status}`);
                                }
                                return response.json();
                            });
                        }
                    });
                
                return Promise.all(updatePromises);
            })
            .catch(error => {
                console.error('Participant update failed:', error);
                alert('Fehler beim Aktualisieren der Teilnehmer. Bitte laden Sie die Seite neu.');
                location.reload();
            });
        }

    });
</script>
{% endblock %}