{% extends "base.html" %}

{% block content %}
<h1 class="text-center">Administration</h1>

<div class="mt-5">
    <!-- Tabelle für Stationen und Teilnehmer -->
    <table id="adminTable" class="table table-striped">
        <thead>
            <tr>
                <th>Station/Teilnehmer</th>
                <th>Aktionen</th>
                <th>Montag</th>
                <th>Dienstag</th>
                <th>Mittwoch</th>
                <th>Donnerstag</th>
                <th>Freitag</th>
            </tr>
        </thead>
        <tbody id="sortableTableBody">
            <!-- Dynamische Inhalte -->
        </tbody>
    </table>

    <!-- Buttons für Aktionen -->
    <button id="addStationBtn" class="btn btn-primary">+ Station</button>
    <button id="saveStationsBtn" class="btn btn-success">Stationen speichern</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    let stations = []; // Globale Variable für Stationsdaten

    // Lade Stationsdaten vom Server
    function fetchStations() {
        fetch('/api/stations')
            .then(response => response.json())
            .then(data => {
                stations = data;
                renderStations(); // Stationen in der Tabelle anzeigen
            })
            .catch(error => console.error("Fehler beim Laden der Stationen:", error));
    }

    // Neue Station hinzufügen
    function addStation() {
        const newStation = {
            name: "",
            position: stations.length + 1,
            participants: []
        };

        stations.push(newStation);
        renderStations(); // Aktualisiere die Anzeige der Tabelle

        setTimeout(() => {
            const lastRow = document.querySelector("table tbody tr:last-child");
            if (lastRow) {
                const nameInput = lastRow.querySelector("input[name='station-name']");
                if (nameInput) nameInput.focus();
            }
        }, 0);
    }

    // Stationen in der Tabelle anzeigen
    function renderStations() {
        const tbody = document.querySelector("#sortableTableBody");
        tbody.innerHTML = ""; // Bestehende Zeilen löschen

        stations.forEach((station, index) => {
            const row = document.createElement("tr");
            row.classList.add("station-row");

            // Name der Station
            const nameCell = document.createElement("td");
            const nameInput = document.createElement("input");
            nameInput.type = "text";
            nameInput.name = "station-name";
            nameInput.value = station.name;
            nameInput.addEventListener("input", (e) => {
                station.name = e.target.value;
            });
            nameCell.appendChild(nameInput);
            row.appendChild(nameCell);

            // Aktionen
            const actionsCell = document.createElement("td");
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Löschen";
            deleteButton.classList.add("btn", "btn-danger");
            deleteButton.addEventListener("click", () => {
                stations.splice(index, 1);
                renderStations();
            });
            actionsCell.appendChild(deleteButton);
            row.appendChild(actionsCell);

            // Wochentage
            ["monday", "tuesday", "wednesday", "thursday", "friday"].forEach(day => {
                const dayCell = document.createElement("td");
                const dayCheckbox = document.createElement("input");
                dayCheckbox.type = "checkbox";
                dayCheckbox.checked = station[day] || false;
                dayCheckbox.addEventListener("change", (e) => {
                    station[day] = e.target.checked;
                });
                dayCell.appendChild(dayCheckbox);
                row.appendChild(dayCell);
            });

            tbody.appendChild(row);
        });
    }

    // Stationen speichern
    function saveStations() {
        fetch('/api/stations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(stations)
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("Fehler beim Speichern:", data.error);
                } else {
                    console.log("Stationen erfolgreich gespeichert");
                    fetchStations();
                }
            })
            .catch(error => console.error("Fehler beim Speichern der Stationen:", error));
    }

    // Initialer Aufruf beim Laden der Seite
    document.addEventListener('DOMContentLoaded', () => {
        fetchStations();

        document.getElementById('addStationBtn').addEventListener('click', addStation);
        document.getElementById('saveStationsBtn').addEventListener('click', saveStations);

        new Sortable(document.querySelector("#sortableTableBody"), {
            animation: 150
        });
    });
</script>
{% endblock %}
