{% extends "base.html" %}

{% block content %}
<h1 class="text-center">Administration</h1>

<div class="mt-5">
    <!-- Tabelle für Stationen und Teilnehmer -->
    <table id="adminTable" class="table table-striped">
        <thead>
            <tr>
                <th>Station/Teilnehmer</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody id="sortableTableBody">
            <!-- Dynamische Inhalte -->
        </tbody>
    </table>

    <!-- Button für Station hinzufügen -->
    <button id="addStationBtn" class="btn btn-primary">+ Station</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.getElementById('sortableTableBody');

        // In saveParticipant function
        function saveParticipant(participant, stationId) {
            console.log('Saving participant:', participant);
            console.log('Station ID:', stationId);
            fetch(`/api/stations/${stationId}/participants/${participant.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(participant),
            })
            .then(response => {
                console.log('Save participant response:', response);
                return response;
            });
        }

        // Stationen laden
        fetch('/api/stations')
            .then(response => response.json())
            .then(stations => {
                console.log('Loaded stations:', stations);
                stations.forEach(station => {
                    addStationRow(station);
                });
            });

        // SortableJS initialisieren
        new Sortable(tableBody, {
            animation: 150,
            handle: '.drag-handle',
            group: 'stations',
            onEnd: (evt) => {
                const stations = [];
                document.querySelectorAll('.station-row').forEach((row, index) => {
                    const stationId = row.dataset.stationId;
                    const participants = [];
                    
                    // Get all participant rows until next station
                    let nextRow = row.nextElementSibling;
                    while (nextRow && nextRow.classList.contains('participant-row')) {
                        participants.push({
                            id: nextRow.dataset.participantId,
                            position: participants.length
                        });
                        nextRow = nextRow.nextElementSibling;
                    }
                    
                    stations.push({
                        id: stationId,
                        position: index,
                        participants: participants
                    });
                });
                
                fetch('/api/stations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(stations)
                });
            }
        });
          // Station hinzufügen
          document.getElementById('addStationBtn').addEventListener('click', () => {
              const newStation = { 
                  name: 'Neue Station', 
                  position: document.querySelectorAll('.station-row').length,  // Add position
                  participants: [] 
              };

              fetch('/admin/stations', {  // Changed endpoint
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(newStation),
              })
              .then(response => response.json())
              .then(station => {
                  addStationRow(station);
              });
          });
        // Station-Zeile hinzufügen
        function addStationRow(station) {
            station.participants = station.participants || [];
            const stationRow = document.createElement('tr');
            stationRow.classList.add('station-row');
            stationRow.dataset.stationId = station.id; // Add station ID to the row
            stationRow.innerHTML = `
                <td>
                    <span class="drag-handle">⋮⋮</span>
                    <input type="text" class="form-control station-name" value="${station.name || ''}" placeholder="Stationenname eingeben">
                    <button class="btn btn-secondary btn-sm add-participant">+ Teilnehmer</button>
                </td>
                <td>
                    <button class="btn btn-danger btn-sm delete-station">- Station</button>
                </td>
            `;
            tableBody.appendChild(stationRow);

            // Station speichern bei Namensänderung
            stationRow.querySelector('.station-name').addEventListener('change', (e) => {
                station.name = e.target.value;
                saveStation(station);
            });

            // Station löschen
            stationRow.querySelector('.delete-station').addEventListener('click', () => {
                if (confirm('Möchten Sie diese Station wirklich löschen?')) {
                    fetch(`/admin/stations/${station.id}/delete`, { 
                        method: 'POST'  // Changed from DELETE to POST
                    }).then(() => {
                        stationRow.remove();
                    });
                }
            });

            // Teilnehmer hinzufügen
            stationRow.querySelector('.add-participant').addEventListener('click', () => {
                const newParticipant = { 
                    name: 'Neuer Teilnehmer',
                    station_id: station.id,
                    position: station.participants ? station.participants.length : 0,
                    monday: false,
                    tuesday: false,
                    wednesday: false,
                    thursday: false,
                    friday: false
                };

                fetch('/admin/participants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newParticipant),
                })
                .then(response => response.json())
                .then(participant => {
                    const participantRow = addParticipantRow(stationRow, participant, station);
                    station.participants.push(participant);
                    
                    // Explicitly focus the name input after adding
                    const nameInput = participantRow.querySelector('.participant-name');
                    nameInput.focus();
                    nameInput.select();
                });
            });

            // Teilnehmer für diese Station hinzufügen
            station.participants.forEach(participant => {
                addParticipantRow(stationRow, participant, station);
            });
        }
          // Teilnehmer-Zeile hinzufügen
          function addParticipantRow(stationRow, participant, station) {
              const participantRow = document.createElement('tr');
              participantRow.classList.add('participant-row');
              participantRow.dataset.participantId = participant.id;
              participantRow.innerHTML = `
                  <td style="padding-left: 2rem;">
                      <div class="d-flex align-items-center">
                          <span class="drag-handle">⋮⋮</span>
                          <input type="text" class="form-control participant-name" 
                       value="${participant.name}" 
                       placeholder="Teilnehmer eingeben"
                       data-participant-id="${participant.id}"
                       style="cursor: text;">
                      </div>
                  </td>
                  <td>
                      ${['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
                          .map(day => `<input type="checkbox" class="day-checkbox ${day}" ${participant[day] ? 'checked' : ''}>`)
                          .join('')}
                      <button class="btn btn-danger btn-sm delete-participant">- Teilnehmer</button>
                  </td>
              `;
              const nameInput = participantRow.querySelector('.participant-name');
              ['change', 'blur'].forEach(eventType => {
                  nameInput.addEventListener(eventType, (e) => {
                      const participantId = parseInt(e.target.dataset.participantId, 10);
                      const currentParticipant = station.participants.find(p => p.id === participantId);
                      if (currentParticipant) {
                          currentParticipant.name = e.target.value;
                          saveParticipant(currentParticipant, station.id);
                      } else {
                          console.error("Participant not found in station's participants array. ID:", participantId);
                      }
                  });
              });
              participantRow.querySelectorAll('.day-checkbox').forEach(checkbox => {
                  checkbox.addEventListener('change', () => {
                      participant[checkbox.classList[1]] = checkbox.checked;
                      saveParticipant(participant, station.id);
                  });
              });

              participantRow.querySelector('.delete-participant').addEventListener('click', () => {
                  if (confirm('Möchten Sie diesen Teilnehmer wirklich löschen?')) {
                      fetch(`/admin/participants/${participant.id}/delete`, { 
                          method: 'POST'
                      }).then(() => {
                          participantRow.remove();
                          const index = station.participants.findIndex(p => p.id === participant.id);
                          if (index > -1) {
                              station.participants.splice(index, 1);
                          }
                      });
                  }
              });

              stationRow.after(participantRow);
              return participantRow;
          }

        function saveStation(station) {
            fetch(`/api/stations/${station.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(station),
            });
        }

        function saveParticipant(participant, stationId) {
            fetch(`/api/stations/${stationId}/participants/${participant.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(participant),
            });
        }

        // ... inside the onEnd handler for Sortable ...

        fetch(`/api/stations/${newStationId}/participants/${participantId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                station_id: parseInt(newStationId, 10), // parseInt here as well
                position: Array.from(evt.item.parentNode.children).indexOf(evt.item)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("Participant updated successfully:", data.participant_id);
                // You might want to refresh the participant list here if needed
                // For example, you could re-fetch the station data and redraw the table
            } else {
                console.error("Error updating participant:", data.error);
                // Handle the error, perhaps by displaying a message to the user
            }
        })
        .catch(error => {
            console.error("Network error updating participant:", error);
            // Handle the network error
        });

        // Stationen speichern bei Sortierung
        function saveStations() {
            const updatedStations = [];
            document.querySelectorAll('.station-row').forEach(stationRow => {
                const station = {
                    name: stationRow.querySelector('.station-name').value,
                    participants: [],
                };
                let currentRow = stationRow.nextElementSibling;
                while (currentRow && currentRow.classList.contains('participant-row')) {
                    station.participants.push({
                        name: currentRow.querySelector('.participant-name').value,
                        days: {
                            monday: currentRow.querySelector('.monday').checked,
                            tuesday: currentRow.querySelector('.tuesday').checked,
                            wednesday: currentRow.querySelector('.wednesday').checked,
                            thursday: currentRow.querySelector('.thursday').checked,
                            friday: currentRow.querySelector('.friday').checked,
                        },
                    });
                    currentRow = currentRow.nextElementSibling;
                }
                updatedStations.push(station);
            });

            fetch('/api/stations/update_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedStations),
            });
        }
    });

    // Initialize Sortable for both stations and participants
    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.getElementById('sortableTableBody');

        new Sortable(tableBody, {
            animation: 150,
            handle: '.drag-handle',
            group: 'shared', // Allow dragging between stations
            filter: '.participant-row',  // Prevents direct dragging of participant rows
            onEnd: (evt) => {
                if (evt.item.classList.contains('station-row')) {
                    // Handle station reordering
                    const stations = [];
                    document.querySelectorAll('.station-row').forEach((row, index) => {
                        const stationId = row.dataset.stationId;
                        const participants = [];
                        
                        let nextRow = row.nextElementSibling;
                        while (nextRow && nextRow.classList.contains('participant-row')) {
                            participants.push({
                                id: nextRow.dataset.participantId,
                                position: participants.length
                            });
                            nextRow = nextRow.nextElementSibling;
                        }
                        
                        stations.push({
                            id: stationId,
                            position: index,
                            participants: participants
                        });
                    });
                    
                    fetch('/api/stations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(stations)
                    });
                } else if (evt.item.classList.contains('participant-row')) {
                    const participantId = evt.item.dataset.participantId;
                    const newStationRow = evt.item.closest('.station-row'); // Find closest station row
                    const newStationId = newStationRow ? newStationRow.dataset.stationId : null;

                    if (newStationId) { // Check if participant is dropped within a station
                        fetch(`/api/stations/${newStationId}/participants/${participantId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                station_id: newStationId,
                                position: Array.from(evt.item.parentNode.children).indexOf(evt.item)
                            })
                        });
                    }
                }
            }
        });
    });
</script>
{% endblock %}

<style>
    .drag-handle {
        cursor: move;
        padding: 5px;
        margin-right: 10px;
    }
</style>