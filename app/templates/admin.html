{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-2">
    <h1 class="h3 text-center my-3">Walking Bus Administration</h1>

    <!-- Add Station Button -->
    <div class="d-grid mb-3">
        <button id="addStationBtn" class="btn btn-primary btn-lg">
            <i class="fas fa-plus"></i> Neue Station
        </button>
    </div>

    <!-- Stations Container -->
    <div id="stationsContainer">
        <!-- Station Template -->
        <div class="station-template d-none station-card">
            <div class="card mb-3">
                <div class="card-header d-flex align-items-center bg-light py-2">
                    <div class="drag-handle me-2">⋮⋮</div>
                    <input type="text" class="form-control station-name" placeholder="Stationsname">
                    <button class="btn btn-danger btn-sm ms-2 delete-station">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="card-body p-2 participants-container">
                    <!-- Participants will be inserted here -->
                </div>
                <div class="card-footer p-2">
                    <button class="btn btn-secondary btn-sm w-100 add-participant">
                        <i class="fas fa-plus"></i> Teilnehmer
                    </button>
                </div>
            </div>
        </div>

        <!-- Participant Template -->
        <div class="participant-template d-none">
            <div class="participant-card mb-2 border rounded p-2">
                <div class="d-flex align-items-center mb-2">
                    <div class="drag-handle me-2">⋮⋮</div>
                    <input type="text" class="form-control participant-name" placeholder="Name">
                    <button class="btn btn-danger btn-sm ms-2 delete-participant">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="days-container d-flex justify-content-between">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input monday" id="mon-{id}">
                        <label class="form-check-label" for="mon-{id}">Mo</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input tuesday" id="tue-{id}">
                        <label class="form-check-label" for="tue-{id}">Di</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input wednesday" id="wed-{id}">
                        <label class="form-check-label" for="wed-{id}">Mi</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input thursday" id="thu-{id}">
                        <label class="form-check-label" for="thu-{id}">Do</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input friday" id="fri-{id}">
                        <label class="form-check-label" for="fri-{id}">Fr</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.drag-handle {
    cursor: move;
    font-size: 1.2rem;
    color: #666;
    user-select: none;
    touch-action: none;
}

.station-card {
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.participant-card {
    background-color: #f8f9fa;
}

.form-check-label {
    font-size: 0.9rem;
    margin-left: 4px;
}

.form-check-input {
    width: 1.2rem;
    height: 1.2rem;
}

/* Larger touch targets for mobile */
.btn {
    min-height: 44px;
}

.form-control {
    min-height: 44px;
}
</style>

<!-- Include necessary scripts -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const stationsContainer = document.getElementById('stationsContainer');
        const stationTemplate = document.querySelector('.station-template');
        const participantTemplate = document.querySelector('.participant-template');

        // Load initial stations
        loadStations();

        // Add new station button handler
        document.getElementById('addStationBtn').addEventListener('click', createNewStation);

        function loadStations() {
            fetch('/api/stations')
                .then(response => response.json())
                .then(stations => {
                    stations.forEach(station => createStationCard(station));
                    initializeSortable();
                });
        }

        function createStationCard(station) {
            const newStation = stationTemplate.cloneNode(true);
            newStation.classList.remove('d-none', 'station-template');
            newStation.dataset.stationId = station.id;
            newStation.querySelector('.station-name').value = station.name;

            const participantsContainer = newStation.querySelector('.participants-container');
            station.participants?.forEach(participant => {
                const participantCard = createParticipantCard(participant);
                participantsContainer.appendChild(participantCard);
            });

            setupStationEventListeners(newStation, station);
            stationsContainer.appendChild(newStation);
            return newStation;
        }

        function createParticipantCard(participant) {
            const newParticipant = participantTemplate.cloneNode(true);
            newParticipant.classList.remove('d-none', 'participant-template');
            newParticipant.dataset.participantId = participant.id;
            newParticipant.querySelector('.participant-name').value = participant.name;

            // Set checkboxes
            ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].forEach(day => {
                newParticipant.querySelector(`.${day}`).checked = participant[day];
            });

            setupParticipantEventListeners(newParticipant, participant);
            return newParticipant;
        }

        function setupStationEventListeners(stationElement, station) {
            // Station name change
            stationElement.querySelector('.station-name').addEventListener('change', (e) => {
                updateStation(station.id, { name: e.target.value });
            });

            // Delete station
            stationElement.querySelector('.delete-station').addEventListener('click', () => {
                if (confirm('Station wirklich löschen?')) {
                    deleteStation(station.id, stationElement);
                }
            });

            // Add participant
            stationElement.querySelector('.add-participant').addEventListener('click', () => {
                createNewParticipant(station.id, stationElement);
            });
        }

        function setupParticipantEventListeners(participantElement, participant) {
            // Name change
            participantElement.querySelector('.participant-name').addEventListener('change', (e) => {
                const stationId = participantElement.closest('.station-card').dataset.stationId;
                updateParticipant(participant.id, { 
                    name: e.target.value,
                    station_id: stationId
                });
            });

            // Day checkboxes
            participantElement.querySelectorAll('.form-check-input').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const day = e.target.classList[1];
                    updateParticipant(participant.id, { [day]: e.target.checked });
                });
            });

            // Delete participant
            participantElement.querySelector('.delete-participant').addEventListener('click', () => {
                if (confirm('Teilnehmer wirklich löschen?')) {
                    deleteParticipant(participant.id, participantElement);
                }
            });
        }
        function initializeSortable() {
            // Initialize sortable for stations
            new Sortable(stationsContainer, {
                animation: 150,
                handle: '.drag-handle',
                draggable: '.station-card',
                onEnd: updateStationOrder
            });

            // Initialize sortable for participants within each station
            document.querySelectorAll('.participants-container').forEach(container => {
                new Sortable(container, {
                    animation: 150,
                    handle: '.drag-handle',
                    group: 'participants',
                    onEnd: updateParticipantOrder
                });
            });
        }

        // API Functions
        function createNewStation() {
            const newStation = {
                name: 'Neue Station',
                position: document.querySelectorAll('.station-card').length
            };

            fetch('/admin/stations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newStation)
            })
            .then(response => response.json())
            .then(station => createStationCard(station));
        }

        function updateStation(stationId, data) {
            fetch(`/api/stations/${stationId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        function deleteStation(stationId, element) {
            fetch(`/admin/stations/${stationId}/delete`, {
                method: 'POST'
            }).then(() => element.remove());
        }

        function createNewParticipant(stationId, stationElement) {
            const newParticipant = {
                name: 'Neuer Teilnehmer',
                station_id: stationId,
                position: stationElement.querySelectorAll('.participant-card').length
            };

            fetch('/admin/participants', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newParticipant)
            })
            .then(response => response.json())
            .then(participant => {
                const participantCard = createParticipantCard(participant);
                stationElement.querySelector('.participants-container').appendChild(participantCard);
            });
        }

        function updateParticipant(participantId, data) {
            const stationId = data.station_id || document.querySelector(`[data-participant-id="${participantId}"]`)
                .closest('.station-card').dataset.stationId;
            
            console.log('Updating participant:', {participantId, stationId, data});
            
            fetch(`/api/stations/${stationId}/participants/${participantId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .catch(error => console.error('Update failed:', error));
        }

        function deleteParticipant(participantId, element) {
            fetch(`/admin/participants/${participantId}/delete`, {
                method: 'POST'
            }).then(() => element.remove());
        }

        function updateStationOrder() {
            const stations = Array.from(document.querySelectorAll('.station-card')).map((card, index) => {
                console.log('Station card:', card);
                console.log('Station ID:', card.dataset.stationId);
                console.log('Position:', index);
                return {
                    id: parseInt(card.dataset.stationId),
                    position: index
                };
            });

            console.log('Sending station order update:', stations);

            fetch('/api/stations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(stations)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Unknown error occurred');
                    });
                }
                return response.json();
            })
            .then(data => console.log('Update successful:', data))
            .catch(error => console.error('Update failed:', error));
        }

        function updateParticipantOrder(evt) {
            const participantId = evt.item.dataset.participantId;
            const newStationId = evt.to.closest('.station-card').dataset.stationId;
            const newPosition = Array.from(evt.to.children).indexOf(evt.item);

            updateParticipant(participantId, {
                station_id: newStationId,
                position: newPosition
            });
        }
    });
</script>
{% endblock %}