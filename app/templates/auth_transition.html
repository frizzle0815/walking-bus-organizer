<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication</title>
</head>
<body>
    <div id="auth-status">Authenticating...</div>

    <script>
        console.log('Auth transition page loaded');
        
        async function initializeServiceWorker() {
            console.log('Starting Service Worker initialization');
            const registration = await navigator.serviceWorker.register('/static/service-worker.js');
            
            if (registration.installing) {
                console.log('Service Worker installing');
                await new Promise(resolve => {
                    registration.installing.addEventListener('statechange', e => {
                        if (e.target.state === 'activated') {
                            console.log('Service Worker activated');
                            resolve();
                        }
                    });
                });
            }
            
            return registration.active;
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            const authToken = "{{ auth_token }}";
            console.log('Auth token present:', !!authToken);
            
            if (authToken && 'serviceWorker' in navigator) {
                try {
                    const activeWorker = await initializeServiceWorker();
                    console.log('Service Worker ready for message');
                    
                    const messageChannel = new MessageChannel();
                    messageChannel.port1.onmessage = (event) => {
                        console.log('Token stored:', event.data);
                        window.location.href = "{{ redirect_url }}";
                    };
                    
                    activeWorker.postMessage({
                        type: 'STORE_AUTH_TOKEN',
                        token: authToken
                    }, [messageChannel.port2]);
                    
                    console.log('Token message sent');
                } catch (error) {
                    console.error('Service Worker setup failed:', error);
                    window.location.href = "{{ redirect_url }}";
                }
            }
        });
    </script>
</body>
</html>
