<!-- auth.html -->
<script>
(function() {
    window.TokenManager = class TokenManager {
        async getToken() {
            // Direct cookie access using regex
            const cookieString = document.cookie;
            console.log('[AUTH.HTML] Raw cookie string:', cookieString);
            
            // Use regex to find auth_token
            const match = cookieString.match(/auth_token=([^;]+)/);
            console.log('[AUTH.HTML] Cookie match result:', match);
            
            if (match && match[1]) {
                const token = match[1];
                console.log('[AUTH.HTML] Found token:', token);
                return token;
            }

            // Fallback to localStorage
            const localToken = localStorage.getItem('auth_token');
            console.log('[AUTH.HTML] LocalStorage token:', localToken);
            
            if (localToken) {
                document.cookie = `auth_token=${localToken}; max-age=${30*24*60*60}; secure; samesite=Strict`;
                return localToken;
            }

            return null;
        }



        async storeToken(token) {
            // Store in localStorage as backup
            localStorage.setItem('auth_token', token);
        }

        async clearToken() {
            // Clear cookie
            document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; secure; samesite=Strict';
            // Clear backup
            localStorage.removeItem('auth_token');
        }
    }

    console.log('[AUTH.HTML] TokenManager initialized and ready for use');
})();

window.tokenManager = new TokenManager();

(function() {
    // Make auth functions globally available
    window.fetchWithAuth = async function(url, options = {}) {
    try {
        // Cookie will be sent automatically
        const response = await fetch(url, options);

        if (response.status === 401) {
            await tokenManager.clearToken();
            window.location.href = '/login';
            return;
        }

        return response;
    } catch (error) {
        throw error;
    }
};

    // Initialize Axios interceptor
    axios.interceptors.request.use(async (config) => {
        // No need to add Authorization header - cookie is sent automatically
        return config;
    }, (error) => {
        return Promise.reject(error);
    });


    axios.interceptors.response.use(
        async response => {
            const newToken = response.data.new_auth_token;
            if (newToken) {
                await tokenManager.storeToken(newToken);
            }
            return response;
        },
        error => {
            if (error.response?.status === 401) {
                if (error.response?.data?.code === 'PASSWORD_CHANGED') {
                    console.log('[AUTH.HTML] Password changed, clearing all tokens');
                } else {
                    console.log('[AUTH.HTML] Received 401, clearing tokens and redirecting to login');
                }
                
                tokenManager.clearToken();
                window.location.href = '/login';
            }
            return Promise.reject(error);
        }
    );
})();


async function loginUser() {
    const form = document.getElementById('loginForm');
    if (!form) {
        console.log('[AUTH.HTML] Login form not found, exiting loginUser function.');
        return;
    }

    // Remove any existing submit handlers
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);

    newForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        console.log('[AUTH.HTML] Form submission prevented, preparing to send login request.');

        const formData = new FormData(newForm);

        try {
            const response = await fetch('/login', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('[AUTH.HTML] Response received:', data);

            if (!data.success) {
                if (data.buses) {
                    const select = newForm.querySelector('select[name="walking_bus"]');
                    if (select) {
                        select.innerHTML = data.buses.map(bus =>
                            `<option value="${bus.id}" ${bus.id == data.selected_bus_id ? 'selected' : ''}>${bus.name}</option>`
                        ).join('');
                    }
                }
                showErrorMessage(newForm, data.error);
                return;
            }

            const { auth_token: authToken, redirect_url: redirectUrl } = data;
            if (authToken) {
                console.log('[AUTH.HTML] Processing auth token');
                await tokenManager.storeToken(authToken);
                window.location.replace(redirectUrl);
            }
        } catch (error) {
            console.error('[AUTH.HTML] Login error:', error);
            showErrorMessage(newForm, 'Ein unerwarteter Fehler ist aufgetreten. Bitte versuchen Sie es erneut.');
        }
    });
}


async function attemptAutoLogin() {
    console.log('[AUTH.HTML] Starting auto-login attempt...');
    
    try {
        // First try cookie-based auth
        const response = await fetch('/api/check-auth-cookie', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });

        const data = await response.json();
        
        if (data.authenticated) {
            console.log('[AUTH.HTML] Cookie-based auto-login successful');
            if (data.auth_token) {
                await tokenManager.storeToken(data.auth_token);
            }
            window.location.replace(data.redirect_url);
            return true;
        }
        
        // If cookie auth failed, try localStorage backup
        const localToken = localStorage.getItem('auth_token');
        if (localToken) {
            console.log('[AUTH.HTML] Found token in localStorage, attempting validation');
            
            const backupResponse = await fetch('/api/check-auth-localstorage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ token: localToken })
            });
            
            const backupData = await backupResponse.json();
            
            if (backupData.success) {
                console.log('[AUTH.HTML] localStorage token validation successful');
                if (backupData.auth_token) {
                    await tokenManager.storeToken(backupData.auth_token);
                }
                window.location.replace(backupData.redirect_url);
                return true;
            }
            
            // Clear invalid localStorage token
            localStorage.removeItem('auth_token');
        }
        
        console.log('[AUTH.HTML] No valid authentication found');
        return false;
        
    } catch (error) {
        console.error('[AUTH.HTML] Auto-login error:', error);
        return false;
    }
}




// Helper function for error display
function showErrorMessage(form, message) {
    const errorDiv = document.querySelector('.alert-danger') || 
                    document.createElement('div');
    errorDiv.className = 'alert alert-danger';
    errorDiv.textContent = message;
    
    const formContainer = form.parentNode;
    const existingError = formContainer.querySelector('.alert-danger');
    if (existingError) {
        formContainer.removeChild(existingError);
    }
    formContainer.insertBefore(errorDiv, form);
}

// Add this at the end of the auth.html script section
window.handleLogout = async function() {
    try {
        // Clear localStorage first
        localStorage.clear();
        
        // Call backend logout route
        const response = await fetch('/logout');
        const data = await response.json();
        
        // Unregister all service workers
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
                await registration.unregister();
            }
        }

        // Delete all caches completely
        if ('caches' in window) {
            const cacheKeys = await caches.keys();
            await Promise.all(
                cacheKeys.map(key => caches.delete(key))
            );
        }

        window.location.href = '/login';
    } catch (error) {
        console.error('[AUTH.HTML][LOGOUT] Error during logout:', error);
        window.location.href = '/login';
    }
}


navigator.serviceWorker.addEventListener('message', async (event) => {
    if (event.data.type === 'AUTH_ERROR' && event.data.status === 401) {
        await tokenManager.clearToken();
        window.location.href = '/login';
    }
});

</script>